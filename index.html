<!DOCTYPE html>
<html lang="en" data-theme="dark" data-effect="crt" data-accent="amber">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title id="page-title">SYS//HOME</title>
<link rel="icon" type="image/svg+xml" href="favicon.svg">
<link rel="apple-touch-icon" href="favicon.svg">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link id="font-link" href="https://fonts.googleapis.com/css2?family=Share+Tech+Mono&family=Orbitron:wght@400;700;900&family=VT323&display=swap" rel="stylesheet">
<style>
:root {
  --fg: #e8e0c8;
  --bg: #080808;
  --bg2: #0f0f0f;
  --bg3: #161616;
  --accent: #c8a84b;
  --accent2: #8b6914;
  --dim: #3a3530;
  --dim2: #242220;
  --danger: #cc2222;
  --ok: #4a9944;
  --warn: #c8a84b;
  --border: #2a2820;
  --glow: rgba(200,168,75,0.15);
  --glow-strong: rgba(200,168,75,0.35);
  --font-mono: 'Share Tech Mono', 'Courier New', monospace;
  --font-display: 'Orbitron', 'Share Tech Mono', monospace;
  --font-retro: 'VT323', 'Share Tech Mono', monospace;
  --font-family: var(--font-mono);
  --effect-intensity: 0.7;
  --scanline-opacity: 0.08;
  --grain-opacity: 0.35;
  --transition: 0.15s ease;
}
[data-theme="light"] {
  --fg: #1a1a14;
  --bg: #f0ede4;
  --bg2: #e8e4d8;
  --bg3: #ddd9cc;
  --accent: #8b6914;
  --accent2: #c8a84b;
  --dim: #a09880;
  --dim2: #c8c0a8;
  --border: #ccc4a8;
  --glow: rgba(139,105,20,0.1);
  --glow-strong: rgba(139,105,20,0.25);
}
[data-accent="green"] {
  --accent: #39ff14;
  --accent2: #1a8c00;
  --glow: rgba(57,255,20,0.12);
  --glow-strong: rgba(57,255,20,0.3);
  --warn: #39ff14;
}
[data-accent="cyan"] {
  --accent: #00e5ff;
  --accent2: #0088aa;
  --glow: rgba(0,229,255,0.12);
  --glow-strong: rgba(0,229,255,0.3);
  --warn: #00e5ff;
}
[data-accent="red"] {
  --accent: #ff2222;
  --accent2: #880000;
  --glow: rgba(255,34,34,0.12);
  --glow-strong: rgba(255,34,34,0.3);
  --warn: #ff2222;
}
[data-accent="violet"] {
  --accent: #cc44ff;
  --accent2: #6600aa;
  --glow: rgba(204,68,255,0.12);
  --glow-strong: rgba(204,68,255,0.3);
  --warn: #cc44ff;
}
[data-accent="white"] {
  --accent: #ffffff;
  --accent2: #888888;
  --glow: rgba(255,255,255,0.08);
  --glow-strong: rgba(255,255,255,0.2);
  --warn: #ffffff;
}
[data-accent="orange"] {
  --accent: #ff8c00;
  --accent2: #b35a00;
  --glow: rgba(255,140,0,0.12);
  --glow-strong: rgba(255,140,0,0.3);
  --warn: #ff8c00;
}
[data-accent="yellow"] {
  --accent: #ffe600;
  --accent2: #aa9900;
  --glow: rgba(255,230,0,0.12);
  --glow-strong: rgba(255,230,0,0.3);
  --warn: #ffe600;
}

/* ===== WALLPAPER TRANSPARENCY ===== */
[data-wallpaper="true"] #header,
[data-wallpaper="true"] #stats-bar,
[data-wallpaper="true"] #search-row,
[data-wallpaper="true"] #links-panel,
[data-wallpaper="true"] #links-panel-header,
[data-wallpaper="true"] #notes-panel,
[data-wallpaper="true"] #notes-header,
[data-wallpaper="true"] #music-player,
[data-wallpaper="true"] .cat-header,
[data-wallpaper="true"] .stat-cell {
  background: transparent !important;
}
[data-wallpaper="true"] #header {
  background: linear-gradient(180deg, rgba(0,0,0,0.4) 0%, transparent 100%) !important;
}
[data-wallpaper="true"] #app {
  background: transparent;
}

/* ===== GRAIN TOGGLE ===== */
[data-grain="off"] body::before { display: none; }

*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

html, body {
  width: 100%; height: 100%; overflow: hidden;
  background: var(--bg);
  color: var(--fg);
  font-family: var(--font-family);
  font-size: 13px;
  line-height: 1.4;
}

/* ===== GRAIN LAYER ===== */
body::before {
  content: '';
  position: fixed; inset: 0;
  z-index: 9000;
  pointer-events: none;
  opacity: var(--grain-opacity);
  background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)' opacity='1'/%3E%3C/svg%3E");
  background-size: 128px 128px;
  animation: grain-shift 0.2s steps(1) infinite;
}
@keyframes grain-shift {
  0%,100%{transform:translate(0,0)} 10%{transform:translate(-2%,-2%)} 20%{transform:translate(2%,2%)}
  30%{transform:translate(-2%,2%)} 40%{transform:translate(2%,-2%)} 50%{transform:translate(-1%,1%)}
  60%{transform:translate(1%,-1%)} 70%{transform:translate(-1%,-1%)} 80%{transform:translate(1%,1%)}
  90%{transform:translate(-2%,0)}
}

/* ===== SCANLINES ===== */
body::after {
  content: '';
  position: fixed; inset: 0;
  z-index: 9001;
  pointer-events: none;
  background: repeating-linear-gradient(
    0deg,
    transparent, transparent 2px,
    rgba(0,0,0,var(--scanline-opacity)) 2px, rgba(0,0,0,var(--scanline-opacity)) 4px
  );
}

/* ===== CRT VIGNETTE ===== */
[data-effect="crt"] #screen-overlay {
  display: block;
  box-shadow: inset 0 0 80px rgba(0,0,0,0.6), inset 0 0 20px rgba(0,0,0,0.4);
  border-radius: 4px;
}
[data-effect="arcade"] #screen-overlay {
  display: block;
  box-shadow: inset 0 0 150px rgba(0,0,0,0.8), inset 0 0 40px rgba(0,0,0,0.6);
}
[data-effect="phosphor"] #screen-overlay {
  display: block;
  animation: phosphor-pulse 2s ease-in-out infinite;
}
[data-effect="phosphor"] { filter: saturate(0) sepia(1) hue-rotate(60deg) brightness(0.9); }
@keyframes phosphor-pulse {
  0%,100%{opacity:1} 50%{opacity:0.92}
}
[data-effect="vhs"] body::before {
  animation: grain-shift 0.08s steps(1) infinite;
}
[data-effect="vhs"] #screen-overlay {
  display: block;
  animation: vhs-roll 8s linear infinite;
}
@keyframes vhs-roll {
  0%{clip-path:inset(0 0 100% 0)} 5%,95%{clip-path:none} 100%{clip-path:inset(0 0 100% 0)}
}
[data-effect="gameboy"] {
  filter: sepia(0.4) hue-rotate(60deg) saturate(0.6) brightness(0.85);
}
[data-effect="none"] #screen-overlay { display: none; }

#screen-overlay {
  display: none;
  position: fixed; inset: 0;
  z-index: 9002;
  pointer-events: none;
}

/* ===== BACKGROUND ===== */
#bg-layer {
  position: fixed; inset: 0;
  z-index: 0;
  background-size: cover;
  background-position: center;
  background-repeat: no-repeat;
  transition: opacity 0.5s;
}
#bg-dim { position: fixed; inset: 0; z-index: 1; background: var(--bg); pointer-events: none; transition: opacity 0.3s; }

/* ===== LAYOUT ===== */
#app {
  position: fixed; inset: 0;
  z-index: 10;
  display: flex;
  flex-direction: column;
  padding: 0;
  overflow: hidden;
}

/* ===== HEADER BAR ===== */
#header {
  flex-shrink: 0;
  display: grid;
  grid-template-columns: 1fr auto 1fr;
  align-items: center;
  padding: 6px 12px 5px;
  border-bottom: 1px solid var(--border);
  background: linear-gradient(180deg, var(--bg2) 0%, transparent 100%);
  position: relative;
  z-index: 100;
}
#header::after {
  content: '';
  position: absolute;
  bottom: 0; left: 0; right: 0;
  height: 1px;
  background: linear-gradient(90deg, transparent, var(--accent), transparent);
  opacity: 0.4;
}
#sys-label {
  font-family: var(--font-display);
  font-size: 10px;
  font-weight: 700;
  letter-spacing: 0.25em;
  color: var(--accent);
  text-transform: uppercase;
  text-shadow: 0 0 8px var(--glow-strong);
  justify-self: start;
}
#sys-title {
  font-family: var(--font-display);
  font-size: 13px;
  font-weight: 900;
  letter-spacing: 0.15em;
  color: var(--fg);
  text-align: center;
  cursor: pointer;
}
#sys-title:hover { color: var(--accent); }
#header-right {
  justify-self: end;
  display: flex;
  align-items: center;
  gap: 8px;
}
.hdr-btn {
  background: none; border: 1px solid var(--dim);
  color: var(--dim); padding: 2px 6px;
  font-family: var(--font-mono); font-size: 10px;
  cursor: pointer; letter-spacing: 0.1em;
  transition: var(--transition);
}
.hdr-btn:hover { border-color: var(--accent); color: var(--accent); background: var(--glow); }
#status-led {
  width: 6px; height: 6px; border-radius: 50%;
  background: var(--ok); box-shadow: 0 0 6px var(--ok);
  animation: led-blink 3s ease-in-out infinite;
}
@keyframes led-blink { 0%,100%{opacity:1} 50%{opacity:0.5} }

/* ===== STATS BAR ===== */
#stats-bar {
  flex-shrink: 0;
  display: flex;
  align-items: stretch;
  border-bottom: 1px solid var(--border);
  background: var(--bg2);
  overflow-x: auto;
  scrollbar-width: none;
}
#stats-bar::-webkit-scrollbar { display: none; }
.stat-cell {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  padding: 5px 14px;
  border-right: 1px solid var(--border);
  min-width: 70px;
  flex-shrink: 0;
  position: relative;
  cursor: default;
}
.stat-cell:last-child { border-right: none; }
.stat-cell:hover { background: var(--glow); }
.stat-label {
  font-size: 8px; letter-spacing: 0.2em;
  color: var(--dim); text-transform: uppercase;
  font-family: var(--font-mono);
}
.stat-val {
  font-size: 13px; color: var(--accent);
  font-family: var(--font-mono);
  letter-spacing: 0.05em;
  text-shadow: 0 0 6px var(--glow-strong);
}
.stat-val.ok { color: var(--ok); text-shadow: 0 0 6px rgba(74,153,68,0.4); }
.stat-val.warn { color: #c8a84b !important; }
.stat-val.danger { color: var(--danger); text-shadow: 0 0 6px rgba(204,34,34,0.4); }
.stat-refresh {
  position: absolute; top: 2px; right: 3px;
  font-size: 8px; color: var(--dim); cursor: pointer;
  opacity: 0; transition: opacity 0.1s;
  background: none; border: none; padding: 2px;
  font-family: var(--font-mono);
}
.stat-cell:hover .stat-refresh { opacity: 1; }
.stat-refresh:hover { color: var(--accent); }
.stat-refresh.spin { animation: spin-once 0.4s ease; }
@keyframes spin-once { from{transform:rotate(0)} to{transform:rotate(360deg)} }
#stat-battery-icon { font-size: 10px; }

/* ===== SEARCH BAR ===== */
#search-row {
  flex-shrink: 0;
  display: flex;
  align-items: center;
  padding: 6px 12px;
  gap: 6px;
  border-bottom: 1px solid var(--border);
  background: var(--bg2);
}
#search-engine-btn {
  min-width: 48px; height: 28px; padding: 0 6px;
  background: var(--bg3); border: 1px solid var(--dim);
  cursor: pointer; display: flex; align-items: center; justify-content: center;
  font-family: var(--font-mono); font-size: 10px; letter-spacing: 0.1em;
  color: var(--accent); flex-shrink: 0;
  transition: var(--transition);
}
#search-engine-btn:hover { border-color: var(--accent); background: var(--glow); }
#search-engine-menu {
  display: none;
  position: absolute;
  top: calc(100% + 4px);
  left: 0;
  background: var(--bg2);
  border: 1px solid var(--accent);
  box-shadow: 0 4px 20px rgba(0,0,0,0.8), 0 0 20px var(--glow);
  z-index: 1000;
  min-width: 160px;
}
#search-engine-menu.open { display: block; }
.eng-opt {
  display: block;
  padding: 7px 12px; cursor: pointer;
  font-family: var(--font-mono); font-size: 11px;
  color: var(--fg); letter-spacing: 0.05em;
  transition: var(--transition);
}
.eng-opt:hover { background: var(--glow); color: var(--accent); }
.eng-opt.active { color: var(--accent); }
#search-wrapper { flex: 1; position: relative; }
#search-input {
  width: 100%;
  background: var(--bg3);
  border: 1px solid var(--dim);
  border-left: 2px solid var(--accent);
  color: var(--fg);
  font-family: var(--font-mono); font-size: 13px;
  padding: 4px 8px; height: 28px;
  outline: none; transition: var(--transition);
  letter-spacing: 0.03em;
}
#search-input:focus { border-color: var(--accent); box-shadow: 0 0 8px var(--glow); background: var(--bg2); }
#search-input::placeholder { color: var(--dim); }
#search-submit {
  height: 28px; padding: 0 12px;
  background: var(--accent2); border: 1px solid var(--accent);
  color: var(--fg); font-family: var(--font-mono); font-size: 11px;
  letter-spacing: 0.15em; cursor: pointer;
  transition: var(--transition); flex-shrink: 0;
  text-transform: uppercase;
}
#search-submit:hover { background: var(--accent); color: var(--bg); }

/* ===== MAIN AREA ===== */
#main {
  flex: 1;
  display: flex;
  overflow: hidden;
  gap: 0;
}

/* ===== LINKS PANEL ===== */
#links-panel {
  flex: 0 0 220px;
  border-right: 1px solid var(--border);
  display: flex;
  flex-direction: column;
  overflow: hidden;
  background: var(--bg);
}
#links-panel-header {
  display: flex; align-items: center; justify-content: space-between;
  padding: 5px 10px;
  border-bottom: 1px solid var(--border);
  background: var(--bg2);
  flex-shrink: 0;
}
.panel-title {
  font-family: var(--font-display); font-size: 9px;
  letter-spacing: 0.2em; color: var(--accent);
  text-transform: uppercase;
}
#links-scroll { flex: 1; overflow-y: auto; padding: 4px 0; scrollbar-width: thin; scrollbar-color: var(--dim) transparent; }
#links-scroll::-webkit-scrollbar { width: 4px; }
#links-scroll::-webkit-scrollbar-track { background: transparent; }
#links-scroll::-webkit-scrollbar-thumb { background: var(--dim); }

.link-category { margin-bottom: 2px; }
.cat-header {
  display: flex; align-items: center; gap: 6px;
  padding: 4px 10px; cursor: pointer;
  font-family: var(--font-mono); font-size: 10px;
  letter-spacing: 0.15em; color: var(--dim);
  text-transform: uppercase;
  transition: var(--transition);
  user-select: none;
  border-left: 2px solid transparent;
}
.cat-header:hover { color: var(--accent); border-left-color: var(--accent); background: var(--glow); }
.cat-header.active { color: var(--accent); border-left-color: var(--accent); }
.cat-arrow { font-size: 8px; transition: transform 0.2s; margin-left: auto; }
.cat-arrow.open { transform: rotate(90deg); }
.cat-links { display: none; padding: 2px 0; }
.cat-links.open { display: block; }
.link-item {
  display: flex; align-items: center; gap: 6px;
  padding: 3px 10px 3px 20px;
  cursor: pointer; text-decoration: none;
  color: var(--fg); font-family: var(--font-mono); font-size: 12px;
  transition: var(--transition);
  border-left: 2px solid transparent;
  position: relative;
}
.link-item::before {
  content: '>';
  position: absolute; left: 10px;
  color: var(--dim); font-size: 10px;
  transition: var(--transition);
}
.link-item:hover { color: var(--accent); background: var(--glow); border-left-color: var(--accent); padding-left: 22px; }
.link-item:hover::before { color: var(--accent); }
.link-del { display: none; margin-left: auto; font-size: 9px; color: var(--danger); padding: 1px 3px; }
.link-item:hover .link-del { display: block; }
.link-del:hover { background: var(--danger); color: var(--bg); }
#add-link-btn, #add-cat-btn {
  margin: 4px 10px;
  background: none; border: 1px dashed var(--dim);
  color: var(--dim); padding: 3px 8px;
  font-family: var(--font-mono); font-size: 10px;
  cursor: pointer; letter-spacing: 0.1em;
  transition: var(--transition); width: calc(100% - 20px);
}
#add-link-btn:hover, #add-cat-btn:hover { border-color: var(--accent); color: var(--accent); background: var(--glow); }

/* ===== CENTER PANEL ===== */
#center-panel {
  flex: 1;
  display: flex;
  flex-direction: column;
  overflow: hidden;
}

/* ===== NOTES PANEL ===== */
#notes-panel {
  flex: 0 0 200px;
  border-left: 1px solid var(--border);
  display: flex;
  flex-direction: column;
  background: var(--bg);
}
#notes-header {
  display: flex; align-items: center; justify-content: space-between;
  padding: 5px 10px;
  border-bottom: 1px solid var(--border);
  background: var(--bg2);
  flex-shrink: 0;
}
.rec-dot {
  width: 6px; height: 6px; border-radius: 50%;
  background: var(--danger); box-shadow: 0 0 6px var(--danger);
  animation: rec-blink 1s steps(1) infinite;
  -webkit-animation: rec-blink 1s steps(1) infinite;
  flex-shrink: 0;
  -webkit-transform: translateZ(0);
  transform: translateZ(0);
}
@keyframes rec-blink { 0%,49%{opacity:1} 50%,100%{opacity:0} }
@-webkit-keyframes rec-blink { 0%,49%{opacity:1} 50%,100%{opacity:0} }
.rec-label {
  font-family: var(--font-display); font-size: 9px;
  letter-spacing: 0.2em; color: var(--danger);
  text-transform: uppercase;
}
#notes-textarea {
  flex: 1; resize: none;
  background: transparent; border: none;
  color: var(--fg); font-family: var(--font-mono); font-size: 12px;
  padding: 8px; outline: none; line-height: 1.6;
  scrollbar-width: thin; scrollbar-color: var(--dim) transparent;
}
#notes-textarea::-webkit-scrollbar { width: 3px; }
#notes-textarea::-webkit-scrollbar-thumb { background: var(--dim); }
#notes-count { padding: 3px 10px; font-size: 9px; color: var(--dim); border-top: 1px solid var(--border); letter-spacing: 0.1em; }

/* ===== MUSIC PLAYER ===== */
#music-player {
  display: flex; align-items: center; gap: 6px;
  padding: 4px 10px;
  border-top: 1px solid var(--border);
  background: var(--bg2);
  flex-shrink: 0;
}
.music-btn {
  background: none; border: 1px solid var(--dim);
  color: var(--dim); width: 22px; height: 22px;
  font-size: 10px; cursor: pointer; flex-shrink: 0;
  display: flex; align-items: center; justify-content: center;
  transition: var(--transition);
}
.music-btn:hover, .music-btn.active { border-color: var(--accent); color: var(--accent); background: var(--glow); }
#music-title {
  flex: 1; font-family: var(--font-mono); font-size: 10px;
  color: var(--dim); letter-spacing: 0.05em;
  overflow: hidden; text-overflow: ellipsis; white-space: nowrap;
}
#music-title.playing { color: var(--accent); animation: marquee-scroll 15s linear infinite; }
@keyframes marquee-scroll { 0%{text-indent:0} 50%{text-indent:-100px} 100%{text-indent:0} }
#music-vol { width: 60px; accent-color: var(--accent); flex-shrink: 0; }
#music-progress-bar {
  width: 100%; height: 2px;
  background: var(--dim2); border-top: 1px solid var(--border);
  cursor: pointer; flex-shrink: 0;
}
#music-progress-fill { height: 100%; background: var(--accent); width: 0%; transition: width 0.5s linear; }

/* ===== ALBUM ART ===== */
#music-art {
  width: 36px; height: 36px; flex-shrink: 0;
  border: 1px solid var(--dim); object-fit: cover;
  display: none; cursor: pointer;
  transition: var(--transition);
}
#music-art.visible { display: block; }
#music-art:hover { border-color: var(--accent); box-shadow: 0 0 8px var(--glow); }

/* ===== PLAYLIST PANEL ===== */
#music-playlist {
  display: none; position: absolute;
  bottom: calc(100% + 2px); right: 0; left: 0;
  background: var(--bg2); border: 1px solid var(--accent);
  box-shadow: 0 -4px 20px rgba(0,0,0,0.8);
  max-height: 200px; overflow-y: auto;
  z-index: 200; scrollbar-width: thin; scrollbar-color: var(--dim) transparent;
}
#music-playlist.open { display: block; }
#music-playlist::-webkit-scrollbar { width: 3px; }
#music-playlist::-webkit-scrollbar-thumb { background: var(--dim); }
#playlist-header {
  display: flex; align-items: center; justify-content: space-between;
  padding: 4px 8px; border-bottom: 1px solid var(--border);
  background: var(--bg3); flex-shrink: 0;
}
#playlist-header span {
  font-family: var(--font-display); font-size: 8px;
  letter-spacing: 0.2em; color: var(--accent);
}
#playlist-format-select {
  background: var(--bg3); border: 1px solid var(--dim);
  color: var(--accent); font-family: var(--font-mono); font-size: 9px;
  padding: 1px 4px; cursor: pointer; max-width: 80px;
}
#playlist-format-select:focus { border-color: var(--accent); outline: none; }
.playlist-track {
  display: flex; align-items: center; gap: 6px;
  padding: 4px 8px; cursor: pointer;
  font-family: var(--font-mono); font-size: 10px; color: var(--dim);
  transition: var(--transition); border-bottom: 1px solid var(--border);
  white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
}
.playlist-track:hover { background: var(--glow); color: var(--fg); }
.playlist-track.active { color: var(--accent); background: var(--glow); }
.playlist-track-num { color: var(--dim); font-size: 9px; min-width: 20px; }
.playlist-track-del {
  margin-left: auto; font-size: 9px; color: var(--dim);
  flex-shrink: 0; padding: 1px 4px; display: none;
}
.playlist-track:hover .playlist-track-del { display: block; }
.playlist-track-del:hover { color: var(--danger); }

.playlist-loading {
  display: flex;
  align-items: center;
  justify-content: center;
  height: 100%;
}

.playlist-spinner {
  display: inline-block;
  width: 16px;
  height: 16px;
  border: 2px solid var(--dim);
  border-top-color: var(--accent);
  border-radius: 50%;
  animation: playlist-spin 0.8s linear infinite;
}

@keyframes playlist-spin {
  to { transform: rotate(360deg); }
}

/* ===== MUSIC PLAYER EXTENDED ===== */
#music-player { position: relative; }
#music-load-btn {
  background: none; border: 1px solid var(--dim); color: var(--dim);
  font-family: var(--font-mono); font-size: 9px; letter-spacing: 0.1em;
  padding: 2px 5px; cursor: pointer; flex-shrink: 0;
  transition: var(--transition); white-space: nowrap;
}
#music-load-btn:hover { border-color: var(--accent); color: var(--accent); background: var(--glow); }

/* ===== WEATHER WIDGET ===== */
#weather-cell {
  display: flex; flex-direction: column; align-items: center;
  padding: 5px 14px; min-width: 90px;
  border-right: 1px solid var(--border);
  flex-shrink: 0; cursor: default;
}
#weather-cell:hover { background: var(--glow); }
.weather-icon { font-size: 16px; line-height: 1; }
.weather-temp { font-size: 13px; color: var(--accent); font-family: var(--font-mono); }
.weather-desc { font-size: 8px; color: var(--dim); letter-spacing: 0.1em; text-transform: uppercase; }

/* ===== SETTINGS MODAL ===== */
#settings-modal {
  display: none;
  position: fixed; inset: 0;
  z-index: 10000;
  background: rgba(0,0,0,0.85);
  align-items: center; justify-content: center;
}
#settings-modal.open { display: flex; }
#settings-box {
  background: var(--bg2);
  border: 1px solid var(--accent);
  box-shadow: 0 0 40px var(--glow-strong), 0 0 80px rgba(0,0,0,0.9);
  width: 480px; max-width: 95vw; max-height: 88vh;
  display: flex; flex-direction: column;
  position: relative;
  animation: modal-open 0.2s ease;
}
@keyframes modal-open { from{transform:scale(0.95);opacity:0} to{transform:scale(1);opacity:1} }
#settings-box::before {
  content: '';
  position: absolute; top: 0; left: 0; right: 0; height: 2px;
  background: linear-gradient(90deg, transparent, var(--accent), transparent);
}
#settings-title-bar {
  display: flex; align-items: center; justify-content: space-between;
  padding: 10px 14px 8px;
  border-bottom: 1px solid var(--border);
  flex-shrink: 0;
}
#settings-title {
  font-family: var(--font-display); font-size: 11px;
  letter-spacing: 0.2em; color: var(--accent);
  text-transform: uppercase;
}
#settings-close {
  background: none; border: 1px solid var(--dim);
  color: var(--dim); width: 22px; height: 22px;
  font-size: 12px; cursor: pointer; line-height: 1;
  transition: var(--transition);
}
#settings-close:hover { border-color: var(--danger); color: var(--danger); }
#settings-tabs {
  display: flex; overflow-x: auto; border-bottom: 1px solid var(--border);
  flex-shrink: 0; scrollbar-width: none; background: var(--bg);
}
#settings-tabs::-webkit-scrollbar { display: none; }
.stab {
  padding: 6px 12px; cursor: pointer;
  font-family: var(--font-mono); font-size: 10px;
  letter-spacing: 0.12em; text-transform: uppercase;
  color: var(--dim); white-space: nowrap;
  border-bottom: 2px solid transparent;
  transition: var(--transition); flex-shrink: 0;
}
.stab:hover { color: var(--fg); }
.stab.active { color: var(--accent); border-bottom-color: var(--accent); background: var(--glow); }
#settings-body { flex: 1; overflow-y: auto; padding: 16px; scrollbar-width: thin; scrollbar-color: var(--dim) transparent; }
#settings-body::-webkit-scrollbar { width: 4px; }
#settings-body::-webkit-scrollbar-thumb { background: var(--dim); }
.tab-pane { display: none; }
.tab-pane.active { display: block; }
.sform-row {
  display: flex; align-items: center; justify-content: space-between;
  margin-bottom: 10px; gap: 8px;
}
.sform-label {
  font-family: var(--font-mono); font-size: 11px;
  color: var(--fg); letter-spacing: 0.08em;
  flex: 1;
}
.sform-sublabel {
  font-family: var(--font-mono); font-size: 9px;
  color: var(--dim); letter-spacing: 0.1em;
}
.sform-sep {
  border: none; border-top: 1px solid var(--border);
  margin: 10px 0;
}
.sform-section-title {
  font-family: var(--font-display); font-size: 9px;
  letter-spacing: 0.2em; color: var(--accent);
  text-transform: uppercase; margin-bottom: 8px; margin-top: 14px;
}
.sform-section-title:first-child { margin-top: 0; }
select, input[type="text"], input[type="url"], input[type="number"], input[type="password"] {
  background: var(--bg3); border: 1px solid var(--dim);
  color: var(--fg); font-family: var(--font-mono); font-size: 11px;
  padding: 4px 6px; outline: none; transition: var(--transition);
}
select:focus, input[type="text"]:focus, input[type="url"]:focus,
input[type="number"]:focus, input[type="password"]:focus {
  border-color: var(--accent); box-shadow: 0 0 6px var(--glow);
}
input[type="color"] { width: 32px; height: 24px; border: 1px solid var(--dim); background: none; cursor: pointer; padding: 1px; }
input[type="range"] { accent-color: var(--accent); }
input[type="checkbox"] {
  appearance: none;
  -webkit-appearance: none;
  -moz-appearance: none;
  width: 18px;
  height: 18px;
  border: 2px solid var(--accent);
  border-radius: 2px;
  background: var(--bg2);
  cursor: pointer;
  display: inline-block;
  vertical-align: -2px;
  transition: 0.1s ease;
  position: relative;
  flex-shrink: 0;
}
input[type="checkbox"]:checked {
  background: var(--accent);
  box-shadow: inset 0 0 4px rgba(0,0,0,0.5);
}
input[type="checkbox"]:checked::after {
  content: '‚úì';
  position: absolute;
  top: -2px;
  left: 2px;
  color: var(--bg);
  font-weight: bold;
  font-size: 14px;
  line-height: 1;
}
input[type="checkbox"]:active {
  box-shadow: 0 0 8px var(--glow-strong);
}
#settings-footer {
  display: flex; align-items: center; justify-content: space-between;
  padding: 8px 14px;
  border-top: 1px solid var(--border);
  background: var(--bg);
  flex-shrink: 0;
}
.settings-note { font-family: var(--font-mono); font-size: 9px; color: var(--dim); letter-spacing: 0.08em; }
.btn {
  padding: 5px 14px;
  font-family: var(--font-mono); font-size: 11px;
  letter-spacing: 0.12em; cursor: pointer;
  transition: var(--transition); border: 1px solid;
  text-transform: uppercase;
}
.btn-primary { background: var(--accent2); border-color: var(--accent); color: var(--fg); }
.btn-primary:hover { background: var(--accent); color: var(--bg); box-shadow: 0 0 10px var(--glow-strong); }
.btn-ghost { background: none; border-color: var(--dim); color: var(--dim); }
.btn-ghost:hover { border-color: var(--fg); color: var(--fg); }
.btn-danger { background: none; border-color: var(--danger); color: var(--danger); }
.btn-danger:hover { background: var(--danger); color: var(--bg); }

/* ===== ACCENT PRESET SWATCHES ===== */
.accent-swatches { display: flex; gap: 6px; flex-wrap: wrap; }
.accent-swatch {
  width: 22px; height: 22px; cursor: pointer;
  border: 2px solid transparent; transition: var(--transition);
}
.accent-swatch.active, .accent-swatch:hover { border-color: var(--fg); }
.swatch-amber { background: #c8a84b; }
.swatch-green { background: #39ff14; }
.swatch-cyan { background: #00e5ff; }
.swatch-red { background: #ff2222; }
.swatch-violet { background: #cc44ff; }
.swatch-white { background: #ffffff; border: 2px solid #888; }
.swatch-orange { background: #ff8c00; }
.swatch-yellow { background: #ffe600; }

/* ===== ADD LINK/CATEGORY DIALOG ===== */
#dialog-overlay {
  display: none; position: fixed; inset: 0;
  z-index: 10001; background: rgba(0,0,0,0.8);
  align-items: center; justify-content: center;
}
#dialog-overlay.open { display: flex; }
#dialog-box {
  background: var(--bg2); border: 1px solid var(--accent);
  box-shadow: 0 0 30px var(--glow-strong);
  padding: 20px; width: 320px; max-width: 90vw;
  animation: modal-open 0.15s ease;
}
#dialog-title { font-family: var(--font-display); font-size: 10px; letter-spacing: 0.2em; color: var(--accent); text-transform: uppercase; margin-bottom: 14px; }
.dialog-field { margin-bottom: 10px; }
.dialog-field label { display: block; font-family: var(--font-mono); font-size: 10px; color: var(--dim); letter-spacing: 0.1em; margin-bottom: 3px; }
.dialog-field input, .dialog-field select { width: 100%; }
.dialog-btns { display: flex; gap: 8px; justify-content: flex-end; margin-top: 14px; }

/* ===== NUCLEAR ERASE MODAL ===== */
#nuke-modal {
  display: none; position: fixed; inset: 0;
  z-index: 10005; background: rgba(0,0,0,0.96);
  align-items: center; justify-content: center;
  flex-direction: column;
}
#nuke-modal.open { display: flex; animation: nuke-in 0.3s ease; }
@keyframes nuke-in { from{opacity:0} to{opacity:1} }
#nuke-box {
  background: #0a0000; border: 2px solid #cc0000;
  box-shadow: 0 0 60px rgba(200,0,0,0.5), 0 0 120px rgba(200,0,0,0.2);
  padding: 30px; max-width: 440px; width: 90vw;
  text-align: center; position: relative;
  animation: glitch-container 0.5s infinite;
}
@keyframes glitch-container {
  0%,98%{transform:translate(0)} 99%{transform:translate(-2px,1px)} 100%{transform:translate(1px,-1px)}
}
#nuke-banner {
  background: #cc0000; color: #fff;
  font-family: var(--font-display); font-size: 11px;
  letter-spacing: 0.2em; padding: 6px;
  margin-bottom: 16px; animation: nuke-flash 0.5s steps(1) infinite;
}
@keyframes nuke-flash { 0%,49%{opacity:1;background:#cc0000} 50%,100%{opacity:0.7;background:#880000} }
#nuke-icon { font-size: 48px; margin-bottom: 12px; animation: nuke-spin 2s linear infinite; }
@keyframes nuke-spin { from{transform:rotate(0)} to{transform:rotate(360deg)} }
#nuke-title {
  font-family: var(--font-display); font-size: 16px; font-weight: 900;
  color: #ff4444; letter-spacing: 0.1em; margin-bottom: 12px;
  text-shadow: 0 0 20px rgba(255,68,68,0.8);
}
#nuke-desc {
  font-family: var(--font-mono); font-size: 11px; color: #cc8888;
  margin-bottom: 20px; line-height: 1.8; letter-spacing: 0.05em;
}
#nuke-confirm-wrap { margin-bottom: 16px; }
#nuke-confirm-wrap label { font-family: var(--font-mono); font-size: 10px; color: #888; letter-spacing: 0.1em; display: block; margin-bottom: 4px; }
#nuke-confirm-input {
  background: #0d0000; border: 1px solid #660000; color: #ff4444;
  font-family: var(--font-mono); font-size: 14px; letter-spacing: 0.2em;
  padding: 6px 10px; text-align: center; width: 100%;
  text-transform: uppercase;
}
#nuke-confirm-input:focus { border-color: #cc0000; outline: none; box-shadow: 0 0 10px rgba(200,0,0,0.4); }
#nuke-btns { display: flex; gap: 10px; justify-content: center; }
#nuke-go {
  background: #440000; border: 1px solid #cc0000; color: #ff4444;
  font-family: var(--font-display); font-size: 11px; letter-spacing: 0.15em;
  padding: 6px 20px; cursor: pointer; transition: var(--transition);
}
#nuke-go:hover { background: #cc0000; color: #fff; }
#nuke-go:disabled { opacity: 0.4; cursor: not-allowed; }
#nuke-cancel {
  background: none; border: 1px solid #444; color: #666;
  font-family: var(--font-mono); font-size: 11px; letter-spacing: 0.1em;
  padding: 6px 20px; cursor: pointer; transition: var(--transition);
}
#nuke-cancel:hover { border-color: #888; color: #aaa; }
#nuke-siren-audio { display: none; }

/* ===== NUKE PRESET THEMES ===== */
#nuke-modal.preset-bsod {
  background: #0033bb;
  align-items: flex-start;
  padding: 40px 48px;
}
#nuke-modal.preset-bsod #nuke-box {
  background: transparent; border: none; box-shadow: none;
  animation: none; text-align: left; max-width: 100%; width: 100%; padding: 0;
}
#nuke-modal.preset-bsod #nuke-banner { display: none; }
#nuke-modal.preset-bsod #nuke-icon { display: none; }
#nuke-modal.preset-bsod #nuke-title {
  font-family: 'Segoe UI', 'Arial', sans-serif; font-size: 28px; font-weight: 400;
  color: #fff; text-shadow: none; letter-spacing: 0; margin-bottom: 24px;
}
#nuke-modal.preset-bsod #nuke-desc {
  font-family: 'Segoe UI', 'Arial', sans-serif; font-size: 14px;
  color: #fff; letter-spacing: 0; line-height: 1.6;
}
#nuke-modal.preset-bsod #nuke-confirm-wrap label { color: #ccd; font-family: 'Segoe UI','Arial',sans-serif; font-size: 13px; }
#nuke-modal.preset-bsod #nuke-confirm-input {
  background: #0044cc; border: 2px solid #fff; color: #fff;
  font-family: 'Segoe UI','Arial',sans-serif; font-size: 13px; letter-spacing: 0;
}
#nuke-modal.preset-bsod #nuke-go {
  background: #fff; border: none; color: #0033bb;
  font-family: 'Segoe UI','Arial',sans-serif; font-size: 13px; letter-spacing: 0;
}
#nuke-modal.preset-bsod #nuke-go:hover { background: #dde; }
#nuke-modal.preset-bsod #nuke-cancel {
  border: 1px solid #88a; color: #ccd;
  font-family: 'Segoe UI','Arial',sans-serif; font-size: 13px; letter-spacing: 0;
}
#nuke-modal.preset-bsod #nuke-btns { justify-content: flex-start; margin-top: 30px; }
#nuke-modal.preset-bsod #glitch-container { animation: none; }

#nuke-modal.preset-creepypasta {
  background: #000;
}
#nuke-modal.preset-creepypasta #nuke-box {
  background: #000; border: 1px solid #111;
  box-shadow: none; animation: creepy-flicker 4s steps(1) infinite;
}
@keyframes creepy-flicker {
  0%,89%,91%,94%,100%{opacity:1;filter:none}
  90%{opacity:0.1;filter:invert(1)}
  92%{opacity:0.7;filter:brightness(0.3)}
  93%{opacity:1;filter:hue-rotate(180deg)}
}
#nuke-modal.preset-creepypasta #nuke-banner { background: #000; color: #333; border: 1px solid #1a1a1a; animation: none; font-size: 9px; letter-spacing: 0.05em; }
#nuke-modal.preset-creepypasta #nuke-icon { animation: none; filter: grayscale(1) brightness(0.4); }
#nuke-modal.preset-creepypasta #nuke-title { font-family: var(--font-mono); font-size: 13px; color: #553333; text-shadow: none; letter-spacing: 0.05em; }
#nuke-modal.preset-creepypasta #nuke-desc { color: #442222; font-size: 10px; }
#nuke-modal.preset-creepypasta #nuke-confirm-input { background: #000; border: 1px solid #1a0a0a; color: #553333; }
#nuke-modal.preset-creepypasta #nuke-go { background: #000; border: 1px solid #221111; color: #553333; }
#nuke-modal.preset-creepypasta #nuke-go:hover { background: #110000; }
#nuke-modal.preset-creepypasta #nuke-cancel { border-color: #1a1a1a; color: #222; }

#nuke-modal.preset-arg {
  background: #000508;
}
#nuke-modal.preset-arg #nuke-box {
  background: #000a04; border: 1px solid #004400;
  box-shadow: 0 0 40px rgba(0,100,0,0.3); animation: none;
}
#nuke-modal.preset-arg #nuke-banner { background: #002200; color: #00aa44; border: none; animation: arg-scan 2s linear infinite; font-size: 9px; letter-spacing: 0.3em; }
@keyframes arg-scan { 0%{background:#002200} 50%{background:#003300} 100%{background:#002200} }
#nuke-modal.preset-arg #nuke-icon { display: none; }
#nuke-modal.preset-arg #nuke-title { color: #00cc44; text-shadow: 0 0 10px rgba(0,200,68,0.6); font-size: 12px; letter-spacing: 0.3em; }
#nuke-modal.preset-arg #nuke-desc { color: #007722; font-size: 10px; letter-spacing: 0.08em; }
#nuke-modal.preset-arg #nuke-confirm-wrap label { color: #005522; }
#nuke-modal.preset-arg #nuke-confirm-input { background: #000a04; border: 1px solid #005522; color: #00cc44; letter-spacing: 0.3em; }
#nuke-modal.preset-arg #nuke-go { background: #002200; border: 1px solid #006622; color: #00cc44; }
#nuke-modal.preset-arg #nuke-go:hover { background: #00aa44; color: #000; }
#nuke-modal.preset-arg #nuke-cancel { border-color: #002200; color: #004422; }

#nuke-modal.preset-loop #nuke-box {
  animation: loop-spaz 0.3s steps(1) infinite;
}
@keyframes loop-spaz {
  0%{transform:translate(0);filter:none;border-color:#cc0000}
  20%{transform:translate(-4px,2px);filter:hue-rotate(90deg);border-color:#ff00ff}
  40%{transform:translate(3px,-3px);filter:invert(0.1);border-color:#0000ff}
  60%{transform:translate(-2px,4px);filter:hue-rotate(180deg);border-color:#00ffff}
  80%{transform:translate(4px,-1px);filter:saturate(3);border-color:#ffff00}
}
#nuke-modal.preset-loop #nuke-title { animation: loop-text-spaz 0.2s steps(1) infinite; }
@keyframes loop-text-spaz {
  0%{color:#ff4444} 33%{color:#ff00ff} 66%{color:#ffff00} 100%{color:#00ffff}
}
#nuke-modal.preset-loop #nuke-desc { animation: loop-text-spaz 0.4s steps(1) infinite reverse; }

/* ===== DEBUG PANEL ===== */
#debug-panel {
  display: none; position: fixed; inset: 0;
  z-index: 10003;
  background: rgba(0,0,0,0.95);
  overflow: hidden;
}
#debug-panel.open { display: flex; flex-direction: column; animation: debug-in 0.3s ease; }
@keyframes debug-in { from{opacity:0;transform:translateY(-10px)} to{opacity:1;transform:translateY(0)} }
#debug-header {
  display: flex; align-items: center; justify-content: space-between;
  padding: 8px 14px;
  background: #100000; border-bottom: 2px solid #8b0000;
  flex-shrink: 0;
}
#debug-banner {
  font-family: var(--font-display); font-size: 10px; letter-spacing: 0.15em;
  color: #ff4444; text-transform: uppercase;
  animation: glitch-text 3s infinite;
}
@keyframes glitch-text {
  0%,90%{transform:translate(0);opacity:1}
  92%{transform:translate(-2px,0);opacity:0.8}
  94%{transform:translate(2px,0);opacity:1}
  96%{transform:translate(-1px,1px);opacity:0.9}
  98%{transform:translate(0);opacity:1}
  99%{transform:translate(1px,-1px)}
  100%{transform:translate(0)}
}
#debug-close {
  background: none; border: 1px solid #8b0000;
  color: #8b0000; padding: 3px 10px; cursor: pointer;
  font-family: var(--font-mono); font-size: 11px;
  transition: var(--transition);
}
#debug-close:hover { background: #8b0000; color: #fff; }
#debug-warn-bar {
  background: #1a0000; padding: 5px 14px;
  font-family: var(--font-mono); font-size: 10px; color: #cc4444;
  letter-spacing: 0.08em; border-bottom: 1px solid #4a0000;
  flex-shrink: 0;
}
#debug-tabs {
  display: flex; border-bottom: 1px solid #2a0000;
  background: #0a0000; overflow-x: auto; flex-shrink: 0;
  scrollbar-width: none;
}
#debug-tabs::-webkit-scrollbar { display: none; }
.dtab {
  padding: 6px 14px; cursor: pointer;
  font-family: var(--font-mono); font-size: 10px;
  letter-spacing: 0.12em; color: #664444; white-space: nowrap;
  border-bottom: 2px solid transparent; transition: var(--transition);
  flex-shrink: 0; text-transform: uppercase;
}
.dtab:hover { color: #cc4444; }
.dtab.active { color: #ff4444; border-bottom-color: #8b0000; background: rgba(139,0,0,0.1); }
#debug-body {
  flex: 1; overflow-y: auto; padding: 16px;
  scrollbar-width: thin; scrollbar-color: #4a0000 transparent;
  font-family: var(--font-mono); font-size: 11px; color: #cc8888;
  line-height: 1.7;
}
#debug-body::-webkit-scrollbar { width: 4px; }
#debug-body::-webkit-scrollbar-thumb { background: #4a0000; }
.dtab-pane { display: none; }
.dtab-pane.active { display: block; }
.debug-row { display: flex; gap: 10px; margin-bottom: 4px; border-bottom: 1px solid #1a0808; padding-bottom: 3px; }
.debug-key { color: #8b4444; flex: 0 0 180px; word-break: break-all; }
.debug-val { color: #cc8888; word-break: break-all; flex: 1; }
.debug-section-title {
  font-family: var(--font-display); font-size: 9px; letter-spacing: 0.2em;
  color: #8b0000; text-transform: uppercase; margin-bottom: 8px; margin-top: 14px;
}
.debug-section-title:first-child { margin-top: 0; }
.debug-btn {
  background: none; border: 1px solid #4a0000; color: #884444;
  padding: 3px 10px; font-family: var(--font-mono); font-size: 10px;
  cursor: pointer; letter-spacing: 0.1em; transition: var(--transition);
  margin: 2px;
}
.debug-btn:hover { border-color: #8b0000; color: #cc4444; background: rgba(139,0,0,0.2); }
#ls-editor { width: 100%; height: 200px; background: #080000; border: 1px solid #2a0000; color: #cc8888; font-family: var(--font-mono); font-size: 11px; padding: 8px; resize: vertical; }
#ls-editor:focus { border-color: #8b0000; outline: none; }
#fps-display { font-size: 24px; color: #ff4444; font-family: var(--font-display); }
#mem-display { font-size: 14px; color: #cc4444; }
#error-log { max-height: 200px; overflow-y: auto; }
.error-entry { color: #ff6666; border-left: 2px solid #8b0000; padding-left: 8px; margin-bottom: 4px; font-size: 10px; }
.warn-entry { color: #cc8844; border-left: 2px solid #664400; padding-left: 8px; margin-bottom: 4px; font-size: 10px; }

/* ===== TOAST ===== */
#toast {
  position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%);
  z-index: 10010; background: var(--bg2); border: 1px solid var(--accent);
  box-shadow: 0 0 20px var(--glow);
  padding: 6px 16px; font-family: var(--font-mono); font-size: 11px;
  color: var(--fg); letter-spacing: 0.1em;
  opacity: 0; transition: opacity 0.2s; pointer-events: none;
}
#toast.show { opacity: 1; }

/* ===== CENTER CONTENT ===== */
#center-content {
  flex: 1; display: flex;
  align-items: center; justify-content: center;
  overflow: hidden; position: relative;
}
#boot-art {
  text-align: center; opacity: 0.15;
  font-family: var(--font-retro); font-size: 11px;
  color: var(--accent); letter-spacing: 0.05em;
  line-height: 1.2; user-select: none; pointer-events: none;
  white-space: pre;
}

/* ===== MEDIA QUERIES ===== */
@media (max-width: 768px) {
  #links-panel { flex-basis: 160px; }
  #notes-panel { flex-basis: 150px; }
  .stat-cell { min-width: 55px; padding: 4px 8px; }
}
@media (max-width: 580px) {
  #main { flex-direction: column; }
  #links-panel { flex: none; flex-basis: auto; border-right: none; border-bottom: 1px solid var(--border); max-height: 180px; }
  #notes-panel { flex: none; flex-basis: auto; border-left: none; border-top: 1px solid var(--border); max-height: 120px; }
  #center-panel { flex: 1; min-height: 0; }
}
@media (prefers-reduced-motion: reduce) {
  *, *::before, *::after { animation: none !important; transition: none !important; }
}

/* ===== PERMISSION MODAL ===== */
#permission-modal {
  position: fixed;
  inset: 0;
  z-index: 10000;
  display: flex;
  align-items: center;
  justify-content: center;
  opacity: 0;
  pointer-events: none;
  transition: opacity 0.3s;
}
#permission-modal.open {
  opacity: 1;
  pointer-events: auto;
}
.permission-modal-overlay {
  position: absolute;
  inset: 0;
  background: rgba(0,0,0,0.7);
  z-index: 0;
}
.permission-modal-content {
  position: relative;
  z-index: 1;
  background: var(--bg2);
  border: 1px solid var(--border);
  border-radius: 2px;
  padding: 20px;
  max-width: 500px;
  max-height: 90vh;
  overflow-y: auto;
  box-shadow: 0 0 60px rgba(0,0,0,0.8);
}

</style>
</head>
<body>

<div id="bg-layer"></div>
<div id="bg-dim"></div>
<div id="screen-overlay"></div>

<div id="app">
  <!-- HEADER -->
  <header id="header">
    <span id="sys-label" title="Device info">SYS//</span>
    <span id="sys-title" title="Edit title">SYS//HOME</span>
    <div id="header-right">
      <div id="status-led" title="System OK"></div>
      <button class="hdr-btn" onclick="openSettings()" aria-label="Settings">‚öô CFG</button>

    </div>
  </header>

  <!-- STATS BAR -->
  <div id="stats-bar" role="status">
    <div class="stat-cell" id="stat-clock-cell">
      <span class="stat-label">TIME</span>
      <span class="stat-val" id="stat-clock">--:--:--</span>
      <button class="stat-refresh" onclick="refreshStat('clock',this)" title="Refresh">‚Üª</button>
    </div>
    <div class="stat-cell" id="stat-battery-cell">
      <span class="stat-label">BATT <span id="stat-battery-icon">üîã</span></span>
      <span class="stat-val" id="stat-battery">--%</span>
      <button class="stat-refresh" onclick="refreshStat('battery',this)" title="Refresh">‚Üª</button>
    </div>
    <div class="stat-cell" id="stat-net-cell">
      <span class="stat-label">NET</span>
      <span class="stat-val" id="stat-net">--</span>
    </div>
    <div class="stat-cell" id="stat-dl-cell">
      <span class="stat-label">DL</span>
      <span class="stat-val" id="stat-dl">-- Mbps</span>
      <button class="stat-refresh" onclick="refreshStat('dl',this)" title="Refresh">‚Üª</button>
    </div>
    <div class="stat-cell" id="stat-ping-cell">
      <span class="stat-label">PING</span>
      <span class="stat-val" id="stat-ping">-- ms</span>
      <button class="stat-refresh" onclick="refreshStat('ping',this)" title="Refresh">‚Üª</button>
    </div>
    <div class="stat-cell" id="stat-ip-cell">
      <span class="stat-label">IP</span>
      <span class="stat-val" id="stat-ip">---.---</span>
      <button class="stat-refresh" onclick="refreshStat('ip',this)" title="Refresh">‚Üª</button>
    </div>
    <div class="stat-cell" id="weather-cell" title="Weather">
      <span class="stat-label">WTHR</span>
      <div style="display:flex;align-items:center;gap:4px">
        <span class="weather-icon" id="weather-icon">--</span>
        <span class="weather-temp" id="weather-temp">--</span>
      </div>
      <span class="weather-desc" id="weather-desc">--</span>
      <button class="stat-refresh" onclick="refreshStat('weather',this)" title="Refresh">‚Üª</button>
    </div>
  </div>

  <!-- SEARCH ROW -->
  <div id="search-row">
    <div style="position:relative">
      <button id="search-engine-btn" onclick="toggleEngineMenu()" aria-label="Select search engine" aria-expanded="false">GOOG</button>
      <div id="search-engine-menu" role="listbox">
        <div class="eng-opt active" data-engine="google" data-url="https://www.google.com/search?q=" data-label="GOOG" onclick="selectEngine(this)" role="option">Google</div>
        <div class="eng-opt" data-engine="ddg" data-url="https://duckduckgo.com/?q=" data-label="DDG" onclick="selectEngine(this)" role="option">DuckDuckGo</div>
        <div class="eng-opt" data-engine="bing" data-url="https://www.bing.com/search?q=" data-label="BING" onclick="selectEngine(this)" role="option">Bing</div>
        <div class="eng-opt" data-engine="brave" data-url="https://search.brave.com/search?q=" data-label="BRAV" onclick="selectEngine(this)" role="option">Brave Search</div>
        <div class="eng-opt" data-engine="yandex" data-url="https://yandex.com/search/?text=" data-label="YNDX" onclick="selectEngine(this)" role="option">Yandex</div>
        <div class="eng-opt" data-engine="startpage" data-url="https://www.startpage.com/search?q=" data-label="STRT" onclick="selectEngine(this)" role="option">Startpage</div>
      </div>
    </div>
    <div id="search-wrapper">
      <input id="search-input" type="text" placeholder="ENTER QUERY..." autocomplete="off" 
             aria-label="Search" onkeydown="if(event.key==='Enter')doSearch()">
    </div>
    <button id="search-submit" onclick="doSearch()">EXEC</button>
  </div>

  <!-- MAIN CONTENT -->
  <div id="main">
    <!-- LINKS -->
    <nav id="links-panel" aria-label="Links">
      <div id="links-panel-header">
        <span class="panel-title">// LINKS</span>
        <button id="links-edit-btn" class="hdr-btn" onclick="toggleLinksEditMode()" title="Edit links, categories, order" style="font-size:9px;padding:1px 5px">EDIT</button>
      </div>
      <div id="links-edit-controls" style="display:none;padding:8px;border-bottom:1px solid var(--border);background:var(--bg2);font-size:10px;gap:6px;display:none">
        <button onclick="openAddLink()" style="padding:4px 8px;background:var(--bg3);border:1px solid var(--border);color:var(--fg);cursor:pointer;font-family:var(--font-family);font-size:9px">+ ADD LINK</button>
        <button onclick="openAddCat()" style="padding:4px 8px;background:var(--bg3);border:1px solid var(--border);color:var(--fg);cursor:pointer;font-family:var(--font-family);font-size:9px">+ CATEGORY</button>
        <button onclick="exitLinksEditMode()" style="padding:4px 8px;background:var(--accent);border:1px solid var(--border);color:#000;cursor:pointer;font-family:var(--font-family);font-size:9px;font-weight:bold">DONE</button>
      </div>
      <div id="links-scroll"></div>
      <button id="add-link-btn" onclick="openAddLink()">+ ADD LINK</button>
    </nav>

    <!-- CENTER -->
    <div id="center-panel">
      <div id="center-content">
        <pre id="boot-art" aria-hidden="true"></pre>
      </div>
      <!-- MUSIC PLAYER -->
      <div id="music-progress-bar" onclick="seekMusic(event)" title="Progress">
        <div id="music-progress-fill"></div>
      </div>
      <div id="music-player">
        <div id="music-playlist">
          <div id="playlist-header">
            <span>// PLAYLIST</span>
            <select id="playlist-format-select" title="Format" onchange="switchFormat(this.value)"></select>
          </div>
          <div id="playlist-tracks"></div>
        </div>
        <img id="music-art" alt="Album art" onclick="togglePlaylist()" title="Click to open playlist">
        <button class="music-btn" id="music-prev-btn" onclick="prevTrack()" title="Previous track" aria-label="Previous">‚èÆ</button>
        <button class="music-btn" id="music-play-btn" onclick="toggleMusic()" title="Play/Pause" aria-label="Play/Pause">‚ñ∂</button>
        <button class="music-btn" id="music-next-btn" onclick="nextTrack()" title="Next track" aria-label="Next">‚è≠</button>
        <button class="music-btn" id="music-loop-btn" onclick="toggleLoop()" title="Loop" aria-label="Toggle loop">‚ü≥</button>
        <span id="music-title" onclick="togglePlaylist()" style="cursor:pointer" title="Click for playlist">NO AUDIO LOADED</span>
        <button id="music-load-btn" onclick="promptLoadArchive()" title="Load archive.org URL">‚¨á LOAD</button>
        <input id="music-vol" type="range" min="0" max="1" step="0.01" value="0.7" oninput="setVolume(this.value)" title="Volume" aria-label="Volume">
      </div>
    </div>

    <!-- NOTES -->
    <aside id="notes-panel">
      <div id="notes-header">
        <div style="display:flex;align-items:center;gap:5px">
          <div class="rec-dot" aria-hidden="true"></div>
          <span class="rec-label">REC</span>
        </div>
        <span class="panel-title">// NOTES</span>
      </div>
      <textarea id="notes-textarea" placeholder="// ENTER NOTES..." aria-label="Notes" spellcheck="false"></textarea>
      <div id="notes-count">0 CHARS</div>
    </aside>
  </div>
</div>

<!-- PERMISSION MODAL (FIRST RUN ONLY) -->
<div id="permission-modal" class="permission-modal">
  <div class="permission-modal-overlay"></div>
  <div class="permission-modal-content">
    <div style="font-size:18px;margin-bottom:16px;font-family:var(--font-display)">‚ö† SYSTEM PERMISSIONS</div>
    <div style="font-size:12px;line-height:1.6;color:var(--fg);margin-bottom:20px">
      this homepage needs your explicit consent before accessing external services.
      <br><br>
      <strong>‚Ä¢ geolocation:</strong> fetch weather and show location-based info<br>
      <strong>‚Ä¢ weather API:</strong> display current conditions<br>
      <strong>‚Ä¢ IP lookup:</strong> show your public IP address<br>
      <strong>‚Ä¢ ping server:</strong> measure network latency to external host<br>
      <br>
      you can revoke or re-enable these anytime in <strong>SETTINGS > ADVANCED > PERMISSIONS</strong>
    </div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:12px">
      <button id="perm-allow-all" onclick="setAllPermissions('granted')" style="padding:8px;background:var(--ok);color:#000;border:1px solid var(--border);cursor:pointer;font-family:var(--font-family);font-size:11px;text-transform:uppercase">ALLOW ALL</button>
      <button id="perm-deny-all" onclick="setAllPermissions('denied')" style="padding:8px;background:var(--danger);color:#fff;border:1px solid var(--border);cursor:pointer;font-family:var(--font-family);font-size:11px;text-transform:uppercase">DENY ALL</button>
    </div>
    <div style="font-size:10px;color:var(--dim);text-align:center">
      ‚Äî or customize ‚Äî
    </div>
    <div id="permission-customizer" style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:12px">
      <div style="border:1px solid var(--border);padding:8px;background:var(--bg2)">
        <div style="font-size:10px;text-transform:uppercase;margin-bottom:6px;color:var(--accent)">geolocation</div>
        <button onclick="togglePermission('perm:geolocation')" id="btn-perm-geo" style="width:100%;padding:6px;background:var(--bg3);border:1px solid var(--border);color:var(--fg);cursor:pointer;font-family:var(--font-family);font-size:10px">DENY</button>
      </div>
      <div style="border:1px solid var(--border);padding:8px;background:var(--bg2)">
        <div style="font-size:10px;text-transform:uppercase;margin-bottom:6px;color:var(--accent)">weather API</div>
        <button onclick="togglePermission('perm:weather')" id="btn-perm-weather" style="width:100%;padding:6px;background:var(--bg3);border:1px solid var(--border);color:var(--fg);cursor:pointer;font-family:var(--font-family);font-size:10px">DENY</button>
      </div>
      <div style="border:1px solid var(--border);padding:8px;background:var(--bg2)">
        <div style="font-size:10px;text-transform:uppercase;margin-bottom:6px;color:var(--accent)">IP lookup</div>
        <button onclick="togglePermission('perm:ip')" id="btn-perm-ip" style="width:100%;padding:6px;background:var(--bg3);border:1px solid var(--border);color:var(--fg);cursor:pointer;font-family:var(--font-family);font-size:10px">DENY</button>
      </div>
      <div style="border:1px solid var(--border);padding:8px;background:var(--bg2)">
        <div style="font-size:10px;text-transform:uppercase;margin-bottom:6px;color:var(--accent)">ping server</div>
        <button onclick="togglePermission('perm:ping')" id="btn-perm-ping" style="width:100%;padding:6px;background:var(--bg3);border:1px solid var(--border);color:var(--fg);cursor:pointer;font-family:var(--font-family);font-size:10px">DENY</button>
      </div>
    </div>
    <div style="margin-top:20px;text-align:center">
      <button id="perm-confirm" onclick="confirmPermissions()" style="padding:10px 24px;background:var(--accent);color:#000;border:1px solid var(--border);cursor:pointer;font-family:var(--font-display);font-size:12px;text-transform:uppercase;font-weight:bold">CONFIRM</button>
    </div>
  </div>
</div>

<!-- TOAST -->
<div id="toast" role="alert" aria-live="assertive"></div>

<!-- SETTINGS MODAL -->
<div id="settings-modal" role="dialog" aria-modal="true" aria-label="Settings">
  <div id="settings-box">
    <div id="settings-title-bar">
      <span id="settings-title">‚öô SYSTEM CONFIGURATION</span>
      <button id="settings-close" onclick="closeSettings()" aria-label="Close settings">‚úï</button>
    </div>
    <div id="settings-tabs" role="tablist">
      <div class="stab active" data-tab="display" onclick="switchSettingsTab('display')" role="tab">DISPLAY</div>
      <div class="stab" data-tab="stats" onclick="switchSettingsTab('stats')" role="tab">STATS</div>
      <div class="stab" data-tab="media" onclick="switchSettingsTab('media')" role="tab">MEDIA</div>
      <div class="stab" data-tab="advanced" onclick="switchSettingsTab('advanced')" role="tab">ADVANCED</div>
    </div>
    <div id="settings-body">
      <!-- DISPLAY TAB -->
      <div class="tab-pane active" id="tab-display">
        <div class="sform-section-title">DEVICE</div>
        <div class="sform-row">
          <label class="sform-label">Device Name</label>
          <input type="text" id="s-device-name" style="width:160px" placeholder="MY CONSOLE">
        </div>
        <div class="sform-row">
          <label class="sform-label">Page Title</label>
          <input type="text" id="s-page-title" style="width:160px" placeholder="SYS//HOME">
        </div>
        <hr class="sform-sep">
        <div class="sform-section-title">THEME</div>
        <div class="sform-row">
          <label class="sform-label">Color Mode</label>
          <select id="s-theme" style="width:120px">
            <option value="dark">DARK</option>
            <option value="light">LIGHT</option>
            <option value="auto">AUTO</option>
          </select>
        </div>
        <div class="sform-row">
          <label class="sform-label">Accent Color</label>
          <div class="accent-swatches">
            <div class="accent-swatch swatch-amber active" data-accent="amber" onclick="setAccent('amber',this)" title="Amber"></div>
            <div class="accent-swatch swatch-green" data-accent="green" onclick="setAccent('green',this)" title="Green"></div>
            <div class="accent-swatch swatch-cyan" data-accent="cyan" onclick="setAccent('cyan',this)" title="Cyan"></div>
            <div class="accent-swatch swatch-red" data-accent="red" onclick="setAccent('red',this)" title="Red"></div>
            <div class="accent-swatch swatch-violet" data-accent="violet" onclick="setAccent('violet',this)" title="Violet"></div>
            <div class="accent-swatch swatch-white" data-accent="white" onclick="setAccent('white',this)" title="White"></div>
            <div class="accent-swatch swatch-orange" data-accent="orange" onclick="setAccent('orange',this)" title="Orange"></div>
            <div class="accent-swatch swatch-yellow" data-accent="yellow" onclick="setAccent('yellow',this)" title="Yellow"></div>
          </div>
        </div>
        <div class="sform-row">
          <label class="sform-label">Font</label>
          <select id="s-font" style="width:160px" onchange="applyFont(this.value)">
            <option value="mono">Share Tech Mono</option>
            <option value="orbitron">Orbitron</option>
            <option value="vt323">VT323</option>
            <option value="courier">Courier New</option>
            <option value="ibm">IBM Plex Mono</option>
            <option value="space">Space Mono</option>
            <option value="fira">Fira Code</option>
          </select>
        </div>
        <hr class="sform-sep">
        <div class="sform-section-title">SCREEN EFFECT</div>
        <div class="sform-row">
          <label class="sform-label">Effect Type</label>
          <select id="s-effect" style="width:120px">
            <option value="none">NONE</option>
            <option value="crt" selected>CRT</option>
            <option value="arcade">ARCADE</option>
            <option value="vhs">VHS</option>
            <option value="gameboy">GAMEBOY</option>
            <option value="phosphor">PHOSPHOR</option>
          </select>
        </div>
        <div class="sform-row">
          <label class="sform-label">Effect Intensity <span class="sform-sublabel" id="effect-intensity-val">0.7</span></label>
          <input type="range" id="s-effect-intensity" min="0" max="1" step="0.05" value="0.7" oninput="document.getElementById('effect-intensity-val').textContent=this.value;applyEffectIntensity(this.value)" style="width:120px">
        </div>
        <div class="sform-row">
          <label class="sform-label">Grain Overlay</label>
          <input type="checkbox" id="s-grain" checked>
        </div>
        <div class="sform-row">
          <label class="sform-label">ASCII Background Logo</label>
          <select id="s-ascii-logo" style="width:160px" onchange="applyAsciiLogo(this.value)">
            <option value="cpu">CPU</option>
            <option value="skull">SKULL</option>
            <option value="android">ANDROID</option>
            <option value="ghost">GHOST</option>
            <option value="lock">LOCK</option>
            <option value="cross">CROSSHAIR</option>
            <option value="sword">SWORD</option>
            <option value="none">NONE</option>
          </select>
        </div>
        <hr class="sform-sep">
        <div class="sform-section-title">BACKGROUND</div>
        <div class="sform-row">
          <label class="sform-label">Image URL</label>
          <input type="url" id="s-bg-url" style="width:160px" placeholder="https://...">
        </div>
        <div class="sform-row">
          <label class="sform-label">Fit</label>
          <select id="s-bg-fit" style="width:120px">
            <option value="cover">ZOOM/COVER</option>
            <option value="contain">FIT/CONTAIN</option>
            <option value="100% 100%">STRETCH</option>
            <option value="auto">ORIGINAL</option>
            <option value="repeat">TILE</option>
          </select>
        </div>
        <div class="sform-row">
          <label class="sform-label">Background Dim <span class="sform-sublabel" id="bg-dim-val">0.85</span></label>
          <input type="range" id="s-bg-dim" min="0" max="1" step="0.05" value="0.85" oninput="document.getElementById('bg-dim-val').textContent=this.value;applyBgDim(this.value)" style="width:120px">
        </div>
      </div>

      <!-- STATS TAB -->
      <div class="tab-pane" id="tab-stats">
        <div class="sform-section-title">VISIBLE STATS</div>
        <div class="sform-row"><label class="sform-label">Clock</label><input type="checkbox" id="s-show-clock" checked></div>
        <div class="sform-row"><label class="sform-label">Battery</label><input type="checkbox" id="s-show-battery" checked></div>
        <div class="sform-row"><label class="sform-label">Network Type</label><input type="checkbox" id="s-show-net" checked></div>
        <div class="sform-row"><label class="sform-label">Downlink</label><input type="checkbox" id="s-show-dl" checked></div>
        <div class="sform-row"><label class="sform-label">Ping</label><input type="checkbox" id="s-show-ping" checked></div>
        <div class="sform-row"><label class="sform-label">IP Address</label><input type="checkbox" id="s-show-ip" checked></div>
        <div class="sform-row"><label class="sform-label">Weather</label><input type="checkbox" id="s-show-weather" checked></div>
        <hr class="sform-sep">
        <div class="sform-section-title">CLOCK FORMAT</div>
        <div class="sform-row">
          <label class="sform-label">24-Hour Clock</label>
          <input type="checkbox" id="s-24hr" checked>
        </div>
        <hr class="sform-sep">
        <div class="sform-section-title">PING SERVER</div>
        <div class="sform-row">
          <label class="sform-label">Target</label>
          <select id="s-ping-server" style="width:160px">
            <option value="https://dns.google">Google DNS</option>
            <option value="https://1.1.1.1">Cloudflare DNS</option>
            <option value="https://dns.quad9.net">Quad9</option>
            <option value="https://www.opendns.com">OpenDNS</option>
          </select>
        </div>
        <hr class="sform-sep">
        <div class="sform-section-title">REFRESH RATES (seconds)</div>
        <div class="sform-row"><label class="sform-label">Battery</label><input type="number" id="s-refresh-battery" min="5" max="300" value="30" style="width:70px"></div>
        <div class="sform-row"><label class="sform-label">Network/Downlink</label><input type="number" id="s-refresh-net" min="5" max="300" value="15" style="width:70px"></div>
        <div class="sform-row"><label class="sform-label">IP Address</label><input type="number" id="s-refresh-ip" min="30" max="600" value="60" style="width:70px"></div>
        <div class="sform-row"><label class="sform-label">Ping</label><input type="number" id="s-refresh-ping" min="5" max="120" value="10" style="width:70px"></div>
        <div class="sform-row"><label class="sform-label">Weather</label><input type="number" id="s-refresh-weather" min="60" max="3600" value="600" style="width:70px"></div>
        <hr class="sform-sep">
        <div class="sform-section-title">OPENWEATHERMAP</div>
        <div style="margin-bottom:8px;font-family:var(--font-mono);font-size:10px;color:var(--dim)">
          Requires free API key from openweathermap.org
        </div>
        <div class="sform-row"><label class="sform-label">API Key</label></div>
        <div style="margin-bottom:8px"><input type="password" id="s-weather-key" style="width:100%" placeholder="API key..."></div>
        <div class="sform-row"><label class="sform-label">City Name</label><input type="text" id="s-weather-city" style="width:140px" placeholder="Tokyo,JP"></div>
        <div class="sform-row"><label class="sform-label">Units</label>
          <select id="s-weather-units" style="width:120px">
            <option value="imperial">¬∞F (Imperial)</option>
            <option value="metric">¬∞C (Metric)</option>
          </select>
        </div>
        <div style="margin-top:10px">
          <button class="btn btn-ghost" onclick="refreshStat('weather',document.querySelector('#weather-cell .stat-refresh'))">TEST WEATHER</button>
        </div>
      </div>

      <!-- MEDIA TAB -->
      <div class="tab-pane" id="tab-media">
        <div class="sform-section-title">BACKGROUND MUSIC</div>
        <div class="sform-row"><label class="sform-label">Audio URL</label></div>
        <div style="margin-bottom:8px"><input type="url" id="s-music-url" style="width:100%" placeholder="https://archive.org/...mp3"></div>
        <div class="sform-row"><label class="sform-label">Autoplay</label><input type="checkbox" id="s-music-autoplay"></div>
        <div class="sform-row"><label class="sform-label">Loop</label><input type="checkbox" id="s-music-loop" checked></div>
        <div class="sform-row">
          <label class="sform-label">Volume <span class="sform-sublabel" id="s-music-vol-val">70%</span></label>
          <input type="range" id="s-music-vol" min="0" max="100" step="1" value="70" oninput="document.getElementById('s-music-vol-val').textContent=this.value+'%'" style="width:120px">
        </div>
        <hr class="sform-sep">
        <div class="sform-section-title">SEARCH</div>
        <div class="sform-row"><label class="sform-label">Open Search In</label>
          <select id="s-search-target" style="width:120px">
            <option value="new">New Tab</option>
            <option value="same">Current Tab</option>
          </select>
        </div>
      </div>

      <!-- ADVANCED TAB -->
      <div class="tab-pane" id="tab-advanced">
        <div class="sform-section-title">SERVICE WORKER CACHE</div>
        <button class="btn btn-ghost" onclick="clearSWCache()">CLEAR CACHE</button>
        <button class="btn btn-ghost" onclick="refreshSWCache()">REFRESH CACHE</button>
        <div id="sw-status" style="margin-top:8px;font-family:var(--font-mono);font-size:10px;color:var(--dim)">SW: checking...</div>
        <hr class="sform-sep">
        <div class="sform-section-title">PERMISSIONS</div>
        <div style="margin-bottom:12px;font-family:var(--font-mono);font-size:10px;color:var(--dim)">Grant or deny access to external services:</div>
        <div class="sform-row" style="display:flex;justify-content:space-between;align-items:center">
          <label class="sform-label">Geolocation</label>
          <button id="perm-toggle-geo" onclick="togglePermissionFromSettings('perm:geolocation')" style="padding:4px 12px;background:var(--bg3);border:1px solid var(--border);color:var(--fg);cursor:pointer;font-family:var(--font-family);font-size:10px;text-transform:uppercase;min-width:80px">--</button>
        </div>
        <div class="sform-row" style="display:flex;justify-content:space-between;align-items:center">
          <label class="sform-label">Weather API</label>
          <button id="perm-toggle-weather" onclick="togglePermissionFromSettings('perm:weather')" style="padding:4px 12px;background:var(--bg3);border:1px solid var(--border);color:var(--fg);cursor:pointer;font-family:var(--font-family);font-size:10px;text-transform:uppercase;min-width:80px">--</button>
        </div>
        <div class="sform-row" style="display:flex;justify-content:space-between;align-items:center">
          <label class="sform-label">IP Lookup</label>
          <button id="perm-toggle-ip" onclick="togglePermissionFromSettings('perm:ip')" style="padding:4px 12px;background:var(--bg3);border:1px solid var(--border);color:var(--fg);cursor:pointer;font-family:var(--font-family);font-size:10px;text-transform:uppercase;min-width:80px">--</button>
        </div>
        <div class="sform-row" style="display:flex;justify-content:space-between;align-items:center">
          <label class="sform-label">Ping Server</label>
          <button id="perm-toggle-ping" onclick="togglePermissionFromSettings('perm:ping')" style="padding:4px 12px;background:var(--bg3);border:1px solid var(--border);color:var(--fg);cursor:pointer;font-family:var(--font-family);font-size:10px;text-transform:uppercase;min-width:80px">--</button>
        </div>
        <hr class="sform-sep">
        <div class="sform-section-title">CUSTOM COLORS</div>
        <div class="sform-row"><label class="sform-label">Foreground</label><input type="color" id="s-color-fg" value="#e8e0c8"></div>
        <div class="sform-row"><label class="sform-label">Background</label><input type="color" id="s-color-bg" value="#080808"></div>
        <div class="sform-row"><label class="sform-label">Accent</label><input type="color" id="s-color-accent" value="#c8a84b"></div>
        <div class="sform-row"><label class="sform-label">Dim</label><input type="color" id="s-color-dim" value="#3a3530"></div>
        <div class="sform-row"><label class="sform-label">Use Custom Colors</label><input type="checkbox" id="s-custom-colors"></div>
        <hr class="sform-sep">
        <div class="sform-section-title">RESET DEFAULTS</div>
        <div style="margin-bottom:8px;font-family:var(--font-mono);font-size:10px;color:var(--dim)">Select settings categories to reset:</div>
        <div class="sform-row"><label class="sform-label">1. Display</label><input type="checkbox" id="r-display"></div>
        <div class="sform-row"><label class="sform-label">2. Stats</label><input type="checkbox" id="r-stats"></div>
        <div class="sform-row"><label class="sform-label">3. Media</label><input type="checkbox" id="r-media"></div>
        <div class="sform-row"><label class="sform-label">4. Advanced</label><input type="checkbox" id="r-advanced"></div>
        <div class="sform-row"><label class="sform-label">5. Links</label><input type="checkbox" id="r-links"></div>
        <div class="sform-row"><label class="sform-label">6. Notes</label><input type="checkbox" id="r-notes"></div>
        <button class="btn btn-ghost" onclick="resetSelected()" style="margin-top:4px">RESET SELECTED</button>
        <hr class="sform-sep">
        <div class="sform-section-title" style="color:var(--danger)">DANGER ZONE</div>
        <div style="margin-bottom:8px;font-family:var(--font-mono);font-size:10px;color:var(--dim)">Permanently destroys all data. Irreversible.</div>
        <button class="btn" onclick="closeSettings();openNuke()" style="background:#440000;border:1px solid #cc0000;color:#ff4444;font-family:var(--font-display);font-size:10px;letter-spacing:0.15em;cursor:pointer;padding:6px 16px">‚ò¢ TOTAL NUCLEAR RESET</button>
        <hr class="sform-sep">
        <div class="sform-section-title">EXPORT / IMPORT</div>
        <div style="display:flex;gap:8px">
          <button class="btn btn-ghost" onclick="exportSettings()">EXPORT SETTINGS</button>
          <button class="btn btn-ghost" onclick="importSettings()">IMPORT SETTINGS</button>
        </div>
      </div>
    </div>
    <div id="settings-footer">
      <span class="settings-note" id="settings-unsaved-msg"></span>
      <div style="display:flex;gap:8px">
        <button class="btn btn-ghost" onclick="closeSettings()">CANCEL</button>
        <button class="btn btn-primary" onclick="saveSettings()">üíæ SAVE</button>
      </div>
    </div>
  </div>
</div>

<!-- ADD LINK / CATEGORY DIALOG -->
<div id="dialog-overlay" role="dialog" aria-modal="true">
  <div id="dialog-box">
    <div id="dialog-title">ADD LINK</div>
    <div id="dialog-fields"></div>
    <div class="dialog-btns">
      <button class="btn btn-ghost" onclick="closeDialog()">CANCEL</button>
      <button class="btn btn-primary" onclick="confirmDialog()">ADD</button>
    </div>
  </div>
</div>

<!-- NUCLEAR ERASE MODAL -->
<div id="nuke-modal" role="dialog" aria-modal="true" aria-label="Erase all data">
  <div id="nuke-box">
    <div id="nuke-banner">‚ö† TOTAL NUCLEAR RESET ‚ö†</div>
    <div id="nuke-icon">‚ò¢</div>
    <div id="nuke-title">INITIATING SYSTEM WIPE</div>
    <div id="nuke-desc">
      THIS OPERATION WILL PERMANENTLY DESTROY:<br>
      ALL SETTINGS ¬∑ ALL LINKS ¬∑ ALL NOTES<br>
      ALL CACHED DATA ¬∑ ALL STORED KEYS<br>
      <br>
      THIS CANNOT BE UNDONE.<br>
      YOU HAVE BEEN WARNED.
    </div>
    <div id="nuke-confirm-wrap">
      <label>TYPE "ERASE" TO CONFIRM DESTRUCTION:</label>
      <input id="nuke-confirm-input" type="text" autocomplete="off" oninput="checkNukeConfirm()" placeholder="">
    </div>
    <div id="nuke-btns">
      <button id="nuke-cancel" onclick="closeNuke()">ABORT</button>
      <button id="nuke-go" onclick="executeNuke()" disabled>EXECUTE WIPE</button>
    </div>
  </div>
</div>

<!-- DEBUG PANEL -->
<div id="debug-panel" role="dialog" aria-modal="true" aria-label="Debug panel">
  <div id="debug-header">
    <div>
      <div id="debug-banner">‚ö† [RESTRICTED ACCESS] SYS//DEBUG ‚Äî KERNEL LEVEL ‚Äî</div>
    </div>
    <button id="debug-close" onclick="closeDebug()">‚úï EXIT</button>
  </div>
  <div id="debug-warn-bar">‚ö† DATA UNSANITIZED ‚Äî CLOSE BEFORE SHARING ‚Äî KERNEL DIAGNOSTIC MODE ‚Äî UNAUTHORIZED ACCESS LOGGED</div>
  <div id="debug-tabs" role="tablist">
    <div class="dtab active" data-dtab="sysinfo" onclick="switchDebugTab('sysinfo')" role="tab">SYSINFO</div>
    <div class="dtab" data-dtab="perf" onclick="switchDebugTab('perf')" role="tab">PERF</div>
    <div class="dtab" data-dtab="storage" onclick="switchDebugTab('storage')" role="tab">STORAGE</div>
    <div class="dtab" data-dtab="errors" onclick="switchDebugTab('errors')" role="tab">ERRORS</div>
    <div class="dtab" data-dtab="nuke-config" onclick="switchDebugTab('nuke-config')" role="tab">NUKE CFG</div>
  </div>
  <div id="debug-body">
    <div class="dtab-pane active" id="dtab-sysinfo"></div>
    <div class="dtab-pane" id="dtab-perf">
      <div class="debug-section-title">PERFORMANCE</div>
      <div style="margin-bottom:8px">FPS: <span id="fps-display">--</span></div>
      <div style="margin-bottom:8px" id="mem-display">MEM: --</div>
      <div id="perf-entries"></div>
    </div>
    <div class="dtab-pane" id="dtab-storage">
      <div class="debug-section-title">LOCAL STORAGE RAW DUMP</div>
      <textarea id="ls-editor" spellcheck="false"></textarea>
      <div style="margin-top:8px">
        <button class="debug-btn" onclick="saveLS()">WRITE TO STORAGE</button>
        <button class="debug-btn" onclick="refreshLSEditor()">REFRESH DUMP</button>
      </div>
    </div>
    <div class="dtab-pane" id="dtab-errors">
      <div class="debug-section-title">ERROR LOG</div>
      <div id="error-log"></div>
      <button class="debug-btn" onclick="clearErrors()">CLEAR LOG</button>
    </div>
    <div class="dtab-pane" id="dtab-nuke-config">
      <div class="debug-section-title">NUCLEAR ERASE PRESET</div>
      <div style="font-size:10px;color:#884444;margin-bottom:12px">Configure the ERASE ALL DATA experience. These changes are forbidden in normal settings.</div>
      <div class="sform-row" style="margin-bottom:10px">
        <span style="font-family:var(--font-mono);font-size:11px;color:#cc8888;flex:1">Nuke Preset</span>
        <select id="nuke-preset" style="background:#0a0000;border:1px solid #4a0000;color:#cc4444;font-family:var(--font-mono);font-size:11px;padding:3px" onchange="applyNukePreset(this.value)">
          <option value="default">DEFAULT</option>
          <option value="creepypasta">CREEPYPASTA</option>
          <option value="arg">ARG SEQUENCE</option>
          <option value="bsod">BSOD STYLE</option>
          <option value="loop">LOOP HELL</option>
        </select>
      </div>
      <div id="nuke-preset-desc" style="font-size:10px;color:#664444;line-height:1.8;font-family:var(--font-mono);margin-bottom:16px"></div>
      <div class="debug-section-title">CUSTOM SIREN AUDIO</div>
      <div style="font-size:10px;color:#664444;margin-bottom:6px;font-family:var(--font-mono)">URL override for alarm sound. Leave blank to use synthesized siren.</div>
      <input type="url" id="s-siren-url" style="width:100%;background:#0a0000;border:1px solid #4a0000;color:#cc4444;font-family:var(--font-mono);font-size:11px;padding:4px 6px;outline:none;margin-bottom:8px" placeholder="https://... .mp3">
      <button id="debug-save-btn" class="btn btn-ghost" style="font-size:11px" onclick="saveDebugSettings()">üíæ SAVE / APPLY</button>
    </div>
  </div>
</div>

<audio id="bg-audio" preload="none"></audio>
<audio id="siren-audio" preload="none"></audio>

<script>
// ============================================================
// CONSTANTS & DEFAULTS
// ============================================================
const RESET_KEYS = {
  display: [
    'settings:theme','settings:accent','settings:font',
    'settings:effect','settings:effectIntensity',
    'settings:grain','settings:bgUrl','settings:bgFit',
    'settings:bgDim','settings:deviceName','settings:pageTitle',
    'settings:customColors','settings:colorFg','settings:colorBg',
    'settings:colorAccent','settings:colorDim','settings:asciiLogo'
  ],
  stats: [
    'settings:show:clock','settings:show:battery','settings:show:net',
    'settings:show:dl','settings:show:ping','settings:show:ip','settings:show:weather',
    'settings:24hr','settings:pingServer',
    'settings:refresh:battery','settings:refresh:net',
    'settings:refresh:ip','settings:refresh:ping','settings:refresh:weather',
    'settings:weatherKey','settings:weatherCity','settings:weatherUnits'
  ],
  media: [
    'settings:musicUrl','settings:musicAutoplay',
    'settings:musicLoop','settings:musicVol','settings:searchTarget',
    'settings:currentTrackIdx'
  ],
  advanced: [
    'settings:sirenUrl'
  ],
  links: [
    'settings:links'
  ],
  notes: [
    'notes:content'
  ]
};

const DEFAULTS = {
  'settings:theme': 'dark',
  'settings:accent': 'amber',
  'settings:font': 'mono',
  'settings:effect': 'crt',
  'settings:effectIntensity': '0.7',
  'settings:grain': 'true',
  'settings:bgUrl': '',
  'settings:bgFit': 'cover',
  'settings:bgDim': '0.85',
  'settings:deviceName': '',
  'settings:pageTitle': 'SYS//HOME',
  'settings:customColors': 'false',
  'settings:colorFg': '#e8e0c8',
  'settings:colorBg': '#080808',
  'settings:colorAccent': '#c8a84b',
  'settings:colorDim': '#3a3530',
  'settings:asciiLogo': 'cpu',
  'settings:show:clock': 'true',
  'settings:show:battery': 'true',
  'settings:show:net': 'true',
  'settings:show:dl': 'true',
  'settings:show:ping': 'true',
  'settings:show:ip': 'true',
  'settings:show:weather': 'true',
  'settings:24hr': 'true',
  'settings:pingServer': 'https://dns.google',
  'settings:refresh:battery': '30',
  'settings:refresh:net': '15',
  'settings:refresh:ip': '60',
  'settings:refresh:ping': '10',
  'settings:refresh:weather': '600',
  'settings:sirenUrl': '',
  'settings:musicUrl': '',
  'settings:musicAutoplay': 'false',
  'settings:musicLoop': 'true',
  'settings:musicVol': '70',
  'settings:searchTarget': 'new',
  'settings:weatherKey': '',
  'settings:weatherCity': '',
  'settings:weatherUnits': 'imperial',
  'notes:content': '',
  'settings:links': JSON.stringify({
    'WEB': [
      {name:'GitHub',url:'https://github.com'},
      {name:'YouTube',url:'https://youtube.com'}
    ],
    'TOOLS': [
      {name:'Archive.org',url:'https://archive.org'},
      {name:'DeepL',url:'https://deepl.com'}
    ],
    'GAMES': [
      {name:'itch.io',url:'https://itch.io'},
      {name:'GameBanana',url:'https://gamebanana.com'}
    ]
  }),
  'settings:searchOpenIn': 'new-tab',
  'settings:linksOpenIn': 'new-tab',
  'settings:nukePreset': 'default',
  'perm:geolocation': 'unasked',
  'perm:weather': 'unasked',
  'perm:ip': 'unasked',
  'perm:ping': 'unasked'
};

// ============================================================
// STATE
// ============================================================
let currentSearchEngine = {url:'https://www.google.com/search?q=',label:'GOOG'};
let statIntervals = {};
let tempSettings = {};
let fpsRaf = null;
let lastFpsTime = performance.now();
let fpsFrames = 0;
let errorLog = [];
let nukePreset = 'default';
let debugUnlocked = false;
let longPressTimer = null;
let lastPingRefresh = 0;
let bgAudio = document.getElementById('bg-audio');
let sirenAudio = document.getElementById('siren-audio');
let nukeAudioPlaying = false;
let permissionChecked = false;
let linksEditMode = false;
let draggedItem = null;

// Capture errors/warnings
const origError = console.error.bind(console);
const origWarn = console.warn.bind(console);
console.error = (...a) => { errorLog.push({type:'error',msg:a.join(' '),t:Date.now()}); origError(...a); };
console.warn = (...a) => { errorLog.push({type:'warn',msg:a.join(' '),t:Date.now()}); origWarn(...a); };
window.addEventListener('error', e => { errorLog.push({type:'error',msg:e.message+' '+e.filename+':'+e.lineno,t:Date.now()}); });

// ============================================================
// PERMISSIONS MANAGEMENT
// ============================================================
function getPerm(key) {
  return localStorage.getItem(key) || DEFAULTS[key] || 'unasked';
}

function setPerm(key, val) {
  localStorage.setItem(key, val);
  updatePermissionButton(key);
}

function updatePermissionButton(key) {
  const btnId = {
    'perm:geolocation': 'btn-perm-geo',
    'perm:weather': 'btn-perm-weather',
    'perm:ip': 'btn-perm-ip',
    'perm:ping': 'btn-perm-ping'
  }[key];
  const btn = document.getElementById(btnId);
  if (!btn) return;
  const perm = getPerm(key);
  btn.textContent = perm === 'granted' ? 'GRANT' : 'DENY';
  btn.style.background = perm === 'granted' ? 'var(--ok)' : 'var(--danger)';
}

function togglePermission(key) {
  const current = getPerm(key);
  const next = current === 'granted' ? 'denied' : 'granted';
  setPerm(key, next);
}

function togglePermissionFromSettings(key) {
  togglePermission(key);
  updatePermissionButtonSettings(key);
}

function updatePermissionButtonSettings(key) {
  const btnMap = {
    'perm:geolocation': 'perm-toggle-geo',
    'perm:weather': 'perm-toggle-weather',
    'perm:ip': 'perm-toggle-ip',
    'perm:ping': 'perm-toggle-ping'
  };
  const btnId = btnMap[key];
  const btn = document.getElementById(btnId);
  if (!btn) return;
  const perm = getPerm(key);
  btn.textContent = perm === 'granted' ? 'GRANTED' : 'DENIED';
  btn.style.background = perm === 'granted' ? 'var(--ok)' : 'var(--danger)';
  btn.style.color = perm === 'granted' ? '#000' : '#fff';
}

function updateAllPermissionButtonsSettings() {
  ['perm:geolocation', 'perm:weather', 'perm:ip', 'perm:ping'].forEach(k => updatePermissionButtonSettings(k));
}

function setAllPermissions(val) {
  ['perm:geolocation', 'perm:weather', 'perm:ip', 'perm:ping'].forEach(k => setPerm(k, val));
}

function confirmPermissions() {
  permissionChecked = true;
  localStorage.setItem('perm:checked', 'true');
  document.getElementById('permission-modal').classList.remove('open');
  loadSettings();
  initServices();
}

function initServices() {
  // only init services if user granted permission
  if (getPerm('perm:ip') === 'granted') fetchIPInfo();
  if (getPerm('perm:ping') === 'granted') initPingServer();
  if (getPerm('perm:weather') === 'granted' && getPerm('perm:geolocation') === 'granted') initWeatherAuto();
  startStatUpdates();
}

function checkFirstRun() {
  if (!localStorage.getItem('perm:checked')) {
    document.getElementById('permission-modal').classList.add('open');
    updateAllPermissionButtons();
    return false;
  }
  permissionChecked = true;
  return true;
}

function updateAllPermissionButtons() {
  ['perm:geolocation', 'perm:weather', 'perm:ip', 'perm:ping'].forEach(k => updatePermissionButton(k));
}

// ============================================================
// SETTINGS: LOAD / SAVE
// ============================================================
function loadSettings() {
  const get = (k) => {
    const v = localStorage.getItem(k);
    return v !== null ? v : DEFAULTS[k] !== undefined ? DEFAULTS[k] : null;
  };

  // Theme
  const theme = get('settings:theme');
  applyTheme(theme === 'auto' ? (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light') : theme);

  // Device name
  const deviceName = get('settings:deviceName');
  if (deviceName) document.getElementById('sys-label').textContent = deviceName + ' //';

  // Page title
  const pageTitle = get('settings:pageTitle') || 'SYS//HOME';
  document.title = pageTitle;
  document.getElementById('page-title').textContent = pageTitle;
  document.getElementById('sys-title').textContent = pageTitle;

  // Effect
  const effect = get('settings:effect') || 'crt';
  document.documentElement.setAttribute('data-effect', effect);

  // Effect intensity
  const ei = parseFloat(get('settings:effectIntensity') || '0.7');
  applyEffectIntensity(ei);

  // Grain
  const grain = get('settings:grain') !== 'false';
  document.documentElement.setAttribute('data-grain', grain ? 'on' : 'off');

  // ASCII Logo
  applyAsciiLogo(get('settings:asciiLogo') || 'cpu');

  // Font
  const font = get('settings:font') || 'mono';
  applyFont(font);

  // Background
  const bgUrl = get('settings:bgUrl') || '';
  const bgFit = get('settings:bgFit') || 'cover';
  const bgDim = parseFloat(get('settings:bgDim') || '0.85');
  applyBackground(bgUrl, bgFit, bgDim);

  // Custom colors - MUST come before preset accent to avoid specificity override
  const customColorsEnabled = get('settings:customColors') === 'true';
  if (customColorsEnabled) {
    applyCustomColors(
      get('settings:colorFg'), get('settings:colorBg'),
      get('settings:colorAccent'), get('settings:colorDim')
    );
  } else {
    // Only apply preset accent if NOT using custom colors
    const accent = get('settings:accent');
    document.documentElement.setAttribute('data-accent', accent || 'amber');
  }

  // Stat visibility
  const statCells = {clock:'stat-clock-cell',battery:'stat-battery-cell',net:'stat-net-cell',dl:'stat-dl-cell',ping:'stat-ping-cell',ip:'stat-ip-cell',weather:'weather-cell'};
  for (const [k, id] of Object.entries(statCells)) {
    const visible = get('settings:show:' + k) !== 'false';
    const el = document.getElementById(id);
    if (el) el.style.display = visible ? '' : 'none';
  }

  // Music
  const musicUrl = get('settings:musicUrl') || '';
  const musicLoop = get('settings:musicLoop') !== 'false';
  const musicVol = parseFloat(get('settings:musicVol') || '70') / 100;
  const musicAutoplay = get('settings:musicAutoplay') === 'true';
  bgAudio.loop = musicLoop;
  bgAudio.volume = musicVol;
  document.getElementById('music-vol').value = musicVol;
  document.getElementById('music-loop-btn').classList.toggle('active', musicLoop);
  
  if (musicUrl && bgAudio.src !== musicUrl) {
    // check if it's an archive.org URL
    if (musicUrl.includes('archive.org/details/')) {
      // async load archive (will build playlist + call loadTrack)
      loadArchiveAlbum(musicUrl);
    } else {
      // direct audio file URL
      if (!archivePlaylist.length || !archivePlaylist.some(t => t.url.includes(archiveIdentifier))) {
        bgAudio.src = musicUrl;
        bgAudio.load();
        document.getElementById('music-title').textContent = guessTrackMeta(musicUrl);
      }
    }
    if (musicAutoplay && bgAudio.paused) bgAudio.play().catch(() => {});
  }

  // Search
  const searchTarget = get('settings:searchTarget') || 'new';
  const searchTargetSelect = document.getElementById('s-search-target');
  if (searchTargetSelect) searchTargetSelect.value = searchTarget;

  // Siren
  const sirenUrl = get('settings:sirenUrl') || '';
  if (sirenUrl) sirenAudio.src = sirenUrl;

  // Nuke Preset
  const savedNukePreset = get('settings:nukePreset') || 'default';
  nukePreset = savedNukePreset;
  const nukeSelect = document.querySelector('#dtab-nuke-config select[onchange*="applyNukePreset"]');
  if (nukeSelect) nukeSelect.value = savedNukePreset;

  // Links
  const links = JSON.parse(get('settings:links') || '{}');
  renderLinks(links);

  // Notes
  const notes = get('notes:content') || '';
  const ta = document.getElementById('notes-textarea');
  ta.value = notes;
  updateNotesCount();

  // Stat intervals
  startStatIntervals();
}

function saveSettings() {
  const set = (k, v) => localStorage.setItem(k, v);

  set('settings:theme', document.getElementById('s-theme').value);
  set('settings:accent', document.documentElement.getAttribute('data-accent') || 'amber');
  set('settings:font', document.getElementById('s-font').value);
  set('settings:effect', document.getElementById('s-effect').value);
  set('settings:effectIntensity', document.getElementById('s-effect-intensity').value);
  set('settings:grain', document.getElementById('s-grain').checked ? 'true' : 'false');
  set('settings:asciiLogo', document.getElementById('s-ascii-logo').value);
  set('settings:bgUrl', document.getElementById('s-bg-url').value);
  set('settings:bgFit', document.getElementById('s-bg-fit').value);
  set('settings:bgDim', document.getElementById('s-bg-dim').value);
  set('settings:deviceName', document.getElementById('s-device-name').value);
  set('settings:pageTitle', document.getElementById('s-page-title').value || 'SYS//HOME');
  set('settings:customColors', document.getElementById('s-custom-colors').checked ? 'true' : 'false');
  set('settings:colorFg', document.getElementById('s-color-fg').value);
  set('settings:colorBg', document.getElementById('s-color-bg').value);
  set('settings:colorAccent', document.getElementById('s-color-accent').value);
  set('settings:colorDim', document.getElementById('s-color-dim').value);

  set('settings:show:clock', document.getElementById('s-show-clock').checked ? 'true' : 'false');
  set('settings:show:battery', document.getElementById('s-show-battery').checked ? 'true' : 'false');
  set('settings:show:net', document.getElementById('s-show-net').checked ? 'true' : 'false');
  set('settings:show:dl', document.getElementById('s-show-dl').checked ? 'true' : 'false');
  set('settings:show:ping', document.getElementById('s-show-ping').checked ? 'true' : 'false');
  set('settings:show:ip', document.getElementById('s-show-ip').checked ? 'true' : 'false');
  set('settings:show:weather', document.getElementById('s-show-weather').checked ? 'true' : 'false');
  set('settings:24hr', document.getElementById('s-24hr').checked ? 'true' : 'false');
  set('settings:pingServer', document.getElementById('s-ping-server').value);
  set('settings:refresh:battery', document.getElementById('s-refresh-battery').value);
  set('settings:refresh:net', document.getElementById('s-refresh-net').value);
  set('settings:refresh:ip', document.getElementById('s-refresh-ip').value);
  set('settings:refresh:ping', document.getElementById('s-refresh-ping').value);
  set('settings:refresh:weather', document.getElementById('s-refresh-weather').value);

  set('settings:musicUrl', document.getElementById('s-music-url').value);
  set('settings:musicAutoplay', document.getElementById('s-music-autoplay').checked ? 'true' : 'false');
  set('settings:musicLoop', document.getElementById('s-music-loop').checked ? 'true' : 'false');
  set('settings:musicVol', document.getElementById('s-music-vol').value);
  set('settings:searchTarget', document.getElementById('s-search-target').value);
  set('settings:weatherKey', document.getElementById('s-weather-key').value);
  set('settings:weatherCity', document.getElementById('s-weather-city').value);
  set('settings:weatherUnits', document.getElementById('s-weather-units').value);

  loadSettings();
  // if new music url is an archive url, load it as album after settings saved
  const newMusicUrl = document.getElementById('s-music-url').value.trim();
  if (newMusicUrl && getArchiveIdentifier && getArchiveIdentifier(newMusicUrl)) {
    closeSettings();
    showToast('üíæ SETTINGS SAVED');
    handleMusicUrl(newMusicUrl);
  } else {
    closeSettings();
    showToast('üíæ SETTINGS SAVED');
  }
}

function populateSettingsUI() {
  const get = (k) => {
    const v = localStorage.getItem(k);
    return v !== null ? v : (DEFAULTS[k] !== undefined ? DEFAULTS[k] : '');
  };

  document.getElementById('s-theme').value = get('settings:theme') || 'dark';
  document.getElementById('s-font').value = get('settings:font') || 'mono';
  document.getElementById('s-effect').value = get('settings:effect') || 'crt';
  document.getElementById('s-effect-intensity').value = get('settings:effectIntensity') || '0.7';
  document.getElementById('effect-intensity-val').textContent = get('settings:effectIntensity') || '0.7';
  document.getElementById('s-grain').checked = get('settings:grain') !== 'false';
  document.getElementById('s-ascii-logo').value = get('settings:asciiLogo') || 'cpu';
  document.getElementById('s-bg-url').value = get('settings:bgUrl') || '';
  document.getElementById('s-bg-fit').value = get('settings:bgFit') || 'cover';
  document.getElementById('s-bg-dim').value = get('settings:bgDim') || '0.85';
  document.getElementById('bg-dim-val').textContent = get('settings:bgDim') || '0.85';
  document.getElementById('s-device-name').value = get('settings:deviceName') || '';
  document.getElementById('s-page-title').value = get('settings:pageTitle') || 'SYS//HOME';
  document.getElementById('s-custom-colors').checked = get('settings:customColors') === 'true';
  document.getElementById('s-color-fg').value = get('settings:colorFg') || '#e8e0c8';
  document.getElementById('s-color-bg').value = get('settings:colorBg') || '#080808';
  document.getElementById('s-color-accent').value = get('settings:colorAccent') || '#c8a84b';
  document.getElementById('s-color-dim').value = get('settings:colorDim') || '#3a3530';

  document.getElementById('s-show-clock').checked = get('settings:show:clock') !== 'false';
  document.getElementById('s-show-battery').checked = get('settings:show:battery') !== 'false';
  document.getElementById('s-show-net').checked = get('settings:show:net') !== 'false';
  document.getElementById('s-show-dl').checked = get('settings:show:dl') !== 'false';
  document.getElementById('s-show-ping').checked = get('settings:show:ping') !== 'false';
  document.getElementById('s-show-ip').checked = get('settings:show:ip') !== 'false';
  document.getElementById('s-show-weather').checked = get('settings:show:weather') !== 'false';
  document.getElementById('s-24hr').checked = get('settings:24hr') !== 'false';
  document.getElementById('s-ping-server').value = get('settings:pingServer') || 'https://dns.google';
  document.getElementById('s-refresh-battery').value = get('settings:refresh:battery') || '30';
  document.getElementById('s-refresh-net').value = get('settings:refresh:net') || '15';
  document.getElementById('s-refresh-ip').value = get('settings:refresh:ip') || '60';
  document.getElementById('s-refresh-ping').value = get('settings:refresh:ping') || '10';
  document.getElementById('s-refresh-weather').value = get('settings:refresh:weather') || '600';

  document.getElementById('s-music-url').value = get('settings:musicUrl') || '';
  document.getElementById('s-music-autoplay').checked = get('settings:musicAutoplay') === 'true';
  document.getElementById('s-music-loop').checked = get('settings:musicLoop') !== 'false';
  document.getElementById('s-music-vol').value = get('settings:musicVol') || '70';
  document.getElementById('s-music-vol-val').textContent = (get('settings:musicVol') || '70') + '%';
  document.getElementById('s-weather-key').value = get('settings:weatherKey') || '';
  document.getElementById('s-weather-city').value = get('settings:weatherCity') || '';
  document.getElementById('s-weather-units').value = get('settings:weatherUnits') || 'imperial';

  // Accent swatches sync
  const curAccent = localStorage.getItem('settings:accent') || 'amber';
  document.querySelectorAll('.accent-swatch').forEach(s => {
    s.classList.toggle('active', s.dataset.accent === curAccent);
  });

  // SW status
  if ('serviceWorker' in navigator && navigator.serviceWorker.controller) {
    document.getElementById('sw-status').textContent = 'SW: ACTIVE';
  } else {
    document.getElementById('sw-status').textContent = 'SW: INACTIVE (GitHub Pages / local)';
  }

  // Permissions
  updateAllPermissionButtonsSettings();
}

// ============================================================
// ASCII LOGOS
// ============================================================
const ASCII_LOGOS = {
  cpu: ` ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó ‚ñà‚ñà‚ïó   ‚ñà‚ñà‚ïó
‚ñà‚ñà‚ïî‚ïê‚ïê‚ïê‚ïê‚ïù‚ñà‚ñà‚ïî‚ïê‚ïê‚ñà‚ñà‚ïó‚ñà‚ñà‚ïë   ‚ñà‚ñà‚ïë
‚ñà‚ñà‚ïë     ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïî‚ïù‚ñà‚ñà‚ïë   ‚ñà‚ñà‚ïë
‚ñà‚ñà‚ïë     ‚ñà‚ñà‚ïî‚ïê‚ïê‚ïê‚ïù ‚ñà‚ñà‚ïë   ‚ñà‚ñà‚ïë
‚ïö‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó‚ñà‚ñà‚ïë     ‚ïö‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïî‚ïù
 ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù‚ïö‚ïê‚ïù      ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù `,
  skull: `  ‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë
 ‚ñë‚ñë  ‚ñë‚ñë‚ñë‚ñë  ‚ñë‚ñë‚ñë‚ñë
‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë
‚ñë‚ñë ‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë ‚ñë‚ñë‚ñë‚ñë‚ñë
 ‚ñë‚ñë ‚ñë‚ñë‚ñë‚ñë ‚ñë‚ñë‚ñë‚ñë‚ñë
  ‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë
  ‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë
  ‚ñë‚ñë‚ñë  ‚ñë‚ñë‚ñë‚ñë`,
  android: `    \\  /  /
  ---====---
 / ‚óè      ‚óè \\
|            |
|    ====    |
 \\__/    \\__/
  ||      ||
 _||_    _||_`,
  ghost: `  ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà
 ‚ñà‚ñà‚ñà‚ñà  ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà
‚ñà‚ñà‚ñà‚ñà ‚ñà‚ñà ‚ñà‚ñà‚ñà‚ñà‚ñà
‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà
‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà
‚ñà‚ñà ‚ñà‚ñà‚ñà‚ñà ‚ñà‚ñà ‚ñà‚ñà
‚ñà  ‚ñà  ‚ñà  ‚ñà  ‚ñà`,
  lock: `  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
 ‚îå‚î§  ‚ñà‚ñà  ‚îú‚îê
 ‚îÇ‚îÇ  ‚ñà‚ñà  ‚îÇ‚îÇ
 ‚îî‚î§        ‚îú‚îò
  ‚îÇ  ‚ñà‚ñà‚ñà‚ñà  ‚îÇ
  ‚îÇ  ‚ñà  ‚ñà  ‚îÇ
  ‚îÇ  ‚ñà‚ñà‚ñà‚ñà  ‚îÇ
  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò`,
  cross: `        ‚îÇ
        ‚îÇ
  ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        ‚îÇ
        ‚îÇ
  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
  ‚îÇ     ‚îÇ     ‚îÇ
  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
        ‚îÇ`,
  sword: `    /\\
   /  \\
  / /\\ \\
 / /  \\ \\
/________\\
    ||
    ||
   /  \\
  /____\\`,
  none: ''
};

function applyAsciiLogo(key) {
  const el = document.getElementById('boot-art');
  if (!el) return;
  el.textContent = ASCII_LOGOS[key] || '';
  el.style.display = (key === 'none' || !ASCII_LOGOS[key]) ? 'none' : '';
}

// ============================================================
// APPLY SETTINGS
// ============================================================
function applyTheme(t) {
  document.documentElement.setAttribute('data-theme', t);
}

function applyEffectIntensity(val) {
  document.documentElement.style.setProperty('--effect-intensity', val);
  const si = Math.max(0.02, val * 0.12);
  document.documentElement.style.setProperty('--scanline-opacity', si);
}

function applyFont(font) {
  const fontMap = {
    mono: "'Share Tech Mono', 'Courier New', monospace",
    orbitron: "'Orbitron', monospace",
    vt323: "'VT323', monospace",
    courier: "'Courier New', monospace",
    ibm: "'IBM Plex Mono', monospace",
    space: "'Space Mono', monospace",
    fira: "'Fira Code', monospace"
  };
  const googleFonts = {
    ibm: 'IBM+Plex+Mono',
    space: 'Space+Mono',
    fira: 'Fira+Code'
  };
  const applyVal = () => {
    const val = fontMap[font] || fontMap.mono;
    document.documentElement.style.setProperty('--font-family', val);
    document.body.style.fontFamily = val;
  };
  if (googleFonts[font]) {
    const linkId = 'extra-font-link';
    let link = document.getElementById(linkId);
    const newHref = `https://fonts.googleapis.com/css2?family=${googleFonts[font]}&display=swap`;
    if (!link || link.href !== newHref) {
      if (link) link.remove();
      link = document.createElement('link');
      link.id = linkId;
      link.rel = 'stylesheet';
      link.href = newHref;
      link.onload = applyVal;
      document.head.appendChild(link);
    } else {
      applyVal();
    }
  } else {
    applyVal();
  }
}

function applyBackground(url, fit, dim) {
  const bgLayer = document.getElementById('bg-layer');
  const bgDimEl = document.getElementById('bg-dim');
  if (url) {
    bgLayer.style.backgroundImage = `url('${url}')`;
    bgLayer.style.backgroundSize = fit === 'repeat' ? 'auto' : fit;
    bgLayer.style.backgroundRepeat = fit === 'repeat' ? 'repeat' : 'no-repeat';
    bgLayer.style.opacity = '1';
    document.documentElement.setAttribute('data-wallpaper', 'true');
  } else {
    bgLayer.style.backgroundImage = '';
    bgLayer.style.opacity = '0';
    document.documentElement.removeAttribute('data-wallpaper');
  }
  bgDimEl.style.opacity = dim;
}

function applyBgDim(val) {
  document.getElementById('bg-dim').style.opacity = val;
}

function applyCustomColors(fg, bg, accent, dim) {
  const r = document.documentElement;
  if (fg) r.style.setProperty('--fg', fg, 'important');
  if (bg) {
    r.style.setProperty('--bg', bg, 'important');
    r.style.setProperty('--bg2', bg, 'important');
  }
  if (accent) {
    r.style.setProperty('--accent', accent, 'important');
    // Derive --accent2 (darker shade, 60% saturation) and glow
    const rgb = hexToRgb(accent);
    if (rgb) {
      const darkened = rgbToHex(Math.floor(rgb.r * 0.55), Math.floor(rgb.g * 0.55), Math.floor(rgb.b * 0.55));
      r.style.setProperty('--accent2', darkened, 'important');
      r.style.setProperty('--glow', `rgba(${rgb.r},${rgb.g},${rgb.b},0.12)`, 'important');
      r.style.setProperty('--glow-strong', `rgba(${rgb.r},${rgb.g},${rgb.b},0.3)`, 'important');
      r.style.setProperty('--warn', accent, 'important');
    }
  }
  if (dim) r.style.setProperty('--dim', dim, 'important');
}

function hexToRgb(hex) {
  const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
  return result ? {
    r: parseInt(result[1], 16),
    g: parseInt(result[2], 16),
    b: parseInt(result[3], 16)
  } : null;
}

function rgbToHex(r, g, b) {
  return "#" + ((1 << 24) + (r << 16) + (g << 8) + b).toString(16).slice(1).toUpperCase();
}

function setAccent(accent, el) {
  document.documentElement.setAttribute('data-accent', accent);
  document.querySelectorAll('.accent-swatch').forEach(s => s.classList.remove('active'));
  if (el) el.classList.add('active');
}

// ============================================================
// STATS
// ============================================================
function updateClock() {
  const use24 = localStorage.getItem('settings:24hr') !== 'false';
  const now = new Date();
  let h = now.getHours(), m = now.getMinutes(), s = now.getSeconds();
  let suffix = '';
  if (!use24) {
    suffix = h >= 12 ? ' PM' : ' AM';
    h = h % 12 || 12;
  }
  const fmt = (n) => String(n).padStart(2,'0');
  document.getElementById('stat-clock').textContent = `${fmt(h)}:${fmt(m)}:${fmt(s)}${suffix}`;
}

async function updateBattery() {
  const el = document.getElementById('stat-battery');
  const icon = document.getElementById('stat-battery-icon');
  try {
    if ('getBattery' in navigator) {
      const bat = await navigator.getBattery();
      const pct = Math.round(bat.level * 100);
      el.textContent = pct + '%';
      el.className = 'stat-val' + (pct < 20 ? ' danger' : pct < 40 ? ' warn' : ' ok');
      icon.textContent = bat.charging ? '‚ö°' : (pct > 80 ? 'üîã' : pct > 40 ? 'ü™´' : 'üî¥');
    } else {
      el.textContent = '~85%';
      el.className = 'stat-val ok';
    }
  } catch(e) {
    el.textContent = 'N/A';
  }
}

function updateNetwork() {
  const netEl = document.getElementById('stat-net');
  const dlEl = document.getElementById('stat-dl');
  const conn = navigator.connection || navigator.mozConnection || navigator.webkitConnection;
  if (conn) {
    const eff = conn.effectiveType || '?';
    netEl.textContent = eff.toUpperCase();
    netEl.className = 'stat-val' + (eff === '4g' ? ' ok' : eff === '3g' ? ' warn' : ' danger');
    const dl = conn.downlink;
    dlEl.textContent = dl !== undefined ? dl.toFixed(1) + ' Mb' : '-- Mb';
    dlEl.className = 'stat-val' + (dl > 5 ? ' ok' : dl > 1 ? ' warn' : ' danger');
  } else {
    netEl.textContent = 'ONLINE';
    netEl.className = 'stat-val ok';
    dlEl.textContent = '-- Mb';
  }
}

async function updatePing() {
  const el = document.getElementById('stat-ping');
  if (getPerm('perm:ping') !== 'granted') {
    if (el) el.textContent = 'BLOCKED';
    return;
  }
  const server = localStorage.getItem('settings:pingServer') || 'https://dns.google';
  if (!server || server === 'none') {
    if (el) el.textContent = '--';
    return;
  }
  try {
    const t = performance.now();
    await fetch(server + '/favicon.ico?_=' + Date.now(), {mode:'no-cors', cache:'no-store', signal: AbortSignal.timeout(5000)});
    const ms = Math.round(performance.now() - t);
    el.textContent = ms + 'ms';
    el.className = 'stat-val' + (ms < 50 ? ' ok' : ms < 150 ? ' warn' : ' danger');
  } catch(e) {
    el.textContent = 'ERR';
    el.className = 'stat-val danger';
  }
}

let cachedIP = null, ipCacheTime = 0;
async function updateIP() {
  if (getPerm('perm:ip') !== 'granted') {
    const el = document.getElementById('stat-ip');
    if (el) el.textContent = 'BLOCKED';
    return;
  }
  const el = document.getElementById('stat-ip');
  const now = Date.now();
  const ttl = parseInt(localStorage.getItem('settings:refresh:ip') || '60') * 1000;
  if (cachedIP && now - ipCacheTime < ttl) { el.textContent = cachedIP; return; }
  try {
    const r = await fetch('https://api.ipify.org?format=json', {signal: AbortSignal.timeout(5000)});
    const data = await r.json();
    cachedIP = data.ip;
    ipCacheTime = now;
    el.textContent = data.ip;
    el.className = 'stat-val ok';
  } catch(e) {
    el.textContent = '?.?.?.?';
  }
}

async function updateWeather() {
  if (getPerm('perm:weather') !== 'granted' || getPerm('perm:geolocation') !== 'granted') {
    const iconEl = document.getElementById('weather-icon');
    const tempEl = document.getElementById('weather-temp');
    const descEl = document.getElementById('weather-desc');
    if (iconEl) iconEl.textContent = '--';
    if (tempEl) tempEl.textContent = 'BLOCKED';
    if (descEl) descEl.textContent = 'NO PERM';
    return;
  }
  const key = localStorage.getItem('settings:weatherKey') || '';
  const city = localStorage.getItem('settings:weatherCity') || '';
  const units = localStorage.getItem('settings:weatherUnits') || 'imperial';
  const iconEl = document.getElementById('weather-icon');
  const tempEl = document.getElementById('weather-temp');
  const descEl = document.getElementById('weather-desc');
  if (!key || !city) {
    iconEl.textContent = '--';
    tempEl.textContent = '--';
    descEl.textContent = 'NO API';
    return;
  }
  try {
    const r = await fetch(`https://api.openweathermap.org/data/2.5/weather?q=${encodeURIComponent(city)}&appid=${key}&units=${units}`, {signal: AbortSignal.timeout(8000)});
    const data = await r.json();
    if (data.cod !== 200) throw new Error(data.message);
    const unit = units === 'metric' ? '¬∞C' : '¬∞F';
    const wmap = {Clear:'‚òÄ',Clouds:'‚òÅ',Rain:'üåß',Snow:'‚ùÑ',Thunderstorm:'‚õà',Drizzle:'üå¶',Mist:'üå´',Fog:'üå´',Haze:'üå´'};
    const wname = data.weather[0].main;
    iconEl.textContent = wmap[wname] || '?';
    tempEl.textContent = Math.round(data.main.temp) + unit;
    descEl.textContent = wname.toUpperCase();
    tempEl.className = 'weather-temp';
  } catch(e) {
    iconEl.textContent = '‚ö†';
    tempEl.textContent = '--';
    descEl.textContent = 'ERR';
    console.warn('Weather error:', e.message);
  }
}

function startStatIntervals() {
  Object.values(statIntervals).forEach(clearInterval);
  statIntervals = {};

  updateClock();
  statIntervals.clock = setInterval(updateClock, 1000);
  updateBattery();
  statIntervals.battery = setInterval(updateBattery, parseInt(localStorage.getItem('settings:refresh:battery')||'30')*1000);
  updateNetwork();
  statIntervals.net = setInterval(updateNetwork, parseInt(localStorage.getItem('settings:refresh:net')||'15')*1000);
  updatePing();
  statIntervals.ping = setInterval(updatePing, parseInt(localStorage.getItem('settings:refresh:ping')||'10')*1000);
  updateIP();
  statIntervals.ip = setInterval(updateIP, parseInt(localStorage.getItem('settings:refresh:ip')||'60')*1000);
  updateWeather();
  statIntervals.weather = setInterval(updateWeather, parseInt(localStorage.getItem('settings:refresh:weather')||'600')*1000);
}

function refreshStat(type, btn) {
  if (type === 'ping') {
    const now = Date.now();
    if (now - lastPingRefresh < 5000) {
      showToast('PING: WAIT ' + Math.ceil((5000 - (now - lastPingRefresh)) / 1000) + 'S');
      return;
    }
    lastPingRefresh = now;
  }
  if (btn) { btn.classList.add('spin'); setTimeout(() => btn.classList.remove('spin'), 400); }
  if (type === 'clock') updateClock();
  else if (type === 'battery') updateBattery();
  else if (type === 'net') updateNetwork();
  else if (type === 'dl') updateNetwork();
  else if (type === 'ping') updatePing();
  else if (type === 'ip') { cachedIP = null; updateIP(); }
  else if (type === 'weather') updateWeather();
}

// ============================================================
// LINKS
// ============================================================
function renderLinks(links) {
  const scroll = document.getElementById('links-scroll');
  scroll.innerHTML = '';
  for (const [cat, items] of Object.entries(links)) {
    const div = document.createElement('div');
    div.className = 'link-category';
    div.dataset.cat = cat;
    const isOpen = localStorage.getItem('cat:open:' + cat) !== 'false';
    div.innerHTML = `
      <div class="cat-header${isOpen?' active':''}" onclick="toggleCat(this,'${escHTML(cat)}')">
        <span>${escHTML(cat)}</span>
        <span class="cat-arrow${isOpen?' open':''}">‚ñ∂</span>
      </div>
      <div class="cat-links${isOpen?' open':''}">
        ${items.map((l,i) => `
          <a class="link-item" href="javascript:void(0)" onclick="openLink(event,'${escHTML(l.url)}')" aria-label="${escHTML(l.name)}">
            ${escHTML(l.name)}
            <button class="link-del" onclick="delLink(event,'${escHTML(cat)}',${i})" title="Remove" aria-label="Remove link">√ó</button>
          </a>
        `).join('')}
      </div>
    `;
    scroll.appendChild(div);
  }
}

function openLink(e, url) {
  if (linksEditMode) return; // prevent opening links in edit mode
  e.preventDefault();
  const openIn = localStorage.getItem('settings:linksOpenIn') || 'new-tab';
  if (openIn === 'new-tab') {
    window.open(url, '_blank', 'noopener');
  } else {
    window.location.href = url;
  }
}

function toggleLinksEditMode() {
  linksEditMode = !linksEditMode;
  const btn = document.getElementById('links-edit-btn');
  const controls = document.getElementById('links-edit-controls');
  if (linksEditMode) {
    btn.style.background = 'var(--accent)';
    btn.style.color = '#000';
    controls.style.display = 'grid';
    renderLinksEditMode(getLinks());
  } else {
    exitLinksEditMode();
  }
}

function exitLinksEditMode() {
  linksEditMode = false;
  const btn = document.getElementById('links-edit-btn');
  const controls = document.getElementById('links-edit-controls');
  btn.style.background = '';
  btn.style.color = '';
  controls.style.display = 'none';
  renderLinks(getLinks());
}

function renderLinksEditMode(links) {
  const scroll = document.getElementById('links-scroll');
  scroll.innerHTML = '';
  for (const [cat, items] of Object.entries(links)) {
    const div = document.createElement('div');
    div.className = 'link-category';
    div.dataset.cat = cat;
    div.innerHTML = `
      <div class="cat-header edit-mode" style="position:relative">
        <span>${escHTML(cat)}</span>
        <div style="display:flex;gap:6px;margin-left:auto">
          <button onclick="editCategory(event,'${escHTML(cat)}')" style="padding:2px 6px;background:var(--bg3);border:1px solid var(--border);color:var(--accent);cursor:pointer;font-family:var(--font-family);font-size:9px">RENAME</button>
          <button onclick="deleteCategory(event,'${escHTML(cat)}')" style="padding:2px 6px;background:var(--danger);border:1px solid var(--border);color:#fff;cursor:pointer;font-family:var(--font-family);font-size:9px">DEL</button>
        </div>
      </div>
      <div class="cat-links open">
        ${items.map((l,i) => `
          <div style="display:flex;align-items:center;gap:4px;padding:4px;border:1px solid var(--border);background:var(--bg3);margin:4px;cursor:move" draggable="true" ondragstart="startDragLink(event,'${escHTML(cat)}',${i})" ondragover="dragOverLink(event)" ondrop="dropLink(event,'${escHTML(cat)}',${i})">
            <span style="flex:1;color:var(--fg);font-size:10px">${escHTML(l.name)}</span>
            <button onclick="editLink(event,'${escHTML(cat)}',${i})" style="padding:2px 6px;background:var(--bg3);border:1px solid var(--border);color:var(--accent);cursor:pointer;font-family:var(--font-family);font-size:9px;white-space:nowrap">EDIT</button>
            <button onclick="delLink(event,'${escHTML(cat)}',${i})" style="padding:2px 6px;background:var(--danger);border:1px solid var(--border);color:#fff;cursor:pointer;font-family:var(--font-family);font-size:9px">√ó</button>
          </div>
        `).join('')}
      </div>
    `;
    scroll.appendChild(div);
  }
}

function startDragLink(e, cat, idx) {
  draggedItem = {cat, idx};
  e.dataTransfer.effectAllowed = 'move';
}

function dragOverLink(e) {
  e.preventDefault();
  e.dataTransfer.dropEffect = 'move';
}

function dropLink(e, dropCat, dropIdx) {
  e.preventDefault();
  if (!draggedItem) return;
  const links = getLinks();
  const {cat: dragCat, idx: dragIdx} = draggedItem;
  if (dragCat === dropCat && dragIdx === dropIdx) return;
  
  const link = links[dragCat][dragIdx];
  links[dragCat].splice(dragIdx, 1);
  if (!links[dropCat]) links[dropCat] = [];
  links[dropCat].splice(dropIdx, 0, link);
  setLinks(links);
  draggedItem = null;
}

function editLink(e, cat, idx) {
  e.preventDefault(); e.stopPropagation();
  const links = getLinks();
  const link = links[cat][idx];
  dialogMode = 'edit-link';
  dialogCat = cat;
  document.getElementById('dialog-title').textContent = 'EDIT LINK';
  document.getElementById('dialog-fields').innerHTML = `
    <div class="dialog-field">
      <label>NAME</label>
      <input type="text" id="d-name" value="${escHTML(link.name)}" placeholder="My Site">
    </div>
    <div class="dialog-field">
      <label>URL</label>
      <input type="url" id="d-url" value="${escHTML(link.url)}" placeholder="https://...">
    </div>
  `;
  document.getElementById('dialog-confirm').textContent = 'UPDATE';
  openDialog();
}

function editCategory(e, oldCat) {
  e.preventDefault(); e.stopPropagation();
  const newCat = prompt('RENAME CATEGORY:', oldCat);
  if (!newCat || newCat === oldCat) return;
  const links = getLinks();
  if (links[newCat]) { showToast('CATEGORY EXISTS'); return; }
  links[newCat] = links[oldCat];
  delete links[oldCat];
  setLinks(links);
}

function deleteCategory(e, cat) {
  e.preventDefault(); e.stopPropagation();
  if (!confirm('DELETE CATEGORY "' + cat + '" AND ALL LINKS?')) return;
  const links = getLinks();
  delete links[cat];
  setLinks(links);
  renderLinksEditMode(links);
}

function toggleCat(header, cat) {
  const linksDiv = header.nextElementSibling;
  const arrow = header.querySelector('.cat-arrow');
  const isOpen = linksDiv.classList.toggle('open');
  arrow.classList.toggle('open', isOpen);
  header.classList.toggle('active', isOpen);
  localStorage.setItem('cat:open:' + cat, isOpen);
}

function getLinks() {
  return JSON.parse(localStorage.getItem('settings:links') || DEFAULTS['settings:links']);
}

function setLinks(links) {
  localStorage.setItem('settings:links', JSON.stringify(links));
  renderLinks(links);
}

function delLink(e, cat, idx) {
  e.preventDefault(); e.stopPropagation();
  const links = getLinks();
  if (links[cat]) {
    links[cat].splice(idx, 1);
    if (links[cat].length === 0) delete links[cat];
    setLinks(links);
  }
}

let dialogMode = null, dialogCat = null;
function openAddLink() {
  dialogMode = 'link';
  document.getElementById('dialog-title').textContent = '+ ADD LINK';
  const links = getLinks();
  const cats = Object.keys(links);
  document.getElementById('dialog-fields').innerHTML = `
    <div class="dialog-field">
      <label>CATEGORY</label>
      <select id="d-cat" style="width:100%">
        ${cats.map(c => `<option value="${escHTML(c)}">${escHTML(c)}</option>`).join('')}
      </select>
    </div>
    <div class="dialog-field">
      <label>NAME</label>
      <input type="text" id="d-name" placeholder="My Site">
    </div>
    <div class="dialog-field">
      <label>URL</label>
      <input type="url" id="d-url" placeholder="https://...">
    </div>
  `;
  document.getElementById('dialog-overlay').classList.add('open');
  setTimeout(() => document.getElementById('d-name').focus(), 100);
}

function openAddCat() {
  dialogMode = 'cat';
  document.getElementById('dialog-title').textContent = '+ NEW CATEGORY';
  document.getElementById('dialog-fields').innerHTML = `
    <div class="dialog-field">
      <label>CATEGORY NAME</label>
      <input type="text" id="d-catname" placeholder="MY LINKS">
    </div>
  `;
  document.getElementById('dialog-overlay').classList.add('open');
  setTimeout(() => document.getElementById('d-catname').focus(), 100);
}

function confirmDialog() {
  const links = getLinks();
  if (dialogMode === 'link') {
    const cat = document.getElementById('d-cat').value;
    const name = document.getElementById('d-name').value.trim();
    const url = document.getElementById('d-url').value.trim();
    if (!name || !url) { showToast('NAME AND URL REQUIRED'); return; }
    if (!links[cat]) links[cat] = [];
    links[cat].push({name, url});
    setLinks(links);
    showToast('LINK ADDED');
  } else if (dialogMode === 'cat') {
    const catname = document.getElementById('d-catname').value.trim().toUpperCase();
    if (!catname) { showToast('CATEGORY NAME REQUIRED'); return; }
    if (!links[catname]) links[catname] = [];
    setLinks(links);
    showToast('CATEGORY CREATED');
  }
  closeDialog();
}

function closeDialog() {
  document.getElementById('dialog-overlay').classList.remove('open');
}

// ============================================================
// SEARCH
// ============================================================
function toggleEngineMenu() {
  const menu = document.getElementById('search-engine-menu');
  const btn = document.getElementById('search-engine-btn');
  const isOpen = menu.classList.toggle('open');
  btn.setAttribute('aria-expanded', isOpen);
}

function selectEngine(el) {
  currentSearchEngine = {url: el.dataset.url, label: el.dataset.label};
  document.getElementById('search-engine-btn').textContent = el.dataset.label;
  document.querySelectorAll('.eng-opt').forEach(e => e.classList.remove('active'));
  el.classList.add('active');
  document.getElementById('search-engine-menu').classList.remove('open');
  document.getElementById('search-engine-btn').setAttribute('aria-expanded', 'false');
}

function doSearch() {
  const q = document.getElementById('search-input').value.trim();
  if (!q) return;
  const target = localStorage.getItem('settings:searchTarget') || 'new';
  const method = target === 'same' ? '_self' : '_blank';
  window.open(currentSearchEngine.url + encodeURIComponent(q), method, target === 'new' ? 'noopener' : '');
  document.getElementById('search-input').value = '';
}

document.addEventListener('click', (e) => {
  const menu = document.getElementById('search-engine-menu');
  if (menu.classList.contains('open') && !e.target.closest('#search-engine-btn') && !e.target.closest('#search-engine-menu')) {
    menu.classList.remove('open');
    document.getElementById('search-engine-btn').setAttribute('aria-expanded', 'false');
  }
});

// ============================================================
// SETTINGS MODAL
// ============================================================
function openSettings() {
  populateSettingsUI();
  document.getElementById('settings-modal').classList.add('open');
  document.getElementById('settings-unsaved-msg').textContent = 'CHANGES PREVIEW ONLY ‚Äî SAVE TO APPLY';
}

function closeSettings() {
  // Preserve music playback state
  const wasPlaying = !bgAudio.paused;
  const currentTime = bgAudio.currentTime;
  
  document.getElementById('settings-modal').classList.remove('open');
  loadSettings(); // revert previews
  
  // Restore playback
  if (wasPlaying) {
    bgAudio.currentTime = currentTime;
    bgAudio.play().catch(() => {});
  }
}

function switchSettingsTab(tab) {
  document.querySelectorAll('#settings-tabs .stab').forEach(t => t.classList.toggle('active', t.dataset.tab === tab));
  document.querySelectorAll('#settings-body .tab-pane').forEach(p => p.classList.toggle('active', p.id === 'tab-' + tab));
}

function resetSelected() {
  const cats = ['display','stats','media','advanced','links','notes'];
  let count = 0;
  for (const cat of cats) {
    const el = document.getElementById('r-' + cat);
    if (el && el.checked) {
      for (const key of (RESET_KEYS[cat] || [])) {
        if (DEFAULTS[key] !== undefined) localStorage.setItem(key, DEFAULTS[key]);
        else localStorage.removeItem(key);
      }
      count++;
    }
  }
  if (count === 0) { showToast('SELECT CATEGORIES TO RESET'); return; }
  loadSettings();
  populateSettingsUI();
  showToast('RESET COMPLETE');
}

function exportSettings() {
  const data = {};
  for (let i = 0; i < localStorage.length; i++) {
    const k = localStorage.key(i);
    data[k] = localStorage.getItem(k);
  }
  const blob = new Blob([JSON.stringify(data, null, 2)], {type:'application/json'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = 'sys-home-settings.json';
  a.click();
}

function importSettings() {
  const input = document.createElement('input');
  input.type = 'file'; input.accept = '.json';
  input.onchange = (e) => {
    const file = e.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = (ev) => {
      try {
        const data = JSON.parse(ev.target.result);
        for (const [k, v] of Object.entries(data)) localStorage.setItem(k, v);
        loadSettings();
        populateSettingsUI();
        showToast('SETTINGS IMPORTED');
      } catch(err) { showToast('IMPORT FAILED: INVALID JSON'); }
    };
    reader.readAsText(file);
  };
  input.click();
}

function clearSWCache() {
  if ('caches' in window) {
    caches.keys().then(keys => Promise.all(keys.map(k => caches.delete(k)))).then(() => showToast('CACHE CLEARED'));
  } else { showToast('SW CACHE NOT AVAILABLE'); }
}

function refreshSWCache() {
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.getRegistrations().then(regs => {
      regs.forEach(r => r.update());
      showToast('SW UPDATE TRIGGERED');
    });
  } else { showToast('NO SERVICE WORKER'); }
}

// ============================================================
// NOTES
// ============================================================
const notesTA = document.getElementById('notes-textarea');
let notesDebounce = null;
notesTA.addEventListener('input', () => {
  clearTimeout(notesDebounce);
  notesDebounce = setTimeout(() => {
    localStorage.setItem('notes:content', notesTA.value);
    updateNotesCount();
  }, 500);
});

function updateNotesCount() {
  const len = document.getElementById('notes-textarea').value.length;
  document.getElementById('notes-count').textContent = len + ' CHARS';
}

// ============================================================
// MUSIC PLAYER
// ============================================================

// --- state ---
let archivePlaylist = [];     // [{name, url, track, format}, ...]
let currentTrackIdx = -1;
let currentFormat = '';
let allArchiveFiles = [];     // raw files from metadata
let archiveIdentifier = '';

// --- url/filename metadata guessing ---
function guessTrackMeta(url) {
  try {
    // decode all percent-encoding
    let raw = decodeURIComponent(url.split('/').pop().split('?')[0]);
    // strip extension
    raw = raw.replace(/\.[a-zA-Z0-9]{2,5}$/, '');
    // replace underscores/dashes/dots with spaces
    raw = raw.replace(/[_\.]+/g, ' ').replace(/\s+/g, ' ').trim();
    // strip leading track numbers like "01 " or "01 - "
    raw = raw.replace(/^\d{1,3}[\s\-\.]+/, '');
    // if pattern "Artist - Title" already present, capitalize nicely
    if (raw.includes(' - ')) {
      const parts = raw.split(' - ');
      return parts.map(p => titleCase(p.trim())).join(' ‚Äî ');
    }
    return titleCase(raw);
  } catch(e) {
    return url.split('/').pop() || url;
  }
}

function titleCase(str) {
  const minor = new Set(['a','an','the','and','but','or','nor','in','on','at','to','for','of','by','with']);
  return str.split(' ').map((w, i) =>
    (i === 0 || !minor.has(w.toLowerCase()))
      ? w.charAt(0).toUpperCase() + w.slice(1).toLowerCase()
      : w.toLowerCase()
  ).join(' ');
}

// --- archive.org helpers ---
function getArchiveIdentifier(url) {
  // handles both https://archive.org/details/ID and https://archive.org/download/ID[/file]
  // and https://*.archive.org/...
  const m = url.match(/archive\.org\/(?:details|download)\/([^\/\?]+)/);
  return m ? m[1] : null;
}

async function fetchArchiveMetadata(identifier) {
  const resp = await fetch(`https://archive.org/metadata/${identifier}`, {signal: AbortSignal.timeout(15000)});
  if (!resp.ok) throw new Error('Archive metadata fetch failed: ' + resp.status);
  return resp.json();
}

function buildArchiveDownloadUrl(identifier, filename) {
  return `https://archive.org/download/${identifier}/${encodeURIComponent(filename)}`;
}

function detectFormats(files) {
  // audio extensions we care about
  const audioExts = ['mp3','flac','ogg','opus','m4a','aac','wav','wma'];
  const fmts = new Set();
  for (const f of files) {
    const ext = f.name.split('.').pop().toLowerCase();
    if (audioExts.includes(ext)) fmts.add(ext);
  }
  return [...fmts].sort();
}

function filterTracksByFormat(files, fmt) {
  const audioExts = ['mp3','flac','ogg','opus','m4a','aac','wav','wma'];
  // exclude spectrograms and derived/metadata files
  const excludePatterns = /spectrogram|_vbr\.|\.sqlite|\.torrent|\.xml|\.json|\.sha1|__ia_thumb|\.jpg|\.jpeg|\.png|\.gif|\.pdf|\.txt|\.nfo|\.cue|\.log/i;
  return files
    .filter(f => {
      const ext = f.name.split('.').pop().toLowerCase();
      return ext === fmt && !excludePatterns.test(f.name);
    })
    .sort((a, b) => {
      // sort by track number if present, else by name
      const ta = parseInt((a.name.match(/^(\d{1,3})[^0-9]/) || [])[1] || '999');
      const tb = parseInt((b.name.match(/^(\d{1,3})[^0-9]/) || [])[1] || '999');
      return ta !== tb ? ta - tb : a.name.localeCompare(b.name);
    });
}

function findAlbumArt(files, identifier) {
  // priority order: cover_itemimage.*, cover.*, front.*
  const artPatterns = [
    /cover_itemimage\.(jpg|jpeg|png)/i,
    /^cover\.(jpg|jpeg|png)/i,
    /^front\.(jpg|jpeg|png)/i,
    /folder\.(jpg|jpeg|png)/i,
    /album\.(jpg|jpeg|png)/i
  ];
  const imgFiles = files.filter(f => /\.(jpg|jpeg|png)$/i.test(f.name));
  for (const pat of artPatterns) {
    const found = imgFiles.find(f => pat.test(f.name));
    if (found) return buildArchiveDownloadUrl(identifier, found.name);
  }
  // fallback: any image that doesn't look like a spectrogram
  const noSpec = imgFiles.find(f => !/spectrogram|waveform|_thumb/i.test(f.name));
  if (noSpec) return buildArchiveDownloadUrl(identifier, noSpec.name);
  return null;
}

async function loadArchiveAlbum(url) {
  const identifier = getArchiveIdentifier(url);
  if (!identifier) {
    showToast('NOT AN ARCHIVE.ORG URL');
    return false;
  }

  // show loading spinner
  const playlistTracks = document.getElementById('playlist-tracks');
  playlistTracks.innerHTML = '<div class="playlist-loading"><div class="playlist-spinner"></div></div>';

  // check cache first
  const cacheKey = 'archive:' + identifier;
  const cached = localStorage.getItem(cacheKey);
  const cacheTs = localStorage.getItem(cacheKey + ':ts');
  const now = Date.now();
  const cacheMaxAge = 24 * 60 * 60 * 1000; // 24 hours
  let meta;
  
  if (cached && cacheTs) {
    try {
      const age = now - parseInt(cacheTs);
      if (age < cacheMaxAge) {
        meta = JSON.parse(cached);
      } else {
        // cache expired
        localStorage.removeItem(cacheKey);
        localStorage.removeItem(cacheKey + ':ts');
        meta = null;
      }
    } catch(e) {
      localStorage.removeItem(cacheKey);
      localStorage.removeItem(cacheKey + ':ts');
      showToast('CACHE CORRUPTED, REFETCHING...');
      meta = null;
    }
  }
  
  if (!meta) {
    showToast('‚¨á FETCHING ARCHIVE METADATA...');
    try {
      meta = await fetchArchiveMetadata(identifier);
      // cache it + enforce LRU (max 3 archives)
      localStorage.setItem(cacheKey, JSON.stringify(meta));
      localStorage.setItem(cacheKey + ':ts', Date.now().toString());
      pruneArchiveCache();
    } catch(e) {
      showToast('ARCHIVE FETCH FAILED ‚Äî CHECK URL');
      console.warn('archive fetch error:', e.message);
      playlistTracks.innerHTML = '<div style="padding:8px;color:var(--dim);font-size:10px">FETCH FAILED</div>';
      return false;
    }
  } else {
    showToast('‚úì LOADED FROM CACHE');
  }

  const files = meta.files || [];
  
  if (!files.length) {
    showToast('NO FILES IN ARCHIVE');
    playlistTracks.innerHTML = '<div style="padding:8px;color:var(--dim);font-size:10px">NO FILES</div>';
    return false;
  }

  allArchiveFiles = files;
  archiveIdentifier = identifier;

  // if loading a new archive (different identifier), reset track to 0
  const prevIdentifier = localStorage.getItem('settings:lastArchiveIdentifier');
  if (prevIdentifier !== identifier) {
    localStorage.setItem('settings:currentTrackIdx', '0');
  }
  localStorage.setItem('settings:lastArchiveIdentifier', identifier);

  // detect and pick default format
  const formats = detectFormats(files);
  if (!formats.length) {
    showToast('NO AUDIO FILES FOUND IN ARCHIVE');
    playlistTracks.innerHTML = '<div style="padding:8px;color:var(--dim);font-size:10px">NO AUDIO</div>';
    return false;
  }

  // prefer mp3, then ogg, then first available
  const preferred = ['mp3','ogg','opus','m4a','flac','wav'];
  currentFormat = preferred.find(f => formats.includes(f)) || formats[0];

  // check for cached album art first
  const cachedArtUrl = localStorage.getItem('archive-art:' + identifier);
  if (cachedArtUrl) {
    setAlbumArt(cachedArtUrl);
  } else {
    // album art
    const artUrl = findAlbumArt(files, identifier);
    setAlbumArt(artUrl);
    // cache album art
    localStorage.setItem('archive-art:' + identifier, artUrl);
  }

  // build format dropdown
  buildFormatSelector(formats, currentFormat);

  // build playlist for selected format
  buildPlaylistForFormat(currentFormat, identifier);

  // restore saved track index if it exists
  const savedTrackIdx = parseInt(localStorage.getItem('settings:currentTrackIdx') || '0');
  const trackToLoad = Math.min(savedTrackIdx, archivePlaylist.length - 1);

  // start playing first track
  if (archivePlaylist.length) {
    loadTrack(trackToLoad, false);
  }
  return true;
}

function pruneArchiveCache() {
  // find all archive caches (keys like "archive:identifier")
  const archiveCaches = [];
  for (let i = 0; i < localStorage.length; i++) {
    const key = localStorage.key(i);
    if (key && key.startsWith('archive:') && !key.endsWith(':ts')) {
      archiveCaches.push(key);
    }
  }
  
  // if more than 3, remove oldest (order is insertion, so first = oldest)
  if (archiveCaches.length > 3) {
    const toDelete = archiveCaches.length - 3;
    for (let i = 0; i < toDelete; i++) {
      const key = archiveCaches[i];
      const identifier = key.replace('archive:', '');
      localStorage.removeItem(key);
      localStorage.removeItem(key + ':ts');
      localStorage.removeItem('archive-art:' + identifier); // clean up paired art cache
    }
  }
}

function buildFormatSelector(formats, selected) {
  const sel = document.getElementById('playlist-format-select');
  sel.innerHTML = formats.map(f =>
    `<option value="${f}"${f === selected ? ' selected' : ''}>${f.toUpperCase()}</option>`
  ).join('');
  sel.style.display = formats.length > 1 ? '' : 'none';
}

function buildPlaylistForFormat(fmt, identifier) {
  const tracks = filterTracksByFormat(allArchiveFiles, fmt);
  archivePlaylist = tracks.map((f, i) => ({
    name: guessTrackMeta(f.name),
    url: buildArchiveDownloadUrl(identifier, f.name),
    track: i + 1,
    rawName: f.name
  }));
  renderPlaylist();
}

function switchFormat(fmt) {
  currentFormat = fmt;
  const wasPlaying = !bgAudio.paused;
  buildPlaylistForFormat(fmt, archiveIdentifier);
  if (archivePlaylist.length) loadTrack(0, wasPlaying);
}

function renderPlaylist() {
  const container = document.getElementById('playlist-tracks');
  if (!archivePlaylist.length) {
    container.innerHTML = '<div style="padding:8px;font-family:var(--font-mono);font-size:10px;color:var(--dim)">NO TRACKS</div>';
    return;
  }
  const isPlaying = !bgAudio.paused;
  container.innerHTML = archivePlaylist.map((t, i) => `
    <div class="playlist-track${i === currentTrackIdx ? ' active' : ''}" 
         onclick="loadTrack(${i}, ${isPlaying})">
      <span class="playlist-track-num">${String(t.track).padStart(2,'0')}</span>
      <span style="overflow:hidden;text-overflow:ellipsis;flex:1">${escHTML(t.name)}</span>
      <span class="playlist-track-del" onclick="removePlaylistTrack(event,${i})">√ó</span>
    </div>
  `).join('');
}

function removePlaylistTrack(e, idx) {
  e.stopPropagation();
  archivePlaylist.splice(idx, 1);
  // renumber
  archivePlaylist.forEach((t, i) => t.track = i + 1);
  if (currentTrackIdx >= idx) currentTrackIdx = Math.max(0, currentTrackIdx - 1);
  renderPlaylist();
}

function loadTrack(idx, shouldPlay) {
  if (idx < 0 || idx >= archivePlaylist.length) return;
  currentTrackIdx = idx;
  localStorage.setItem('settings:currentTrackIdx', idx);
  const t = archivePlaylist[idx];
  
  const wasPlaying = !bgAudio.paused;
  
  bgAudio.src = t.url;
  bgAudio.load();
  document.getElementById('music-title').textContent = t.name;
  renderPlaylist();
  
  // same mechanism autoplay uses: just call play() after load
  // if track was playing before switch, keep it playing
  // if autoplay is on, play it
  const autoplayEnabled = localStorage.getItem('settings:musicAutoplay') === 'true';
  if ((wasPlaying || autoplayEnabled) && bgAudio.paused) {
    bgAudio.play().catch(() => {});
  }
}

function setAlbumArt(url) {
  const img = document.getElementById('music-art');
  if (!url) {
    img.classList.remove('visible');
    img.src = '';
    return;
  }
  img.onload = () => img.classList.add('visible');
  img.onerror = () => { img.classList.remove('visible'); img.src = ''; };
  img.src = url;
}

function togglePlaylist() {
  const pl = document.getElementById('music-playlist');
  pl.classList.toggle('open');
}

function prevTrack() {
  if (!archivePlaylist.length) return;
  const idx = currentTrackIdx <= 0 ? archivePlaylist.length - 1 : currentTrackIdx - 1;
  loadTrack(idx, !bgAudio.paused);
}

function nextTrack() {
  if (!archivePlaylist.length) return;
  const idx = currentTrackIdx >= archivePlaylist.length - 1 ? 0 : currentTrackIdx + 1;
  loadTrack(idx, !bgAudio.paused);
}

// auto-advance on track end (when archive playlist loaded)
bgAudio.addEventListener('ended', () => {
  document.getElementById('music-play-btn').textContent = '‚ñ∂';
  document.getElementById('music-title').classList.remove('playing');
  if (archivePlaylist.length && !bgAudio.loop) {
    const next = currentTrackIdx + 1;
    if (next < archivePlaylist.length) {
      loadTrack(next, true);
    }
  }
});

function promptLoadArchive() {
  const url = prompt('ARCHIVE.ORG URL OR DIRECT MP3 URL:');
  if (!url) return;
  handleMusicUrl(url.trim());
}

async function handleMusicUrl(url) {
  if (!url) return;
  const isArchivePage = /archive\.org\/(details|download)\/[^\/\?]+\/?$/.test(url) ||
                        /archive\.org\/(details|download)\/[^\/]+\/$/.test(url);
  const isDirectMp3 = /\.(mp3|ogg|flac|opus|m4a|aac|wav)(\?|$)/i.test(url);
  const isArchiveFile = /archive\.org\/download\/[^\/]+\/.+\.(mp3|ogg|flac|opus|m4a|aac|wav)/i.test(url);

  if (isArchivePage || (isArchiveFile && !isDirectMp3)) {
    // treat as full album
    await loadArchiveAlbum(url);
  } else if (isArchiveFile || isDirectMp3) {
    // single track ‚Äî check if it's from archive and load siblings
    if (isArchiveFile && getArchiveIdentifier(url)) {
      await loadArchiveAlbum(url);
    } else {
      // plain mp3 url
      archivePlaylist = [];
      currentTrackIdx = -1;
      setAlbumArt(null);
      bgAudio.src = url;
      document.getElementById('music-title').textContent = guessTrackMeta(url);
      bgAudio.play().catch(() => {});
    }
  } else {
    // try archive anyway
    if (getArchiveIdentifier(url)) {
      await loadArchiveAlbum(url);
    } else {
      showToast('UNRECOGNIZED URL FORMAT');
    }
  }
}

bgAudio.addEventListener('timeupdate', () => {
  if (bgAudio.duration) {
    const pct = (bgAudio.currentTime / bgAudio.duration) * 100;
    document.getElementById('music-progress-fill').style.width = pct + '%';
  }
});

bgAudio.addEventListener('play', () => {
  document.getElementById('music-play-btn').textContent = '‚è∏';
  document.getElementById('music-title').classList.add('playing');
});

bgAudio.addEventListener('pause', () => {
  document.getElementById('music-play-btn').textContent = '‚ñ∂';
  document.getElementById('music-title').classList.remove('playing');
});

function toggleMusic() {
  if (!bgAudio.src || bgAudio.src === window.location.href) {
    showToast('NO AUDIO ‚Äî USE ‚¨á LOAD OR SET URL IN SETTINGS > MEDIA'); return;
  }
  if (bgAudio.paused) bgAudio.play();
  else bgAudio.pause();
}

function toggleLoop() {
  bgAudio.loop = !bgAudio.loop;
  document.getElementById('music-loop-btn').classList.toggle('active', bgAudio.loop);
  localStorage.setItem('settings:musicLoop', bgAudio.loop ? 'true' : 'false');
}

function setVolume(v) {
  bgAudio.volume = parseFloat(v);
  localStorage.setItem('settings:musicVol', Math.round(v * 100));
}

function seekMusic(e) {
  if (!bgAudio.duration) return;
  const bar = document.getElementById('music-progress-bar');
  const rect = bar.getBoundingClientRect();
  const pct = (e.clientX - rect.left) / rect.width;
  bgAudio.currentTime = pct * bgAudio.duration;
}

// close playlist on outside click
document.addEventListener('click', (e) => {
  const pl = document.getElementById('music-playlist');
  if (pl.classList.contains('open') &&
      !e.target.closest('#music-playlist') &&
      !e.target.closest('#music-title') &&
      !e.target.closest('#music-art')) {
    pl.classList.remove('open');
  }
});

// ============================================================
// TOAST
// ============================================================
let toastTimeout = null;
function showToast(msg) {
  const el = document.getElementById('toast');
  el.textContent = msg;
  el.classList.add('show');
  clearTimeout(toastTimeout);
  toastTimeout = setTimeout(() => el.classList.remove('show'), 2500);
}

// ============================================================
// NUCLEAR ERASE
// ============================================================
const NUKE_PRESETS = {
  default: {
    title: 'INITIATING SYSTEM WIPE',
    desc: 'THIS OPERATION WILL PERMANENTLY DESTROY:\nALL SETTINGS ¬∑ ALL LINKS ¬∑ ALL NOTES\nALL CACHED DATA ¬∑ ALL STORED KEYS\n\nTHIS CANNOT BE UNDONE.\nYOU HAVE BEEN WARNED.'
  },
  creepypasta: {
    title: 'YOU SHOULDN\'T HAVE FOUND THIS',
    desc: 'it knows what you\'re about to do.\nit has been watching since you opened this page.\nyou cannot delete it. you can only delete yourself.\n\nIT WILL REMEMBER.\nEVEN AFTER YOU\'RE GONE.'
  },
  arg: {
    title: 'SEQUENCE ALPHA-SEVEN INITIATED',
    desc: 'AUTHORIZATION REQUIRED: LEVEL 5 CLEARANCE\nTARGET: ALL LOCAL INSTANCE DATA\nCOMMAND: TOTAL WIPE PROTOCOL\nISSUED BY: [REDACTED]\n\nCORROBORATE WITH SECONDARY SYSTEM.\n[AWAITING VOICE CONFIRMATION]'
  },
  bsod: {
    title: 'A PROBLEM HAS BEEN DETECTED',
    desc: 'FATAL_SYSTEM_ERROR (0x0000007B)\n\nDRIVE_INITIALIZATION_FAILED\nMEMORY_MANAGEMENT\nKERNEL_DATA_INPAGE_ERROR\n\nIf this is the first time you\'ve seen this\nerror screen then restart your system.\nOtherwise, contact your system administrator.'
  },
  loop: {
    title: '‚ñà‚ñà‚ñà‚ñà‚ñà CONFIRM ‚ñà‚ñà‚ñà‚ñà',
    desc: 'press ok to continue\n\npress ok to continue\n\npress ok to continue\n\npress ok to continue\n\n[LOOP DETECTED ‚Äî SYSTEM UNRESPONSIVE]'
  }
};

// Synthesized siren using Web Audio API
let sirenCtx = null, sirenNodes = [];
function startSynthSiren() {
  try {
    sirenCtx = new (window.AudioContext || window.webkitAudioContext)();
    const gainNode = sirenCtx.createGain();
    gainNode.gain.setValueAtTime(0.4, sirenCtx.currentTime);
    gainNode.connect(sirenCtx.destination);

    function oneCycle(startTime) {
      const osc = sirenCtx.createOscillator();
      osc.type = 'sawtooth';
      osc.frequency.setValueAtTime(440, startTime);
      osc.frequency.linearRampToValueAtTime(880, startTime + 0.6);
      osc.frequency.linearRampToValueAtTime(440, startTime + 1.2);
      osc.connect(gainNode);
      osc.start(startTime);
      osc.stop(startTime + 1.2);
      sirenNodes.push(osc);
    }
    // Queue 60 cycles (~72 seconds of coverage)
    for (let i = 0; i < 60; i++) oneCycle(sirenCtx.currentTime + i * 1.2);
  } catch(e) {}
}
function stopSynthSiren() {
  sirenNodes.forEach(n => { try { n.stop(); } catch(e) {} });
  sirenNodes = [];
  if (sirenCtx) { sirenCtx.close().catch(() => {}); sirenCtx = null; }
}

const PRESET_CLASSES = ['preset-bsod','preset-creepypasta','preset-arg','preset-loop'];

function openNuke() {
  const modal = document.getElementById('nuke-modal');
  // Apply preset styling
  PRESET_CLASSES.forEach(c => modal.classList.remove(c));
  if (nukePreset !== 'default') modal.classList.add('preset-' + nukePreset);

  const preset = NUKE_PRESETS[nukePreset] || NUKE_PRESETS.default;
  document.getElementById('nuke-title').textContent = preset.title;
  document.getElementById('nuke-desc').innerHTML = preset.desc
    .replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;')
    .replace(/\n/g, '<br>');
  document.getElementById('nuke-confirm-input').value = '';
  document.getElementById('nuke-go').disabled = true;
  modal.classList.add('open');

  // Siren: custom URL takes priority, else synthesize
  const sirenUrl = localStorage.getItem('settings:sirenUrl') || '';
  if (sirenUrl) {
    sirenAudio.src = sirenUrl;
    sirenAudio.loop = true;
    sirenAudio.volume = 0.6;
    sirenAudio.play().catch(() => {});
    nukeAudioPlaying = true;
  } else {
    startSynthSiren();
    nukeAudioPlaying = true;
  }
  // Mute background audio instead of stopping it
  const bgWasPlaying = !bgAudio.paused;
  bgAudio.dataset.wasPlaying = bgWasPlaying;
  bgAudio.dataset.prevVolume = bgAudio.volume;
  bgAudio.volume = 0;
}

function closeNuke() {
  const modal = document.getElementById('nuke-modal');
  modal.classList.remove('open');
  PRESET_CLASSES.forEach(c => modal.classList.remove(c));
  sirenAudio.pause();
  sirenAudio.currentTime = 0;
  stopSynthSiren();
  nukeAudioPlaying = false;
  // Restore background audio volume
  bgAudio.volume = parseFloat(bgAudio.dataset.prevVolume || '0.7');
}

function checkNukeConfirm() {
  const val = document.getElementById('nuke-confirm-input').value;
  document.getElementById('nuke-go').disabled = val.toUpperCase() !== 'ERASE';
}

function executeNuke() {
  if (document.getElementById('nuke-confirm-input').value.toUpperCase() !== 'ERASE') return;
  // Clear everything
  localStorage.clear();
  if ('caches' in window) caches.keys().then(keys => keys.forEach(k => caches.delete(k)));
  if ('serviceWorker' in navigator) navigator.serviceWorker.getRegistrations().then(regs => regs.forEach(r => r.unregister()));
  sirenAudio.pause();
  stopSynthSiren();
  // Full reload to reset state
  document.getElementById('nuke-modal').classList.remove('open');
  setTimeout(() => {
    document.body.innerHTML = '<div style="position:fixed;inset:0;background:#000;display:flex;align-items:center;justify-content:center;flex-direction:column;font-family:monospace;color:#cc0000"><div style="font-size:32px;animation:spin 1s linear infinite">‚ò¢</div><div style="margin-top:20px;font-size:16px;letter-spacing:0.2em">SYSTEM WIPED</div><div style="margin-top:8px;font-size:11px;color:#664444;letter-spacing:0.1em">RELOADING...</div></div><style>@keyframes spin{to{transform:rotate(360deg)}}</style>';
    setTimeout(() => location.reload(), 2000);
  }, 500);
}

function applyNukePreset(val) {
  nukePreset = val;
  localStorage.setItem('settings:nukePreset', val);
  const presetDescs = {
    default: 'Standard nuclear warning. Clinical and direct.',
    creepypasta: 'Paranoid horror narrative. It watches.',
    arg: 'Alternate reality game / classified document style.',
    bsod: 'Blue Screen of Death parody. Fake system error.',
    loop: 'Glitchy confirmation loop. Interface breaks down.'
  };
  document.getElementById('nuke-preset-desc').textContent = presetDescs[val] || '';
}

// ============================================================
// SETTINGS MODAL TITLE EDIT
// ============================================================
document.getElementById('sys-title').addEventListener('dblclick', () => {
  const t = prompt('PAGE TITLE:', document.getElementById('sys-title').textContent);
  if (t !== null) {
    localStorage.setItem('settings:pageTitle', t || 'SYS//HOME');
    loadSettings();
  }
});

// ============================================================
// DEBUG PANEL
// ============================================================
// Secret unlock: Ctrl+Shift+D OR long press on stats bar (3s)
document.addEventListener('keydown', (e) => {
  if (e.ctrlKey && e.shiftKey && e.key === 'D') {
    e.preventDefault();
    openDebug();
  }
});

const statsBar = document.getElementById('stats-bar');
statsBar.addEventListener('touchstart', (e) => {
  longPressTimer = setTimeout(() => {
    navigator.vibrate && navigator.vibrate([100, 50, 200]);
    openDebug();
  }, 3000);
}, {passive: true});
statsBar.addEventListener('touchend', () => clearTimeout(longPressTimer));
statsBar.addEventListener('touchmove', () => clearTimeout(longPressTimer));

function openDebug() {
  debugUnlocked = true;
  document.getElementById('debug-panel').classList.add('open');
  switchDebugTab('sysinfo');
  populateDebugSysinfo();
  startFPS();
}

function closeDebug() {
  document.getElementById('debug-panel').classList.remove('open');
  stopFPS();
}

function switchDebugTab(tab) {
  document.querySelectorAll('#debug-tabs .dtab').forEach(t => t.classList.toggle('active', t.dataset.dtab === tab));
  document.querySelectorAll('#debug-body .dtab-pane').forEach(p => p.classList.toggle('active', p.id === 'dtab-' + tab));
  if (tab === 'storage') refreshLSEditor();
  if (tab === 'perf') startFPS();
  if (tab === 'nuke-config') {
    const su = document.getElementById('s-siren-url');
    if (su) su.value = localStorage.getItem('settings:sirenUrl') || '';
  }
}

function saveDebugSettings() {
  const sirenUrl = document.getElementById('s-siren-url').value;
  const nukePresetSelect = document.querySelector('#dtab-nuke-config select[onchange*="applyNukePreset"]');
  localStorage.setItem('settings:sirenUrl', sirenUrl);
  if (nukePresetSelect) {
    localStorage.setItem('settings:nukePreset', nukePresetSelect.value);
  }
  loadSettings();
  showToast('üíæ DEBUG SETTINGS SAVED');
}

function populateDebugSysinfo() {
  const el = document.getElementById('dtab-sysinfo');
  const rows = [
    ['USER AGENT', navigator.userAgent],
    ['VIEWPORT', window.innerWidth + ' √ó ' + window.innerHeight],
    ['TIMEZONE', Intl.DateTimeFormat().resolvedOptions().timeZone],
    ['LOCALE', navigator.language],
    ['ONLINE', navigator.onLine ? 'YES' : 'NO'],
    ['COOKIES', navigator.cookieEnabled ? 'ENABLED' : 'DISABLED'],
    ['DEVICE MEM', navigator.deviceMemory ? navigator.deviceMemory + 'GB' : 'N/A'],
    ['CPU CORES', navigator.hardwareConcurrency || 'N/A'],
    ['PLATFORM', navigator.platform || 'N/A'],
    ['TOUCH', ('ontouchstart' in window) ? 'YES (' + navigator.maxTouchPoints + ' pts)' : 'NO'],
    ['PIXEL RATIO', window.devicePixelRatio],
    ['COLOR DEPTH', screen.colorDepth + 'bit'],
    ['SCREEN', screen.width + ' √ó ' + screen.height],
    ['PAGE LOADED', new Date().toISOString()],
    ['LS ENTRIES', localStorage.length],
    ['SW', ('serviceWorker' in navigator && navigator.serviceWorker.controller) ? 'ACTIVE' : 'INACTIVE']
  ];
  el.innerHTML = '<div class="debug-section-title">SYSTEM INFORMATION</div>' +
    rows.map(([k,v]) => `<div class="debug-row"><span class="debug-key">${k}</span><span class="debug-val">${v}</span></div>`).join('');
}

function refreshLSEditor() {
  const data = {};
  for (let i = 0; i < localStorage.length; i++) {
    const k = localStorage.key(i);
    data[k] = localStorage.getItem(k);
  }
  document.getElementById('ls-editor').value = JSON.stringify(data, null, 2);
}

function saveLS() {
  try {
    const data = JSON.parse(document.getElementById('ls-editor').value);
    localStorage.clear();
    for (const [k,v] of Object.entries(data)) localStorage.setItem(k, v);
    loadSettings();
    showToast('LS WRITTEN ‚Äî SETTINGS RELOADED');
  } catch(e) { showToast('JSON PARSE ERROR: ' + e.message); }
}

function clearErrors() {
  errorLog = [];
  document.getElementById('error-log').innerHTML = '<span style="color:#444">LOG CLEARED</span>';
}

// Populate errors on tab open
document.querySelector('[data-dtab="errors"]').addEventListener('click', () => {
  const el = document.getElementById('error-log');
  if (errorLog.length === 0) { el.innerHTML = '<span style="color:#444">NO ERRORS LOGGED</span>'; return; }
  el.innerHTML = errorLog.map(e => `<div class="${e.type==='error'?'error-entry':'warn-entry'}">[${new Date(e.t).toLocaleTimeString()}] ${escHTML(e.msg)}</div>`).join('');
});

let fpsActive = false;
function startFPS() {
  if (fpsActive) return;
  fpsActive = true;
  let last = performance.now(), frames = 0;
  const loop = (now) => {
    if (!fpsActive) return;
    frames++;
    if (now - last >= 1000) {
      document.getElementById('fps-display').textContent = frames + ' FPS';
      const mem = performance.memory;
      if (mem) {
        document.getElementById('mem-display').textContent = 
          `HEAP: ${(mem.usedJSHeapSize/1048576).toFixed(1)}MB / ${(mem.jsHeapSizeLimit/1048576).toFixed(1)}MB`;
      }
      frames = 0; last = now;
    }
    fpsRaf = requestAnimationFrame(loop);
  };
  fpsRaf = requestAnimationFrame(loop);
}

function stopFPS() {
  fpsActive = false;
  if (fpsRaf) cancelAnimationFrame(fpsRaf);
}

// ============================================================
// SERVICE WORKER (inline blob)
// ============================================================
const SW_CODE = `
const CACHE_NAME = 'resource-cache-v1';
const SKIP = ['googleapis.com'];
self.addEventListener('install', e => { self.skipWaiting(); });
self.addEventListener('activate', e => { e.waitUntil(self.clients.claim()); });
self.addEventListener('fetch', e => {
  if (e.request.method !== 'GET') return;
  if (SKIP.some(s => e.request.url.includes(s))) return;
  e.respondWith(
    fetch(e.request).then(r => {
      const clone = r.clone();
      caches.open(CACHE_NAME).then(c => c.put(e.request, clone));
      return r;
    }).catch(() => caches.match(e.request))
  );
});
`;

if ('serviceWorker' in navigator) {
  const blob = new Blob([SW_CODE], {type: 'application/javascript'});
  navigator.serviceWorker.register(URL.createObjectURL(blob), {scope: '/'}).catch(() => {});
}

// ============================================================
// UTILITIES
// ============================================================
function escHTML(str) {
  return String(str).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#39;');
}

// ============================================================
// KEYBOARD SHORTCUTS
// ============================================================
document.addEventListener('keydown', (e) => {
  if (e.key === 'Escape') {
    closeSettings();
    closeDialog();
    closeDebug();
  }
  if (e.ctrlKey && e.key === ',') { e.preventDefault(); openSettings(); }
});

// ============================================================
// ANDROID CHROME REC-BLINK FIX (RAF override for stalled steps animation)
// ============================================================
function initAndroidBlinkFix() {
  const ua = navigator.userAgent;
  const isAndroidChrome = /Android.*Chrome/.test(ua);
  if (!isAndroidChrome) return;
  
  const dot = document.querySelector('.rec-dot');
  if (!dot) return;
  
  let rafId = null;
  let state = true;
  
  const override = () => {
    state = !state;
    dot.style.opacity = state ? '1' : '0';
    rafId = setTimeout(override, 500);
  };
  
  override();
}

// ============================================================
// INIT
// ============================================================
document.addEventListener('DOMContentLoaded', () => {
  if (!checkFirstRun()) {
    // first run and permissions unchecked‚Äîblock loadSettings until confirmed
    updateAllPermissionButtons();
  } else {
    // permissions already checked‚Äîproceed normally
    loadSettings();
    initServices();
  }
  initAndroidBlinkFix();
});
</script>
</body>
</html>
