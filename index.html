<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
<meta name="description" content="Retro gaming homepage for Anbernic RG Slide" />
<meta name="theme-color" content="#070707" />
<link rel="icon" type="image/svg+xml" href="favicon.svg">
<title id="pagetitle">System Home</title>
<style>
    :root {
        --fg: #cfcfcf;
        --bg: #070707;
        --accent: #7a7a7a;
        --dim: #444;
        --effect-intensity: 1;
        --font-family: system-ui, sans-serif;
    }
    
    body[data-font="terminal"] {
        --font-family: 'Courier New', 'Consolas', 'Monaco', monospace;
    }

    [data-theme="light"] {
        --fg: #111;
        --bg: #f5f5f5;
        --accent: #666;
        --dim: #bbb;
    }

    html, body {
        margin: 0;
        padding: 0;
        background: var(--bg);
        color: var(--fg);
        font-family: var(--font-family);
        height: 100%;
        overflow: hidden;
        transition: background 0.3s, color 0.3s, font-family 0.3s;
    }

    body::before {
        content: "";
        position: fixed;
        inset: 0;
        pointer-events: none;
        background: repeating-linear-gradient(to bottom, rgba(255,255,255,0.03) 0px, rgba(255,255,255,0.03) 1px, transparent 2px, transparent 4px);
        mix-blend-mode: overlay;
        opacity: calc(0.35 * var(--effect-intensity));
        z-index: 9999;
    }

    /* Screen Effects */
    body[data-effect="crt"] .container::before,
    body[data-effect="arcade"] .container::before,
    body[data-effect="scanlines"] .container::before {
        content: "";
        position: fixed;
        inset: 0;
        pointer-events: none;
        background: repeating-linear-gradient(
            to bottom,
            rgba(0, 0, 0, 0) 0px,
            rgba(0, 0, 0, 0) 2px,
            rgba(0, 0, 0, calc(0.3 * var(--effect-intensity))) 2px,
            rgba(0, 0, 0, calc(0.3 * var(--effect-intensity))) 3px
        );
        z-index: 9998;
    }

    body[data-effect="arcade"] .container::before {
        background: repeating-linear-gradient(
            to bottom,
            rgba(0, 0, 0, 0) 0px,
            rgba(0, 0, 0, 0) 1px,
            rgba(0, 0, 0, calc(0.5 * var(--effect-intensity))) 1px,
            rgba(0, 0, 0, calc(0.5 * var(--effect-intensity))) 2px
        );
    }

    body[data-effect="crt"] .container::after,
    body[data-effect="arcade"] .container::after {
        content: "";
        position: fixed;
        inset: 0;
        pointer-events: none;
        border-radius: 8px;
        box-shadow: inset 0 0 calc(100px * var(--effect-intensity)) rgba(0, 0, 0, calc(0.3 * var(--effect-intensity)));
        z-index: 9997;
    }

    body[data-effect="arcade"] .container::after {
        border-radius: 12px;
        box-shadow: inset 0 0 calc(150px * var(--effect-intensity)) rgba(0, 0, 0, calc(0.5 * var(--effect-intensity)));
    }

    /* VHS Effect */
    body[data-effect="vhs"] .container::before {
        content: "";
        position: fixed;
        inset: 0;
        pointer-events: none;
        background: 
            repeating-linear-gradient(
                to bottom,
                transparent 0px,
                transparent 2px,
                rgba(255, 0, 0, calc(0.08 * var(--effect-intensity))) 2px,
                rgba(255, 0, 0, calc(0.08 * var(--effect-intensity))) 3px,
                transparent 3px,
                transparent 5px,
                rgba(0, 255, 0, calc(0.08 * var(--effect-intensity))) 5px,
                rgba(0, 255, 0, calc(0.08 * var(--effect-intensity))) 6px
            );
        z-index: 9998;
        animation: vhsTracking 0.1s infinite;
        opacity: var(--effect-intensity);
    }

    @keyframes vhsTracking {
        0% { transform: translateY(0px); }
        100% { transform: translateY(calc(3px * var(--effect-intensity))); }
    }

    body[data-effect="vhs"] .container::after {
        content: "";
        position: fixed;
        inset: 0;
        pointer-events: none;
        background: linear-gradient(to bottom, transparent 0%, rgba(0, 0, 0, calc(0.2 * var(--effect-intensity))) 50%, transparent 100%);
        z-index: 9997;
        animation: vhsRoll 8s linear infinite;
        opacity: var(--effect-intensity);
    }

    @keyframes vhsRoll {
        0% { transform: translateY(-100%); }
        100% { transform: translateY(100%); }
    }

    /* Game Boy LCD Effect */
    body[data-effect="gameboy"] .container::before {
        content: "";
        position: fixed;
        inset: 0;
        pointer-events: none;
        background: 
            repeating-linear-gradient(
                to right,
                rgba(0, 0, 0, calc(0.1 * var(--effect-intensity))) 0px,
                rgba(0, 0, 0, calc(0.1 * var(--effect-intensity))) 1px,
                transparent 1px,
                transparent 2px
            ),
            repeating-linear-gradient(
                to bottom,
                rgba(0, 0, 0, calc(0.1 * var(--effect-intensity))) 0px,
                rgba(0, 0, 0, calc(0.1 * var(--effect-intensity))) 1px,
                transparent 1px,
                transparent 2px
            );
        z-index: 9998;
    }

    body[data-effect="gameboy"] .container::after {
        content: "";
        position: fixed;
        inset: 0;
        pointer-events: none;
        background: 
            radial-gradient(ellipse at center, transparent 0%, rgba(50, 80, 50, calc(0.15 * var(--effect-intensity))) 100%),
            linear-gradient(to bottom, rgba(150, 200, 100, calc(0.05 * var(--effect-intensity))) 0%, rgba(100, 150, 80, calc(0.05 * var(--effect-intensity))) 100%);
        z-index: 9997;
    }

    /* Phosphor Glow Effect */
    body[data-effect="phosphor"] .container::before {
        content: "";
        position: fixed;
        inset: 0;
        pointer-events: none;
        background: radial-gradient(ellipse at center, transparent 0%, rgba(0, 255, 100, calc(0.1 * var(--effect-intensity))) 100%);
        z-index: 9998;
        animation: phosphorPulse 2s ease-in-out infinite;
        opacity: var(--effect-intensity);
    }

    @keyframes phosphorPulse {
        0%, 100% { opacity: calc(0.8 * var(--effect-intensity)); }
        50% { opacity: var(--effect-intensity); }
    }

    .container {
        padding: 24px;
        display: flex;
        flex-direction: column;
        height: 100vh;
        box-sizing: border-box;
        position: relative;
        background-size: cover;
        background-position: center;
        transition: background 0.3s;
        overflow: hidden;
    }

    .header {
        font-size: 16px;
        letter-spacing: 1px;
        opacity: 0.9;
        text-align: center;
        margin-bottom: 12px;
        flex-shrink: 0;
    }

    .stats {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 16px 20px;
        font-size: 14px;
        flex-shrink: 0;
        margin-bottom: 16px;
    }

    .stat { opacity: 0.95; }
    .label { color: var(--accent); }

    .stat-refresh-btn {
        background: none;
        border: none;
        color: var(--accent);
        font-size: 14px;
        cursor: pointer;
        padding: 0 4px;
        opacity: 0.6;
        transition: opacity 0.2s;
        margin-left: 4px;
    }

    .stat-refresh-btn:hover {
        opacity: 1;
    }

    .stat-refresh-btn:active {
        transform: rotate(180deg);
    }

    .search-bar {
        display: flex;
        justify-content: center;
        align-items: center;
        margin-bottom: 16px;
        width: 100%;
        gap: 8px;
        flex-shrink: 0;
    }

    .search-bar-wrapper {
        display: flex;
        width: 100%;
        max-width: 500px;
        gap: 8px;
        align-items: center;
    }

    .search-engine-selector {
        padding: 4px 8px;
        font-size: 14px;
        height: 32px;
        background: var(--bg);
        color: var(--fg);
        border: 1px solid var(--dim);
        outline: none;
        border-radius: 4px;
        cursor: pointer;
        min-width: 110px;
        transition: background 0.3s, border 0.3s;
        font-family: var(--font-family);
    }

    body[data-transparent-fields="true"] .search-engine-selector {
        background: transparent;
        border-color: transparent;
    }

    body[data-transparent-fields="true"] .search-engine-selector:focus {
        background: rgba(0, 0, 0, 0.2);
        border-color: var(--accent);
    }

    .search-bar form {
        flex: 1;
        display: flex;
    }

    .search-bar input {
        width: 100%;
        padding: 4px 8px;
        font-size: 16px;
        height: 32px;
        background: var(--bg);
        color: var(--fg);
        border: 1px solid var(--dim);
        outline: none;
        border-radius: 4px;
        box-sizing: border-box;
        transition: background 0.3s, border 0.3s;
        font-family: var(--font-family);
    }

    body[data-transparent-fields="true"] .search-bar input {
        background: transparent;
        border-color: transparent;
    }

    body[data-transparent-fields="true"] .search-bar input:focus {
        background: rgba(0, 0, 0, 0.2);
        border-color: var(--accent);
    }

    .search-bar input::placeholder {
        color: var(--accent);
        opacity: 0.7;
    }

    .menu {
        display: flex;
        flex-direction: column;
        gap: 16px;
        font-size: 16px;
        width: 100%;
    }

    .content-columns {
        display: flex;
        gap: 16px;
        flex: 1;
        min-height: 0;
        max-height: calc(100% - 40px);
        align-items: stretch;
        overflow: hidden;
        margin-bottom: 40px;
    }

    .links-column {
        flex: 1;
        min-height: 0;
        overflow-y: auto;
        overflow-x: hidden;
        display: flex;
        flex-direction: column;
        gap: 16px;
    }

    .notes-column {
        flex: 1;
        min-height: 0;
        overflow-y: auto;
        overflow-x: hidden;
    }

    .link-category {
        display: flex;
        flex-direction: column;
        gap: 12px;
        margin-top: 0;
    }

    /* When links are in flat grid mode (no header), align with notes textarea */
    .link-category:only-child .category-links:only-child {
        margin-top: 33px; /* Height of notes header to align with textarea */
    }

    .category-header {
        display: flex;
        align-items: center;
        gap: 8px;
        cursor: pointer;
        padding: 4px 0;
        user-select: none;
        opacity: 0.9;
    }

    .category-header:hover {
        opacity: 1;
    }

    .category-arrow {
        font-size: 12px;
        transition: transform 0.2s;
        color: var(--accent);
    }

    .category-header.collapsed .category-arrow {
        transform: rotate(-90deg);
    }

    .category-title {
        font-size: 13px;
        letter-spacing: 0.5px;
        text-transform: uppercase;
        color: var(--accent);
    }

    .category-links {
        display: grid;
        gap: 12px;
    }

    .category-links.collapsed {
        display: none;
    }

    .menu a {
        color: var(--fg);
        text-decoration: none;
        font-size: inherit;
        padding: 6px 8px;
        white-space: nowrap;
        display: flex;
        justify-content: center;
        align-items: center;
        border-radius: 4px;
        border: 1px solid transparent;
    }

    .menu.bordered a { border-color: var(--dim); }

    .status-message {
        font-size: 12px;
        text-align: left;
        opacity: 0.7;
        position: absolute;
        top: 8px;
        left: 16px;
        z-index: 100;
        pointer-events: none;
    }

    .notes-section {
        display: flex;
        flex-direction: column;
        gap: 8px;
        height: 100%;
    }

    .notes-header {
        display: flex;
        align-items: center;
        gap: 8px;
        cursor: pointer;
        padding: 4px 0;
        user-select: none;
        opacity: 0.9;
        flex-shrink: 0;
    }

    .notes-header:hover {
        opacity: 1;
    }

    .notes-arrow {
        font-size: 12px;
        transition: transform 0.2s;
        color: var(--accent);
    }

    .notes-header.collapsed .notes-arrow {
        transform: rotate(-90deg);
    }

    .notes-title {
        font-size: 13px;
        letter-spacing: 0.5px;
        text-transform: uppercase;
        color: var(--accent);
    }

    .notes-content {
        display: flex;
        flex-direction: column;
        min-height: 0;
    }

    .notes-content.collapsed {
        display: none;
    }

    .notes-textarea {
        width: 100%;
        height: auto;
        min-height: 80px;
        max-height: none;
        padding: 8px;
        background: var(--bg);
        color: var(--fg);
        border: 1px solid var(--dim);
        border-radius: 4px;
        font-family: system-ui, monospace;
        font-size: 13px;
        resize: none;
        box-sizing: border-box;
        outline: none;
        -webkit-appearance: none;
        appearance: none;
        transition: background 0.3s, border 0.3s;
    }

    body[data-transparent-fields="true"] .notes-textarea {
        background: transparent;
        border-color: transparent;
    }

    body[data-transparent-fields="true"] .notes-textarea:focus {
        background: rgba(0, 0, 0, 0.2);
        border-color: var(--accent);
    }

    .notes-textarea:focus {
        border-color: var(--accent);
        outline: none;
    }

    .notes-textarea::placeholder {
        color: var(--accent);
        opacity: 0.6;
    }

    #settingsMenu {
        position: absolute;
        top: 40px;
        right: 16px;
        background: var(--bg);
        border: 1px solid var(--dim);
        padding: 0;
        display: none;
        flex-direction: column;
        width: 400px;
        max-height: 75vh;
        z-index: 200;
        border-radius: 4px;
    }

    .settings-tabs {
        display: flex;
        background: var(--dim);
        border-bottom: 1px solid var(--dim);
    }

    .settings-tab {
        flex: 1;
        padding: 8px 4px;
        text-align: center;
        cursor: pointer;
        font-size: 12px;
        border: none;
        background: transparent;
        color: var(--fg);
        opacity: 0.6;
        transition: opacity 0.2s;
    }

    .settings-tab.active {
        opacity: 1;
        background: var(--bg);
    }

    .settings-content {
        padding: 16px;
        overflow-y: auto;
        max-height: calc(75vh - 40px);
    }

    .settings-page {
        display: none;
        flex-direction: column;
        gap: 12px;
    }

    .settings-page.active {
        display: flex;
    }

    #settingsMenu label {
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-size: 13px;
        gap: 8px;
    }

    #settingsMenu input[type=text], 
    #settingsMenu input[type=number],
    #settingsMenu select {
        width: 55%;
        padding: 4px 6px;
        background: #111;
        color: #fff;
        border: 1px solid var(--dim);
        border-radius: 3px;
        font-size: 13px;
    }

    #settingsMenu input[type=range] {
        width: 55%;
    }

    #settingsMenu input[type=color] {
        width: 40px;
        height: 28px;
        padding: 2px;
        background: #111;
        border: 1px solid var(--dim);
        border-radius: 3px;
        cursor: pointer;
    }

    .color-input-group {
        display: flex;
        gap: 6px;
        width: 55%;
        align-items: center;
    }

    .color-text-input {
        flex: 1;
        padding: 4px 6px !important;
        background: #111 !important;
        color: #fff !important;
        border: 1px solid var(--dim) !important;
        border-radius: 3px;
        font-size: 12px !important;
        font-family: monospace;
        width: auto !important;
    }

    #settingsMenu button {
        padding: 6px 10px;
        background: var(--dim);
        color: #fff;
        border: none;
        cursor: pointer;
        border-radius: 4px;
        font-size: 13px;
    }

    .settings-section {
        margin-top: 12px;
        padding-top: 12px;
        border-top: 1px solid var(--dim);
    }

    .settings-section:first-child {
        margin-top: 0;
        padding-top: 0;
        border-top: none;
    }

    .section-title {
        font-size: 11px;
        color: var(--accent);
        margin-bottom: 8px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    #settingsBtn {
        position: absolute;
        top: 0;
        right: 0;
        cursor: pointer;
        padding: 4px 8px;
        font-size: 14px;
        background: none;
        border: none;
        color: var(--fg);
        z-index: 300;
    }

    /* Link editor styles - Android compatible */
    .link-editor-row {
        display: flex;
        flex-direction: column;
        gap: 4px;
        margin-bottom: 8px;
        padding-bottom: 8px;
        border-bottom: 1px solid var(--dim);
    }

    .link-editor-fields {
        display: flex;
        gap: 4px;
        align-items: stretch;
    }

    .link-editor-row input {
        flex: 1;
        padding: 6px 8px;
        background: #111 !important;
        color: #fff !important;
        border: 1px solid var(--dim) !important;
        border-radius: 3px;
        font-size: 14px !important;
        min-height: 32px;
        -webkit-appearance: none;
        appearance: none;
        box-sizing: border-box;
    }

    .link-editor-row input.category-input {
        font-size: 12px !important;
        opacity: 0.8;
    }

    .link-editor-row button {
        padding: 6px 10px;
        background: #933;
        color: #fff;
        border: none;
        cursor: pointer;
        border-radius: 3px;
        font-size: 13px;
        min-width: 40px;
    }

    /* Loading/Start Screen */
    #startScreen {
        position: fixed;
        inset: 0;
        background: var(--bg);
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        z-index: 10000;
        cursor: pointer;
        transition: opacity 0.5s ease-out;
    }

    #startScreen.hidden {
        opacity: 0;
        pointer-events: none;
    }

    .start-title {
        font-size: 48px;
        letter-spacing: 4px;
        margin-bottom: 32px;
        opacity: 0.9;
        font-family: var(--font-family);
    }

    .start-prompt {
        font-size: 20px;
        letter-spacing: 2px;
        opacity: 0.7;
        animation: pulse 2s ease-in-out infinite;
    }

    .start-subtitle {
        font-size: 14px;
        letter-spacing: 1px;
        opacity: 0.5;
        margin-top: 16px;
    }

    @keyframes pulse {
        0%, 100% { opacity: 0.7; }
        50% { opacity: 0.3; }
    }
</style>
</head>
<body data-theme="dark">
<!-- Start Screen -->
<div id="startScreen">
    <div class="start-title">STANDBY</div>
    <div class="start-prompt">‚ñ∂ ENGAGE</div>
    <div class="start-subtitle">Initializing sound drivers...</div>
</div>

<div class="container" id="mainContainer">
    <button id="settingsBtn">Settings</button>

    <div id="settingsMenu">
        <div class="settings-tabs">
            <button class="settings-tab active" data-tab="general">General</button>
            <button class="settings-tab" data-tab="display">Display</button>
            <button class="settings-tab" data-tab="links">Links</button>
            <button class="settings-tab" data-tab="advanced">Advanced</button>
        </div>
        
        <div class="settings-content">
            <!-- GENERAL TAB -->
            <div class="settings-page active" data-page="general">
                <label>Device Name: <input type="text" id="deviceName" placeholder="Game Console"></label>
                <label>Page Title: <input type="text" id="pageTitleInput" placeholder="System Home"></label>
                <label>Status Message: <input type="text" id="statusMessageText" placeholder="Ready"></label>
                <label>Default Search Engine: 
                    <select id="searchEngine">
                        <option value="google">Google</option>
                        <option value="duckduckgo">DuckDuckGo</option>
                        <option value="bing">Bing</option>
                        <option value="brave">Brave</option>
                        <option value="yandex">Yandex</option>
                        <option value="startpage">Startpage</option>
                    </select>
                </label>
                
                <div class="settings-section">
                    <div class="section-title">Audio</div>
                    <label>Ambience: 
                        <select id="ambienceType">
                            <option value="none">None (Silent)</option>
                            <option value="crt">CRT Hum</option>
                            <option value="tape">Tape Hiss</option>
                            <option value="arcade">Arcade Ambience</option>
                            <option value="rain">Rain/Static</option>
                        </select>
                    </label>
                    <label>Ambience Volume: <input type="range" id="ambienceVolume" min="0" max="100" value="30"></label>
                </div>
            </div>

            <!-- DISPLAY TAB -->
            <div class="settings-page" data-page="display">
                <div class="section-title">Themes</div>
                <div id="themesList" style="display: flex; flex-direction: column; gap: 8px; margin-bottom: 16px;"></div>
                <button id="saveThemeBtn" style="margin-bottom: 16px;">üíæ Save Current as Theme</button>
                
                <div class="settings-section">
                    <div class="section-title">Visual Settings</div>
                    <label>Font Style: 
                        <select id="fontStyle">
                            <option value="standard">Standard</option>
                            <option value="terminal">Terminal/Monospace</option>
                        </select>
                    </label>
                    <label>Background Image URL: <input type="text" id="bgImageUrl" placeholder="https://example.com/image.jpg"></label>
                    <label><input type="checkbox" id="themeToggle"> Light Mode</label>
                    <label><input type="checkbox" id="showStats" checked> Show All Status Indicators</label>
                    <label><input type="checkbox" id="showSearch" checked> Show Search Bar</label>
                    <label><input type="checkbox" id="showLinks" checked> Show Links Menu</label>
                    <label><input type="checkbox" id="showNotes" checked> Show Notes</label>
                    <label><input type="checkbox" id="toggleLinkBorders"> Show Link Borders</label>
                    <label><input type="checkbox" id="toggleTransparentFields"> Transparent Text Fields</label>
                    <label><input type="checkbox" id="showStartScreen" checked> Show Start Screen</label>
                </div>
                
                <div class="settings-section">
                    <div class="section-title">Screen Effects (Stack Multiple)</div>
                    <div id="activeEffectsList" style="display: flex; flex-direction: column; gap: 6px; margin-bottom: 8px;"></div>
                    <label>Add Effect: 
                        <select id="effectToAdd">
                            <option value="">-- Select Effect --</option>
                            <option value="crt">CRT Monitor</option>
                            <option value="arcade">Arcade CRT</option>
                            <option value="scanlines">Scanlines</option>
                            <option value="vhs">VHS Tape</option>
                            <option value="gameboy">Game Boy LCD</option>
                            <option value="phosphor">Phosphor Glow</option>
                        </select>
                    </label>
                    <button id="addEffectBtn" style="margin-top: 4px;">+ Add Effect</button>
                    <label>Effect Intensity: <input type="range" id="effectIntensity" min="0" max="200" value="100" step="10"></label>
                    <div style="font-size: 11px; opacity: 0.6; margin-top: -8px; text-align: right;">
                        <span id="effectIntensityValue">100%</span>
                    </div>
                </div>
                
                <div class="settings-section">
                    <div class="section-title">Individual Stats</div>
                    <label><input type="checkbox" id="statTime" checked> Time</label>
                    <label><input type="checkbox" id="statBattery" checked> Battery</label>
                    <label><input type="checkbox" id="statNetwork" checked> Network</label>
                    <label><input type="checkbox" id="statIP" checked> IP Address</label>
                    <label><input type="checkbox" id="statDL" checked> Downlink</label>
                    <label><input type="checkbox" id="statWeather"> Weather</label>
                    <label><input type="checkbox" id="statPing" checked> Ping</label>
                </div>
                
                <div class="settings-section">
                    <div class="section-title">Dark Theme Colors</div>
                    <label>Background: <span class="color-input-group"><input type="color" id="colorDarkBg" value="#070707"><input type="text" id="colorDarkBgText" class="color-text-input" maxlength="7" placeholder="#070707"></span></label>
                    <label>Text: <span class="color-input-group"><input type="color" id="colorDarkFg" value="#cfcfcf"><input type="text" id="colorDarkFgText" class="color-text-input" maxlength="7" placeholder="#cfcfcf"></span></label>
                    <label>Accent: <span class="color-input-group"><input type="color" id="colorDarkAccent" value="#7a7a7a"><input type="text" id="colorDarkAccentText" class="color-text-input" maxlength="7" placeholder="#7a7a7a"></span></label>
                    <label>Dim: <span class="color-input-group"><input type="color" id="colorDarkDim" value="#444444"><input type="text" id="colorDarkDimText" class="color-text-input" maxlength="7" placeholder="#444444"></span></label>
                </div>
                
                <div class="settings-section">
                    <div class="section-title">Light Theme Colors</div>
                    <label>Background: <span class="color-input-group"><input type="color" id="colorLightBg" value="#f5f5f5"><input type="text" id="colorLightBgText" class="color-text-input" maxlength="7" placeholder="#f5f5f5"></span></label>
                    <label>Text: <span class="color-input-group"><input type="color" id="colorLightFg" value="#111111"><input type="text" id="colorLightFgText" class="color-text-input" maxlength="7" placeholder="#111111"></span></label>
                    <label>Accent: <span class="color-input-group"><input type="color" id="colorLightAccent" value="#666666"><input type="text" id="colorLightAccentText" class="color-text-input" maxlength="7" placeholder="#666666"></span></label>
                    <label>Dim: <span class="color-input-group"><input type="color" id="colorLightDim" value="#bbbbbb"><input type="text" id="colorLightDimText" class="color-text-input" maxlength="7" placeholder="#bbbbbb"></span></label>
                    <button id="resetColors" style="font-size: 11px; padding: 4px 8px; opacity: 0.7; margin-top: 8px;">Reset Colors to Default</button>
                </div>
            </div>

            <!-- LINKS TAB -->
            <div class="settings-page" data-page="links">
                <label>Links per Row: <input type="number" id="linksPerRowInput" value="2" min="1" max="10"></label>
                <div class="settings-section">
                    <div class="section-title">Manage Links</div>
                    <div id="linksList" style="max-height: 300px; overflow-y: auto;"></div>
                    <button id="addLinkBtn">Add Link</button>
                </div>
            </div>

            <!-- ADVANCED TAB -->
            <div class="settings-page" data-page="advanced">
                <div class="section-title">Weather API</div>
                <label>API Key: <input type="text" id="weatherApiKey" placeholder="openweathermap.org key"></label>
                <label>Location: <span style="display:flex;gap:6px;width:55%"><input type="text" id="weatherLocation" placeholder="City or ZIP"><button type="button" id="weatherTestBtn">Test</button></span></label>
                
                <div class="settings-section">
                    <div class="section-title">Refresh Intervals (seconds)</div>
                    <label>Clock: <input type="number" id="refreshClock" value="1" min="1" max="60"></label>
                    <label>Battery: <input type="number" id="refreshBattery" value="60" min="10" max="600"></label>
                    <label>Network: <input type="number" id="refreshNetwork" value="3" min="1" max="60"></label>
                    <label>IP Address: <input type="number" id="refreshIP" value="300" min="60" max="3600"></label>
                    <label>Downlink: <input type="number" id="refreshDownlink" value="3" min="1" max="60"></label>
                    <label>Ping: <input type="number" id="refreshPing" value="30" min="5" max="300"></label>
                    <label>Weather: <input type="number" id="refreshWeather" value="600" min="60" max="3600"></label>
                </div>
                
                <div class="settings-section" style="display: flex; gap: 12px; align-items: flex-start;">
                    <div style="flex: 1;">
                        <button id="resetSettings" style="width: 100%;">Reset Settings to Default</button>
                    </div>
                    <div style="flex: 1; border: 2px solid #d32f2f; border-radius: 4px; padding: 8px;">
                        <div style="font-size: 11px; color: #d32f2f; font-weight: bold; margin-bottom: 4px;">‚ö†Ô∏è DANGER ZONE</div>
                        <button id="eraseDataBtn" style="background: #d32f2f; font-weight: bold; width: 100%; font-size: 12px;">üóëÔ∏è Erase All Data</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="header" id="headerTitle">System Home :: Game Console</div>

    <div class="stats" id="statsBar">
        <div class="stat" data-stat="time"><span class="label">TIME:</span> <span id="clock"></span></div>
        <div class="stat" data-stat="battery"><span class="label">BATTERY:</span> <span id="battery"></span></div>
        <div class="stat" data-stat="network"><span class="label">NET:</span> <span id="network"></span></div>
        <div class="stat" data-stat="ip"><span class="label">IP:</span> <span id="ip"></span></div>
        <div class="stat" data-stat="dl"><span class="label">DL:</span> <span id="downlink"></span></div>
        <div class="stat" data-stat="weather"><span class="label">WEATHER:</span> <span id="weather"></span></div>
        <div class="stat" data-stat="ping"><span class="label">PING:</span> <span id="ping"></span> <button class="stat-refresh-btn" id="pingRefreshBtn" title="Refresh Ping">‚Üª</button></div>
    </div>

    <div class="search-bar">
        <div class="search-bar-wrapper">
            <select class="search-engine-selector" id="currentSearchEngine">
                <option value="google">Google</option>
                <option value="duckduckgo">DuckDuckGo</option>
                <option value="bing">Bing</option>
                <option value="brave">Brave</option>
                <option value="yandex">Yandex</option>
                <option value="startpage">Startpage</option>
            </select>
            <form action="https://www.google.com/search" method="get" target="_blank">
                <input type="text" name="q" placeholder="Google Search..." />
            </form>
        </div>
    </div>

    <div class="content-columns">
        <div class="links-column">
            <div class="menu" id="linksMenu"></div>
        </div>

        <div class="notes-column">
            <div class="notes-section" id="notesSection">
                <div class="notes-header" id="notesHeader">
                    <span class="notes-arrow">‚ñº</span>
                    <span class="notes-title">Notes</span>
                </div>
                <div class="notes-content" id="notesContent">
                    <textarea class="notes-textarea" id="notesTextarea"></textarea>
                </div>
            </div>
        </div>
    </div>

    <div class="status-message" id="statusMessage">Ready</div>
</div>

<!-- Erase Data Confirmation Modal -->
<div id="eraseModal" style="display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 10001; align-items: center; justify-content: center;">
    <div style="background: var(--bg); border: 2px solid #d32f2f; border-radius: 8px; padding: 24px; max-width: 400px; text-align: center;">
        <div style="font-size: 20px; color: #d32f2f; margin-bottom: 16px;">‚ö†Ô∏è CONFIRM DATA ERASURE</div>
        <audio id="alarmSiren" loop>
            <source src="data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACAf4GAgYGCgoKDg4SEhISFhYWGhoaHh4eIiIiJiYmKioqLi4uMjIyNjY2Ojo6Pj4+QkJCRkZGSkpKTk5OUlJSVlZWWlpaXl5eYmJiZmZmampqbm5ucnJydnZ2enp6fn5+goKChoaGioqKjo6OkpKSlpaWmpqanp6eoqKipqamqqqqrq6usrKytra2urq6vr6+wsLCxsbGysrKzs7O0tLS1tbW2tra3t7e4uLi5ubm6urq7u7u8vLy9vb2+vr6/v7/AwMDBwcHCwsLDw8PExMTFxcXGxsbHx8fIyMjJycnKysrLy8vMzMzNzc3Ozs7Pz8/Q0NDR0dHS0tLT09PU1NTV1dXW1tbX19fY2NjZ2dna2trb29vc3Nzd3d3e3t7f39/g4ODh4eHi4uLj4+Pk5OTl5eXm5ubn5+fo6Ojp6enq6urr6+vs7Ozt7e3u7u7v7+/w8PDx8fHy8vLz8/P09PT19fX29vb39/f4+Pj5+fn6+vr7+/v8/Pz9/f3+/v7///8AAP//AAH/AQEC/wICA/8DAwT/BAQF/wUFBv8GBgf/BwcI/wgICP8JCQn/CgoK/wsLC/8MDAz/DQ0N/w4ODv8PDw//EBAQ/xEREf8SEhL/ExMT/xQUFP8VFRX/FhYW/xcXF/8YGBj/GRkZ/xoaGv8bGxv/HBwc/x0dHf8eHh7/Hx8f/yAgIP8hISH/IiIi/yMjI/8kJCT/JSUl/yYmJv8nJyf/KCgo/ykpKf8qKir/Kysr/ywsLP8tLS3/Li4u/y8vL/8wMDD/MTEx/zIyMv8zMzP/NDQ0/zU1Nf82Njb/Nzc3/zg4OP85OTn/Ojo6/zs7O/88PDz/PT09/z4+Pv8/Pz//QEBA/0FBQf9CQkL/Q0ND/0RERP9FRUX/RkZG/0dHR/9ISEj/SUlJ/0pKSv9LS0v/TExM/01NTf9OTk7/T09P/1BQUP9RUVH/UlJS/1NTU/9UVFT/VVVV/1ZWVv9XV1f/WFhY/1lZWf9aWlr/W1tb/1xcXP9dXV3/Xl5e/19fX/9gYGD/YWFh/2JiYv9jY2P/ZGRk/2VlZf9mZmb/Z2dn/2hoaP9paWn/ampq/2tra/9sbGz/bW1t/25ubv9vb2//cHBw/3Fxcf9ycnL/c3Nz/3R0dP91dXX/dnZ2/3d3d/94eHj/eXl5/3p6ev97e3v/fHx8/319ff9+fn7/f39//4CAgP+BgYH/goKC" type="audio/wav">
        </audio>
        <div style="font-size: 13px; margin-bottom: 16px; text-align: left;">
            This will <strong style="color: #d32f2f;">permanently delete</strong>:
            <ul style="margin: 8px 0; text-align: left;">
                <li>All settings and preferences</li>
                <li>All saved themes</li>
                <li>All notes content</li>
                <li>All custom links</li>
                <li>Category collapse states</li>
            </ul>
            <strong>This action cannot be undone.</strong>
        </div>
        <div style="font-size: 12px; margin-bottom: 12px; opacity: 0.8;">Type <code style="background: var(--dim); padding: 2px 6px; border-radius: 2px;">ERASE</code> to confirm:</div>
        <input type="text" id="eraseConfirmInput" style="width: 100%; padding: 8px; margin-bottom: 16px; background: var(--bg); color: var(--fg); border: 1px solid var(--dim); border-radius: 4px; text-align: center; font-size: 14px;" placeholder="Type ERASE">
        <div style="display: flex; gap: 8px;">
            <button id="eraseCancelBtn" style="flex: 1; padding: 8px; background: var(--dim); border: none; border-radius: 4px; cursor: pointer; color: var(--fg);">Cancel</button>
            <button id="eraseConfirmBtn" style="flex: 1; padding: 8px; background: #d32f2f; border: none; border-radius: 4px; cursor: pointer; color: #fff; font-weight: bold;" disabled>Erase All Data</button>
        </div>
    </div>
</div>

<script>
// LocalStorage helpers
function saveSetting(key, value) {
    localStorage.setItem(key, JSON.stringify(value));
}

function loadSetting(key, defaultValue) {
    const saved = localStorage.getItem(key);
    return saved !== null ? JSON.parse(saved) : defaultValue;
}

// Status Updates
function updateClock() {
    document.getElementById('clock').textContent = new Date().toLocaleTimeString();
}

function updateBattery() {
    if (!navigator.getBattery) {
        document.getElementById('battery').textContent = 'N/A';
        return;
    }
    navigator.getBattery().then(b => {
        document.getElementById('battery').textContent = `${Math.round(b.level * 100)}%`;
    });
}

function updateNetwork() {
    document.getElementById('network').textContent = navigator.onLine ? 'ONLINE' : 'OFFLINE';
}

function updateDownlink() {
    document.getElementById('downlink').textContent = navigator.connection?.downlink 
        ? `${navigator.connection.downlink} Mb/s` 
        : 'N/A';
}

async function updateIP() {
    const ipElement = document.getElementById('ip');
    // Try multiple IP services as fallbacks
    const services = [
        'https://api.ipify.org?format=json',
        'https://api64.ipify.org?format=json',
        'https://ipapi.co/json/'
    ];
    
    for (const service of services) {
        try {
            const response = await fetch(service);
            const data = await response.json();
            const ip = data.ip || data.IPv4 || data.query;
            if (ip) {
                ipElement.textContent = ip;
                return;
            }
        } catch (e) {
            console.log(`IP service ${service} failed:`, e);
            continue;
        }
    }
    ipElement.textContent = 'N/A';
}

async function updatePing() {
    const pingElement = document.getElementById('ping');
    const startTime = performance.now();
    try {
        // Ping Google's favicon specifically for consistency
        await fetch('https://www.google.com/favicon.ico', { 
            method: 'HEAD', 
            cache: 'no-cache',
            mode: 'no-cors'
        });
        const endTime = performance.now();
        const pingTime = Math.round(endTime - startTime);
        pingElement.textContent = `${pingTime}ms`;
    } catch (e) {
        console.log('Ping failed:', e);
        pingElement.textContent = 'N/A';
    }
}

async function updateWeather() {
    const apiKey = weatherApiKey.value.trim();
    let loc = weatherLocation.value.trim();
    const weatherElement = document.getElementById('weather');
    
    if (!apiKey || !loc) {
        weatherElement.textContent = 'N/A';
        return;
    }
    
    // Auto-append ",US" for 5-digit ZIP codes
    if (/^\d{5}$/.test(loc)) {
        loc = loc + ',US';
    }
    
    try {
        const url = `https://api.openweathermap.org/data/2.5/weather?q=${encodeURIComponent(loc)}&appid=${apiKey}&units=imperial`;
        console.log('Fetching weather from:', url);
        
        const res = await fetch(url);
        console.log('Weather response status:', res.status);
        
        if (!res.ok) {
            const errorData = await res.json().catch(() => ({}));
            console.error('Weather API error:', errorData);
            
            if (res.status === 401) {
                weatherElement.textContent = 'Bad API Key';
            } else if (res.status === 404) {
                weatherElement.textContent = 'Location Not Found';
            } else {
                weatherElement.textContent = `Error ${res.status}`;
            }
            return;
        }
        
        const data = await res.json();
        console.log('Weather data:', data);
        weatherElement.textContent = `${Math.round(data.main.temp)}¬∞F ${data.weather[0].main}`;
    } catch (e) {
        console.error('Weather fetch exception:', e);
        weatherElement.textContent = 'Fetch Failed';
    }
}

// Settings menu
const settingsBtn = document.getElementById('settingsBtn');
const settingsMenu = document.getElementById('settingsMenu');
settingsBtn.onclick = e => {
    e.stopPropagation();
    settingsMenu.style.display = settingsMenu.style.display === 'flex' ? 'none' : 'flex';
};
window.onclick = () => { settingsMenu.style.display = 'none'; };
settingsMenu.onclick = e => e.stopPropagation();

// Tab switching
document.querySelectorAll('.settings-tab').forEach(tab => {
    tab.onclick = () => {
        const targetPage = tab.dataset.tab;
        document.querySelectorAll('.settings-tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.settings-page').forEach(p => p.classList.remove('active'));
        tab.classList.add('active');
        document.querySelector(`[data-page="${targetPage}"]`).classList.add('active');
    };
});

// Elements
const headerTitle = document.getElementById('headerTitle');
const statusMessage = document.getElementById('statusMessage');
const pagetitle = document.getElementById('pagetitle');
const deviceNameInput = document.getElementById('deviceName');
const pageTitleInput = document.getElementById('pageTitleInput');
const statusMessageText = document.getElementById('statusMessageText');
const weatherApiKey = document.getElementById('weatherApiKey');
const weatherLocation = document.getElementById('weatherLocation');
const bgImageUrl = document.getElementById('bgImageUrl');
const linksPerRowInput = document.getElementById('linksPerRowInput');
const showStats = document.getElementById('showStats');
const showSearch = document.getElementById('showSearch');
const showLinks = document.getElementById('showLinks');
const showNotes = document.getElementById('showNotes');
const themeToggle = document.getElementById('themeToggle');
const toggleLinkBorders = document.getElementById('toggleLinkBorders');
const toggleTransparentFields = document.getElementById('toggleTransparentFields');
const showStartScreen = document.getElementById('showStartScreen');
const fontStyle = document.getElementById('fontStyle');
const effectToAdd = document.getElementById('effectToAdd');
const addEffectBtn = document.getElementById('addEffectBtn');
const activeEffectsList = document.getElementById('activeEffectsList');
const effectIntensity = document.getElementById('effectIntensity');
const effectIntensityValue = document.getElementById('effectIntensityValue');

// Audio elements
const ambienceType = document.getElementById('ambienceType');
const ambienceVolume = document.getElementById('ambienceVolume');
const statToggles = {
    time: document.getElementById('statTime'),
    battery: document.getElementById('statBattery'),
    network: document.getElementById('statNetwork'),
    ip: document.getElementById('statIP'),
    dl: document.getElementById('statDL'),
    weather: document.getElementById('statWeather'),
    ping: document.getElementById('statPing')
};
const linksList = document.getElementById('linksList');
const addLinkBtn = document.getElementById('addLinkBtn');
const resetSettingsBtn = document.getElementById('resetSettings');
const linksMenu = document.getElementById('linksMenu');
const mainContainer = document.getElementById('mainContainer');
const weatherTestBtn = document.getElementById('weatherTestBtn');
const searchEngine = document.getElementById('searchEngine');
const currentSearchEngine = document.getElementById('currentSearchEngine');
const searchForm = document.querySelector('.search-bar form');
const searchInput = document.querySelector('.search-bar input');

// Color picker elements
const colorDarkBg = document.getElementById('colorDarkBg');
const colorDarkBgText = document.getElementById('colorDarkBgText');
const colorDarkFg = document.getElementById('colorDarkFg');
const colorDarkFgText = document.getElementById('colorDarkFgText');
const colorDarkAccent = document.getElementById('colorDarkAccent');
const colorDarkAccentText = document.getElementById('colorDarkAccentText');
const colorDarkDim = document.getElementById('colorDarkDim');
const colorDarkDimText = document.getElementById('colorDarkDimText');
const colorLightBg = document.getElementById('colorLightBg');
const colorLightBgText = document.getElementById('colorLightBgText');
const colorLightFg = document.getElementById('colorLightFg');
const colorLightFgText = document.getElementById('colorLightFgText');
const colorLightAccent = document.getElementById('colorLightAccent');
const colorLightAccentText = document.getElementById('colorLightAccentText');
const colorLightDim = document.getElementById('colorLightDim');
const colorLightDimText = document.getElementById('colorLightDimText');
const resetColorsBtn = document.getElementById('resetColors');

// Refresh interval elements
const refreshClock = document.getElementById('refreshClock');
const refreshBattery = document.getElementById('refreshBattery');
const refreshNetwork = document.getElementById('refreshNetwork');
const refreshIP = document.getElementById('refreshIP');
const refreshDownlink = document.getElementById('refreshDownlink');
const refreshPing = document.getElementById('refreshPing');
const refreshWeather = document.getElementById('refreshWeather');

// Notes elements
const notesSection = document.getElementById('notesSection');
const notesHeader = document.getElementById('notesHeader');
const notesContent = document.getElementById('notesContent');
const notesTextarea = document.getElementById('notesTextarea');

// Ping refresh button
const pingRefreshBtn = document.getElementById('pingRefreshBtn');
let lastPingTime = 0;
if (pingRefreshBtn) {
    pingRefreshBtn.onclick = (e) => {
        e.stopPropagation();
        const now = Date.now();
        if (now - lastPingTime < 5000) {
            console.log('Ping cooldown active, wait 5 seconds');
            return;
        }
        lastPingTime = now;
        updatePing();
    };
}

// Weather test button
weatherTestBtn.onclick = () => {
    console.log('Testing weather with API Key:', weatherApiKey.value.substring(0, 8) + '...', 'Location:', weatherLocation.value);
    updateWeather();
};

// Effect intensity handler
function applyEffectIntensity() {
    const intensity = parseInt(effectIntensity.value) / 100;
    document.documentElement.style.setProperty('--effect-intensity', intensity);
    effectIntensityValue.textContent = effectIntensity.value + '%';
    saveSetting('effectIntensity', effectIntensity.value);
}

effectIntensity.oninput = applyEffectIntensity;

// Multi-effect system
let activeEffects = loadSetting('activeEffects', []);

function applyEffects() {
    // Build a combined data-effect attribute
    const effectString = activeEffects.join(' ');
    document.body.dataset.effect = effectString;
    saveSetting('activeEffects', activeEffects);
}

function renderActiveEffects() {
    activeEffectsList.innerHTML = '';
    
    if (activeEffects.length === 0) {
        const emptyMsg = document.createElement('div');
        emptyMsg.style.fontSize = '12px';
        emptyMsg.style.opacity = '0.6';
        emptyMsg.textContent = 'No effects active';
        activeEffectsList.appendChild(emptyMsg);
        return;
    }
    
    activeEffects.forEach((effect, index) => {
        const row = document.createElement('div');
        row.style.display = 'flex';
        row.style.justifyContent = 'space-between';
        row.style.alignItems = 'center';
        row.style.padding = '4px 8px';
        row.style.background = 'rgba(255,255,255,0.05)';
        row.style.borderRadius = '3px';
        
        const effectNames = {
            'crt': 'CRT Monitor',
            'arcade': 'Arcade CRT',
            'scanlines': 'Scanlines',
            'vhs': 'VHS Tape',
            'gameboy': 'Game Boy LCD',
            'phosphor': 'Phosphor Glow'
        };
        
        const label = document.createElement('span');
        label.textContent = effectNames[effect] || effect;
        label.style.fontSize = '13px';
        
        const removeBtn = document.createElement('button');
        removeBtn.textContent = '‚àí';
        removeBtn.style.padding = '2px 8px';
        removeBtn.style.fontSize = '16px';
        removeBtn.style.background = '#933';
        removeBtn.style.border = 'none';
        removeBtn.style.color = '#fff';
        removeBtn.style.cursor = 'pointer';
        removeBtn.style.borderRadius = '3px';
        removeBtn.onclick = () => {
            activeEffects.splice(index, 1);
            applyEffects();
            renderActiveEffects();
        };
        
        row.appendChild(label);
        row.appendChild(removeBtn);
        activeEffectsList.appendChild(row);
    });
}

addEffectBtn.onclick = () => {
    const effect = effectToAdd.value;
    if (!effect) {
        alert('Please select an effect to add');
        return;
    }
    
    if (activeEffects.includes(effect)) {
        alert('This effect is already active');
        return;
    }
    
    activeEffects.push(effect);
    applyEffects();
    renderActiveEffects();
    effectToAdd.value = '';
};

// Font style handler
function applyFontStyle() {
    document.body.dataset.font = fontStyle.value;
    saveSetting('fontStyle', fontStyle.value);
}

fontStyle.onchange = applyFontStyle;

// Themes System (renamed from Presets)
const builtinThemes = {
    'Silent Dark': {
        theme: 'dark',
        fontStyle: 'standard',
        bgImageUrl: '',
        toggleLinkBorders: false,
        toggleTransparentFields: false,
        showStartScreen: false,
        activeEffects: [],
        effectIntensity: 100,
        showStats: true,
        showSearch: true,
        showLinks: true,
        showNotes: true,
        statTime: true,
        statBattery: true,
        statNetwork: true,
        statIP: true,
        statDL: true,
        statWeather: false,
        statPing: true,
        colorDarkBg: '#070707',
        colorDarkFg: '#cfcfcf',
        colorDarkAccent: '#7a7a7a',
        colorDarkDim: '#444444',
        colorLightBg: '#f5f5f5',
        colorLightFg: '#111111',
        colorLightAccent: '#666666',
        colorLightDim: '#bbbbbb'
    },
    'CRT Terminal': {
        theme: 'dark',
        fontStyle: 'terminal',
        bgImageUrl: '',
        toggleLinkBorders: true,
        toggleTransparentFields: false,
        showStartScreen: true,
        activeEffects: ['scanlines'],
        effectIntensity: 150,
        showStats: true,
        showSearch: true,
        showLinks: true,
        showNotes: true,
        statTime: true,
        statBattery: true,
        statNetwork: true,
        statIP: true,
        statDL: true,
        statWeather: false,
        statPing: true,
        colorDarkBg: '#0a0a0a',
        colorDarkFg: '#00ff00',
        colorDarkAccent: '#00aa00',
        colorDarkDim: '#003300',
        colorLightBg: '#f5f5f5',
        colorLightFg: '#111111',
        colorLightAccent: '#666666',
        colorLightDim: '#bbbbbb'
    },
    'VHS Lounge': {
        theme: 'dark',
        fontStyle: 'standard',
        bgImageUrl: '',
        toggleLinkBorders: false,
        toggleTransparentFields: true,
        showStartScreen: true,
        activeEffects: ['vhs'],
        effectIntensity: 120,
        showStats: true,
        showSearch: true,
        showLinks: true,
        showNotes: true,
        statTime: true,
        statBattery: true,
        statNetwork: true,
        statIP: true,
        statDL: true,
        statWeather: false,
        statPing: true,
        colorDarkBg: '#070707',
        colorDarkFg: '#cfcfcf',
        colorDarkAccent: '#7a7a7a',
        colorDarkDim: '#444444',
        colorLightBg: '#f5f5f5',
        colorLightFg: '#111111',
        colorLightAccent: '#666666',
        colorLightDim: '#bbbbbb'
    },
    'Arcade Night': {
        theme: 'dark',
        fontStyle: 'standard',
        bgImageUrl: '',
        toggleLinkBorders: true,
        toggleTransparentFields: false,
        showStartScreen: true,
        activeEffects: ['arcade'],
        effectIntensity: 130,
        showStats: true,
        showSearch: true,
        showLinks: true,
        showNotes: true,
        statTime: true,
        statBattery: true,
        statNetwork: true,
        statIP: true,
        statDL: true,
        statWeather: false,
        statPing: true,
        colorDarkBg: '#0f0520',
        colorDarkFg: '#ff00ff',
        colorDarkAccent: '#00ffff',
        colorDarkDim: '#4a0f5f',
        colorLightBg: '#f5f5f5',
        colorLightFg: '#111111',
        colorLightAccent: '#666666',
        colorLightDim: '#bbbbbb'
    },
    'Clean Light': {
        theme: 'light',
        fontStyle: 'standard',
        bgImageUrl: '',
        toggleLinkBorders: false,
        toggleTransparentFields: false,
        showStartScreen: false,
        activeEffects: [],
        effectIntensity: 100,
        showStats: true,
        showSearch: true,
        showLinks: true,
        showNotes: true,
        statTime: true,
        statBattery: true,
        statNetwork: true,
        statIP: true,
        statDL: true,
        statWeather: false,
        statPing: true,
        colorDarkBg: '#070707',
        colorDarkFg: '#cfcfcf',
        colorDarkAccent: '#7a7a7a',
        colorDarkDim: '#444444',
        colorLightBg: '#f5f5f5',
        colorLightFg: '#111111',
        colorLightAccent: '#666666',
        colorLightDim: '#bbbbbb'
    }
};

function getDisplaySettings() {
    return {
        theme: themeToggle.checked ? 'light' : 'dark',
        fontStyle: fontStyle.value,
        bgImageUrl: bgImageUrl.value,
        toggleLinkBorders: toggleLinkBorders.checked,
        toggleTransparentFields: toggleTransparentFields.checked,
        showStartScreen: showStartScreen.checked,
        activeEffects: activeEffects,
        effectIntensity: effectIntensity.value,
        showStats: showStats.checked,
        showSearch: showSearch.checked,
        showLinks: showLinks.checked,
        showNotes: showNotes.checked,
        statTime: statToggles.time.checked,
        statBattery: statToggles.battery.checked,
        statNetwork: statToggles.network.checked,
        statIP: statToggles.ip.checked,
        statDL: statToggles.dl.checked,
        statWeather: statToggles.weather.checked,
        statPing: statToggles.ping.checked,
        colorDarkBg: colorDarkBg.value,
        colorDarkFg: colorDarkFg.value,
        colorDarkAccent: colorDarkAccent.value,
        colorDarkDim: colorDarkDim.value,
        colorLightBg: colorLightBg.value,
        colorLightFg: colorLightFg.value,
        colorLightAccent: colorLightAccent.value,
        colorLightDim: colorLightDim.value
    };
}

function applyTheme(theme) {
    // Apply all display settings from theme
    if (theme.theme !== undefined) themeToggle.checked = theme.theme === 'light';
    if (theme.fontStyle !== undefined) fontStyle.value = theme.fontStyle;
    if (theme.bgImageUrl !== undefined) bgImageUrl.value = theme.bgImageUrl;
    if (theme.toggleLinkBorders !== undefined) toggleLinkBorders.checked = theme.toggleLinkBorders;
    if (theme.toggleTransparentFields !== undefined) toggleTransparentFields.checked = theme.toggleTransparentFields;
    if (theme.showStartScreen !== undefined) showStartScreen.checked = theme.showStartScreen;
    if (theme.activeEffects !== undefined) activeEffects = theme.activeEffects;
    if (theme.effectIntensity !== undefined) effectIntensity.value = theme.effectIntensity;
    if (theme.showStats !== undefined) showStats.checked = theme.showStats;
    if (theme.showSearch !== undefined) showSearch.checked = theme.showSearch;
    if (theme.showLinks !== undefined) showLinks.checked = theme.showLinks;
    if (theme.showNotes !== undefined) showNotes.checked = theme.showNotes;
    if (theme.statTime !== undefined) statToggles.time.checked = theme.statTime;
    if (theme.statBattery !== undefined) statToggles.battery.checked = theme.statBattery;
    if (theme.statNetwork !== undefined) statToggles.network.checked = theme.statNetwork;
    if (theme.statIP !== undefined) statToggles.ip.checked = theme.statIP;
    if (theme.statDL !== undefined) statToggles.dl.checked = theme.statDL;
    if (theme.statWeather !== undefined) statToggles.weather.checked = theme.statWeather;
    if (theme.statPing !== undefined) statToggles.ping.checked = theme.statPing;
    if (theme.colorDarkBg !== undefined) {
        colorDarkBg.value = theme.colorDarkBg;
        colorDarkBgText.value = theme.colorDarkBg;
    }
    if (theme.colorDarkFg !== undefined) {
        colorDarkFg.value = theme.colorDarkFg;
        colorDarkFgText.value = theme.colorDarkFg;
    }
    if (theme.colorDarkAccent !== undefined) {
        colorDarkAccent.value = theme.colorDarkAccent;
        colorDarkAccentText.value = theme.colorDarkAccent;
    }
    if (theme.colorDarkDim !== undefined) {
        colorDarkDim.value = theme.colorDarkDim;
        colorDarkDimText.value = theme.colorDarkDim;
    }
    if (theme.colorLightBg !== undefined) {
        colorLightBg.value = theme.colorLightBg;
        colorLightBgText.value = theme.colorLightBg;
    }
    if (theme.colorLightFg !== undefined) {
        colorLightFg.value = theme.colorLightFg;
        colorLightFgText.value = theme.colorLightFg;
    }
    if (theme.colorLightAccent !== undefined) {
        colorLightAccent.value = theme.colorLightAccent;
        colorLightAccentText.value = theme.colorLightAccent;
    }
    if (theme.colorLightDim !== undefined) {
        colorLightDim.value = theme.colorLightDim;
        colorLightDimText.value = theme.colorLightDim;
    }
    
    // Apply effects and settings
    applyEffects();
    renderActiveEffects();
    applyEffectIntensity();
    applySettings();
    document.body.dataset.font = fontStyle.value;
}

function renderThemes() {
    const container = document.getElementById('themesList');
    const userThemes = loadSetting('userThemes', {});
    container.innerHTML = '';
    
    // Built-in themes
    Object.keys(builtinThemes).forEach(name => {
        const btn = document.createElement('button');
        btn.textContent = name;
        btn.style.padding = '8px 12px';
        btn.style.background = 'var(--dim)';
        btn.style.border = 'none';
        btn.style.borderRadius = '4px';
        btn.style.cursor = 'pointer';
        btn.style.color = 'var(--fg)';
        btn.style.fontSize = '13px';
        btn.onclick = () => applyTheme(builtinThemes[name]);
        container.appendChild(btn);
    });
    
    // User themes
    Object.keys(userThemes).forEach(name => {
        const row = document.createElement('div');
        row.style.display = 'flex';
        row.style.gap = '8px';
        
        const btn = document.createElement('button');
        btn.textContent = name;
        btn.style.flex = '1';
        btn.style.padding = '8px 12px';
        btn.style.background = 'var(--accent)';
        btn.style.border = 'none';
        btn.style.borderRadius = '4px';
        btn.style.cursor = 'pointer';
        btn.style.color = 'var(--fg)';
        btn.style.fontSize = '13px';
        btn.onclick = () => applyTheme(userThemes[name]);
        
        const deleteBtn = document.createElement('button');
        deleteBtn.textContent = 'üóëÔ∏è';
        deleteBtn.style.padding = '8px 12px';
        deleteBtn.style.background = '#933';
        deleteBtn.style.border = 'none';
        deleteBtn.style.borderRadius = '4px';
        deleteBtn.style.cursor = 'pointer';
        deleteBtn.style.fontSize = '13px';
        deleteBtn.onclick = () => {
            delete userThemes[name];
            saveSetting('userThemes', userThemes);
            renderThemes();
        };
        
        row.appendChild(btn);
        row.appendChild(deleteBtn);
        container.appendChild(row);
    });
}

document.getElementById('saveThemeBtn').onclick = () => {
    const name = prompt('Enter theme name:');
    if (!name || !name.trim()) return;
    
    const userThemes = loadSetting('userThemes', {});
    userThemes[name.trim()] = getDisplaySettings();
    saveSetting('userThemes', userThemes);
    renderThemes();
};

// Erase Data System with alarm
const eraseModal = document.getElementById('eraseModal');
const eraseConfirmInput = document.getElementById('eraseConfirmInput');
const eraseConfirmBtn = document.getElementById('eraseConfirmBtn');
const eraseCancelBtn = document.getElementById('eraseCancelBtn');
const eraseDataBtn = document.getElementById('eraseDataBtn');
const alarmSiren = document.getElementById('alarmSiren');

eraseConfirmInput.oninput = () => {
    eraseConfirmBtn.disabled = eraseConfirmInput.value !== 'ERASE';
};

eraseCancelBtn.onclick = () => {
    eraseModal.style.display = 'none';
    eraseConfirmInput.value = '';
    eraseConfirmBtn.disabled = true;
    alarmSiren.pause();
    alarmSiren.currentTime = 0;
};

eraseConfirmBtn.onclick = () => {
    alarmSiren.pause();
    localStorage.clear();
    window.location.replace(window.location.href.split('?')[0]);
};

// Erase button with Ctrl+Shift+Click bypass for sandbox
eraseDataBtn.addEventListener('click', (e) => {
    e.stopPropagation();
    
    // Ctrl+Shift+Click bypasses modal (for sandbox)
    if (e.ctrlKey && e.shiftKey) {
        localStorage.clear();
        window.location.replace(window.location.href.split('?')[0]);
        return;
    }
    
    // Show modal and play alarm
    eraseModal.style.display = 'flex';
    eraseConfirmInput.value = '';
    eraseConfirmBtn.disabled = true;
    alarmSiren.play().catch(() => {});
    setTimeout(() => eraseConfirmInput.focus(), 100);
});

// Close modal on outside click
eraseModal.onclick = (e) => {
    if (e.target === eraseModal) {
        eraseCancelBtn.click();
    }
};
let audioContext = null;
let ambienceNode = null;
let ambienceGain = null;

function initAudio() {
    if (!audioContext) {
        audioContext = new (window.AudioContext || window.webkitAudioContext)();
        if (audioContext.state === 'suspended') {
            audioContext.resume();
        }
    }
    return audioContext;
}

function stopAmbience() {
    if (ambienceNode) {
        try {
            if (ambienceNode.osc1) {
                ambienceNode.osc1.stop();
                ambienceNode.osc2.stop();
            } else if (ambienceNode.stop) {
                ambienceNode.stop();
            }
        } catch (e) {}
        ambienceNode = null;
    }
}

function startAmbience(type) {
    stopAmbience();
    if (type === 'none' || !type) return;
    
    const ctx = initAudio();
    
    if (!ambienceGain) {
        ambienceGain = ctx.createGain();
        ambienceGain.connect(ctx.destination);
    }
    
    const volume = parseFloat(ambienceVolume.value) / 100;
    ambienceGain.gain.value = volume;
    
    if (type === 'crt') {
        const osc = ctx.createOscillator();
        const filter = ctx.createBiquadFilter();
        osc.type = 'sine';
        osc.frequency.value = 60;
        filter.type = 'lowpass';
        filter.frequency.value = 200;
        osc.connect(filter);
        filter.connect(ambienceGain);
        osc.start();
        ambienceNode = osc;
        
    } else if (type === 'tape') {
        const bufferSize = 2 * ctx.sampleRate;
        const noiseBuffer = ctx.createBuffer(1, bufferSize, ctx.sampleRate);
        const output = noiseBuffer.getChannelData(0);
        for (let i = 0; i < bufferSize; i++) {
            output[i] = Math.random() * 2 - 1;
        }
        const whiteNoise = ctx.createBufferSource();
        whiteNoise.buffer = noiseBuffer;
        whiteNoise.loop = true;
        const filter = ctx.createBiquadFilter();
        filter.type = 'bandpass';
        filter.frequency.value = 3000;
        whiteNoise.connect(filter);
        filter.connect(ambienceGain);
        whiteNoise.start();
        ambienceNode = whiteNoise;
        
    } else if (type === 'arcade') {
        const osc1 = ctx.createOscillator();
        const osc2 = ctx.createOscillator();
        osc1.type = 'sine';
        osc2.type = 'square';
        osc1.frequency.value = 120;
        osc2.frequency.value = 240;
        const gain1 = ctx.createGain();
        const gain2 = ctx.createGain();
        gain1.gain.value = 0.3;
        gain2.gain.value = 0.1;
        osc1.connect(gain1);
        osc2.connect(gain2);
        gain1.connect(ambienceGain);
        gain2.connect(ambienceGain);
        osc1.start();
        osc2.start();
        ambienceNode = { osc1, osc2 };
        
    } else if (type === 'rain') {
        const bufferSize = 2 * ctx.sampleRate;
        const noiseBuffer = ctx.createBuffer(1, bufferSize, ctx.sampleRate);
        const output = noiseBuffer.getChannelData(0);
        let b0 = 0, b1 = 0, b2 = 0, b3 = 0, b4 = 0, b5 = 0, b6 = 0;
        for (let i = 0; i < bufferSize; i++) {
            const white = Math.random() * 2 - 1;
            b0 = 0.99886 * b0 + white * 0.0555179;
            b1 = 0.99332 * b1 + white * 0.0750759;
            b2 = 0.96900 * b2 + white * 0.1538520;
            b3 = 0.86650 * b3 + white * 0.3104856;
            b4 = 0.55000 * b4 + white * 0.5329522;
            b5 = -0.7616 * b5 - white * 0.0168980;
            output[i] = b0 + b1 + b2 + b3 + b4 + b5 + b6 + white * 0.5362;
            output[i] *= 0.11;
            b6 = white * 0.115926;
        }
        const pinkNoise = ctx.createBufferSource();
        pinkNoise.buffer = noiseBuffer;
        pinkNoise.loop = true;
        pinkNoise.connect(ambienceGain);
        pinkNoise.start();
        ambienceNode = pinkNoise;
    }
}

function updateAmbience() {
    startAmbience(ambienceType.value);
    saveSetting('ambienceType', ambienceType.value);
    saveSetting('ambienceVolume', ambienceVolume.value);
}

function updateAmbienceVolume() {
    if (ambienceGain) {
        ambienceGain.gain.value = parseFloat(ambienceVolume.value) / 100;
    }
    saveSetting('ambienceVolume', ambienceVolume.value);
}

ambienceType.onchange = updateAmbience;
ambienceVolume.oninput = updateAmbienceVolume;

// Pause audio when tab becomes inactive
document.addEventListener('visibilitychange', () => {
    if (document.hidden) {
        if (ambienceGain) ambienceGain.gain.value = 0;
    } else {
        if (ambienceGain) {
            ambienceGain.gain.value = parseFloat(ambienceVolume.value) / 100;
        }
    }
});

// Search engine configuration
const searchEngines = {
    google: { url: 'https://www.google.com/search', param: 'q', placeholder: 'Search...' },
    duckduckgo: { url: 'https://duckduckgo.com/', param: 'q', placeholder: 'Search...' },
    bing: { url: 'https://www.bing.com/search', param: 'q', placeholder: 'Search...' },
    brave: { url: 'https://search.brave.com/search', param: 'q', placeholder: 'Search...' },
    yandex: { url: 'https://yandex.com/search/', param: 'text', placeholder: 'Search...' },
    startpage: { url: 'https://www.startpage.com/do/search', param: 'query', placeholder: 'Search...' }
};

function updateSearchEngine(engineKey) {
    const engine = searchEngines[engineKey] || searchEngines.google;
    searchForm.action = engine.url;
    searchInput.name = engine.param;
    searchInput.placeholder = engine.placeholder;
}

// Default search engine setting - saves to localStorage
searchEngine.onchange = () => {
    saveSetting('searchEngine', searchEngine.value);
    currentSearchEngine.value = searchEngine.value;
    updateSearchEngine(searchEngine.value);
};

// Current search engine selector - session only, doesn't save
currentSearchEngine.onchange = () => {
    updateSearchEngine(currentSearchEngine.value);
};

// Color picker handlers
function updateColors() {
    const isDark = document.body.dataset.theme === 'dark';
    const root = document.documentElement;
    
    if (isDark) {
        root.style.setProperty('--bg', colorDarkBg.value);
        root.style.setProperty('--fg', colorDarkFg.value);
        root.style.setProperty('--accent', colorDarkAccent.value);
        root.style.setProperty('--dim', colorDarkDim.value);
    } else {
        root.style.setProperty('--bg', colorLightBg.value);
        root.style.setProperty('--fg', colorLightFg.value);
        root.style.setProperty('--accent', colorLightAccent.value);
        root.style.setProperty('--dim', colorLightDim.value);
    }
    
    // Save all colors
    saveSetting('colorDarkBg', colorDarkBg.value);
    saveSetting('colorDarkFg', colorDarkFg.value);
    saveSetting('colorDarkAccent', colorDarkAccent.value);
    saveSetting('colorDarkDim', colorDarkDim.value);
    saveSetting('colorLightBg', colorLightBg.value);
    saveSetting('colorLightFg', colorLightFg.value);
    saveSetting('colorLightAccent', colorLightAccent.value);
    saveSetting('colorLightDim', colorLightDim.value);
}

// Sync color picker with text input
function syncColorInputs(colorPicker, textInput) {
    colorPicker.oninput = () => {
        textInput.value = colorPicker.value;
        updateColors();
    };
    
    textInput.oninput = () => {
        const value = textInput.value.trim();
        if (/^#[0-9A-Fa-f]{6}$/.test(value)) {
            colorPicker.value = value;
            updateColors();
        }
    };
}

syncColorInputs(colorDarkBg, colorDarkBgText);
syncColorInputs(colorDarkFg, colorDarkFgText);
syncColorInputs(colorDarkAccent, colorDarkAccentText);
syncColorInputs(colorDarkDim, colorDarkDimText);
syncColorInputs(colorLightBg, colorLightBgText);
syncColorInputs(colorLightFg, colorLightFgText);
syncColorInputs(colorLightAccent, colorLightAccentText);
syncColorInputs(colorLightDim, colorLightDimText);

// Reset colors to default
resetColorsBtn.onclick = () => {
    colorDarkBg.value = '#070707';
    colorDarkBgText.value = '#070707';
    colorDarkFg.value = '#cfcfcf';
    colorDarkFgText.value = '#cfcfcf';
    colorDarkAccent.value = '#7a7a7a';
    colorDarkAccentText.value = '#7a7a7a';
    colorDarkDim.value = '#444444';
    colorDarkDimText.value = '#444444';
    colorLightBg.value = '#f5f5f5';
    colorLightBgText.value = '#f5f5f5';
    colorLightFg.value = '#111111';
    colorLightFgText.value = '#111111';
    colorLightAccent.value = '#666666';
    colorLightAccentText.value = '#666666';
    colorLightDim.value = '#bbbbbb';
    colorLightDimText.value = '#bbbbbb';
    updateColors();
};

// Notes collapse/expand
notesHeader.onclick = () => {
    notesHeader.classList.toggle('collapsed');
    notesContent.classList.toggle('collapsed');
    saveSetting('notesCollapsed', notesHeader.classList.contains('collapsed'));
};

// Notes auto-save
notesTextarea.oninput = () => {
    saveSetting('notesContent', notesTextarea.value);
    // Auto-grow textarea
    notesTextarea.style.height = 'auto';
    notesTextarea.style.height = Math.max(80, notesTextarea.scrollHeight) + 'px';
};
const defaultLinks = [
    { name: 'YouTube', url: 'https://youtube.com', category: 'Media' },
    { name: 'Reddit', url: 'https://reddit.com', category: 'Media' },
    { name: 'Google News', url: 'https://news.google.com', category: 'News' },
    { name: 'Emulation Wiki', url: 'https://emulation.gametechwiki.com', category: 'Gaming' },
    { name: 'Retro Achievements', url: 'https://retroachievements.org', category: 'Gaming' }
];

let links = loadSetting('links', defaultLinks);

function renderLinksDisplay() {
    linksMenu.innerHTML = '';
    const perRow = parseInt(linksPerRowInput.value) || 5;
    
    // Group links by category
    const categorized = {};
    const uncategorized = [];
    
    links.forEach(link => {
        const cat = (link.category || '').trim();
        if (cat) {
            if (!categorized[cat]) categorized[cat] = [];
            categorized[cat].push(link);
        } else {
            uncategorized.push(link);
        }
    });
    
    const hasCategories = Object.keys(categorized).length > 0;
    
    // Render categorized links
    Object.keys(categorized).sort().forEach(category => {
        const categoryDiv = document.createElement('div');
        categoryDiv.className = 'link-category';
        
        const header = document.createElement('div');
        header.className = 'category-header';
        const isCollapsed = loadSetting(`category_${category}_collapsed`, false);
        if (isCollapsed) header.classList.add('collapsed');
        
        const arrow = document.createElement('span');
        arrow.className = 'category-arrow';
        arrow.textContent = '‚ñº';
        
        const title = document.createElement('span');
        title.className = 'category-title';
        title.textContent = category;
        
        header.appendChild(arrow);
        header.appendChild(title);
        
        const linksContainer = document.createElement('div');
        linksContainer.className = 'category-links';
        linksContainer.style.gridTemplateColumns = `repeat(${perRow}, 1fr)`;
        if (isCollapsed) linksContainer.classList.add('collapsed');
        
        categorized[category].forEach(link => {
            const a = document.createElement('a');
            a.href = link.url;
            a.textContent = link.name;
            a.target = '_blank';
            linksContainer.appendChild(a);
        });
        
        header.onclick = () => {
            header.classList.toggle('collapsed');
            linksContainer.classList.toggle('collapsed');
            saveSetting(`category_${category}_collapsed`, header.classList.contains('collapsed'));
        };
        
        categoryDiv.appendChild(header);
        categoryDiv.appendChild(linksContainer);
        linksMenu.appendChild(categoryDiv);
    });
    
    // Render uncategorized links
    if (uncategorized.length > 0) {
        const categoryDiv = document.createElement('div');
        categoryDiv.className = 'link-category';
        
        // Only show header if there are also categorized links
        if (hasCategories) {
            const header = document.createElement('div');
            header.className = 'category-header';
            const isCollapsed = loadSetting('category_Uncategorized_collapsed', false);
            if (isCollapsed) header.classList.add('collapsed');
            
            const arrow = document.createElement('span');
            arrow.className = 'category-arrow';
            arrow.textContent = '‚ñº';
            
            const title = document.createElement('span');
            title.className = 'category-title';
            title.textContent = 'Uncategorized';
            
            header.appendChild(arrow);
            header.appendChild(title);
            
            const linksContainer = document.createElement('div');
            linksContainer.className = 'category-links';
            linksContainer.style.gridTemplateColumns = `repeat(${perRow}, 1fr)`;
            if (isCollapsed) linksContainer.classList.add('collapsed');
            
            uncategorized.forEach(link => {
                const a = document.createElement('a');
                a.href = link.url;
                a.textContent = link.name;
                a.target = '_blank';
                linksContainer.appendChild(a);
            });
            
            header.onclick = () => {
                header.classList.toggle('collapsed');
                linksContainer.classList.toggle('collapsed');
                saveSetting('category_Uncategorized_collapsed', header.classList.contains('collapsed'));
            };
            
            categoryDiv.appendChild(header);
            categoryDiv.appendChild(linksContainer);
        } else {
            // No categories at all - just show flat grid like original
            const linksContainer = document.createElement('div');
            linksContainer.className = 'category-links';
            linksContainer.style.gridTemplateColumns = `repeat(${perRow}, 1fr)`;
            
            uncategorized.forEach(link => {
                const a = document.createElement('a');
                a.href = link.url;
                a.textContent = link.name;
                a.target = '_blank';
                linksContainer.appendChild(a);
            });
            
            categoryDiv.appendChild(linksContainer);
        }
        
        linksMenu.appendChild(categoryDiv);
    }
}

function renderLinksEditor() {
    // Render link editor in settings
    linksList.innerHTML = '';
    links.forEach((link, i) => {
        const row = document.createElement('div');
        row.className = 'link-editor-row';
        
        const fields = document.createElement('div');
        fields.className = 'link-editor-fields';
        
        const nameInput = document.createElement('input');
        nameInput.type = 'text';
        nameInput.value = link.name;
        nameInput.placeholder = 'Link Name';
        
        const urlInput = document.createElement('input');
        urlInput.type = 'text';
        urlInput.value = link.url;
        urlInput.placeholder = 'URL';
        
        const deleteBtn = document.createElement('button');
        deleteBtn.textContent = 'X';
        deleteBtn.onclick = () => {
            links.splice(i, 1);
            saveAndRenderLinks();
        };
        
        const categoryInput = document.createElement('input');
        categoryInput.type = 'text';
        categoryInput.className = 'category-input';
        categoryInput.value = link.category || '';
        categoryInput.placeholder = 'Category (optional)';
        
        nameInput.oninput = () => {
            link.name = nameInput.value;
            saveSetting('links', links);
            renderLinksDisplay(); // Only re-render display, not editor
        };
        
        urlInput.oninput = () => {
            link.url = urlInput.value;
            saveSetting('links', links);
            renderLinksDisplay(); // Only re-render display, not editor
        };
        
        categoryInput.oninput = () => {
            link.category = categoryInput.value;
            saveSetting('links', links);
            renderLinksDisplay(); // Only re-render display, not editor
        };
        
        fields.append(nameInput, urlInput, deleteBtn);
        row.append(fields, categoryInput);
        linksList.appendChild(row);
    });
}

function renderLinks() {
    renderLinksDisplay();
    renderLinksEditor();
}

function saveAndRenderLinks() {
    saveSetting('links', links);
    renderLinks();
}

addLinkBtn.onclick = () => {
    links.push({ name: 'New Link', url: 'https://', category: '' });
    saveAndRenderLinks();
};

linksPerRowInput.oninput = () => {
    saveSetting('linksPerRow', parseInt(linksPerRowInput.value));
    renderLinksDisplay();
};

function applySettings() {
    const deviceName = deviceNameInput.value || 'Game Console';
    const pageTitle = pageTitleInput.value || 'System Home';
    const statusMsg = statusMessageText.value || 'Ready';
    const bgUrl = bgImageUrl.value.trim();

    headerTitle.textContent = `${pageTitle} :: ${deviceName}`;
    statusMessage.textContent = statusMsg;
    pagetitle.textContent = pageTitle;

    document.querySelector('.stats').style.display = showStats.checked ? 'grid' : 'none';
    document.querySelector('.search-bar').style.display = showSearch.checked ? 'flex' : 'none';
    linksMenu.style.display = showLinks.checked ? 'flex' : 'none';
    
    // Handle notes column visibility
    const notesColumn = document.querySelector('.notes-column');
    if (notesColumn) {
        notesColumn.style.display = showNotes.checked ? 'block' : 'none';
    }

    Object.entries(statToggles).forEach(([k, el]) => {
        const statElement = document.querySelector(`[data-stat="${k}"]`);
        if (statElement) {
            statElement.style.display = el.checked ? 'block' : 'none';
        }
    });
    
    linksMenu.classList.toggle('bordered', toggleLinkBorders.checked);
    document.body.dataset.theme = themeToggle.checked ? 'light' : 'dark';
    document.body.dataset.transparentFields = toggleTransparentFields.checked ? 'true' : 'false';
    mainContainer.style.backgroundImage = bgUrl ? `url('${bgUrl}')` : '';

    // Update colors when theme changes
    updateColors();

    // Save all settings
    saveSetting('deviceName', deviceName);
    saveSetting('pageTitle', pageTitle);
    saveSetting('statusMessage', statusMsg);
    saveSetting('weatherApiKey', weatherApiKey.value);
    saveSetting('weatherLocation', weatherLocation.value);
    saveSetting('theme', document.body.dataset.theme);
    saveSetting('toggleLinkBorders', toggleLinkBorders.checked);
    saveSetting('toggleTransparentFields', toggleTransparentFields.checked);
    saveSetting('showStartScreen', showStartScreen.checked);
    saveSetting('bgImageUrl', bgUrl);
    saveSetting('linksPerRow', parseInt(linksPerRowInput.value));
    saveSetting('showStats', showStats.checked);
    saveSetting('showSearch', showSearch.checked);
    saveSetting('showLinks', showLinks.checked);
    saveSetting('showNotes', showNotes.checked);
    
    Object.entries(statToggles).forEach(([k, el]) => {
        saveSetting(`stat_${k}`, el.checked);
    });
    
    // Save refresh intervals
    saveSetting('refreshClock', parseInt(refreshClock.value));
    saveSetting('refreshBattery', parseInt(refreshBattery.value));
    saveSetting('refreshNetwork', parseInt(refreshNetwork.value));
    saveSetting('refreshIP', parseInt(refreshIP.value));
    saveSetting('refreshDownlink', parseInt(refreshDownlink.value));
    saveSetting('refreshPing', parseInt(refreshPing.value));
    saveSetting('refreshWeather', parseInt(refreshWeather.value));
}

function loadSettings() {
    deviceNameInput.value = loadSetting('deviceName', '');
	pageTitleInput.value = loadSetting('pageTitle', '');
	statusMessageText.value = loadSetting('statusMessage', '');
    weatherApiKey.value = loadSetting('weatherApiKey', '');
    weatherLocation.value = loadSetting('weatherLocation', '');
    bgImageUrl.value = loadSetting('bgImageUrl', '');
    linksPerRowInput.value = loadSetting('linksPerRow', 2);
    showStats.checked = loadSetting('showStats', true);
    showSearch.checked = loadSetting('showSearch', true);
    showLinks.checked = loadSetting('showLinks', true);
    showNotes.checked = loadSetting('showNotes', true);
    themeToggle.checked = loadSetting('theme', 'dark') === 'light';
    toggleLinkBorders.checked = loadSetting('toggleLinkBorders', false);
    toggleTransparentFields.checked = loadSetting('toggleTransparentFields', false);
    showStartScreen.checked = loadSetting('showStartScreen', true);
    
    // Load font style
    fontStyle.value = loadSetting('fontStyle', 'standard');
    document.body.dataset.font = fontStyle.value;
    
    // Load active effects
    activeEffects = loadSetting('activeEffects', []);
    applyEffects();
    renderActiveEffects();
    
    // Load effect intensity
    effectIntensity.value = loadSetting('effectIntensity', 100);
    applyEffectIntensity();
    
    // Load audio settings
    ambienceType.value = loadSetting('ambienceType', 'none');
    ambienceVolume.value = loadSetting('ambienceVolume', 30);
    
    // Load notes
    notesTextarea.value = loadSetting('notesContent', '');
    const notesCollapsed = loadSetting('notesCollapsed', false);
    if (notesCollapsed) {
        notesHeader.classList.add('collapsed');
        notesContent.classList.add('collapsed');
    }
    
    // Set initial height for textarea based on content
    if (notesTextarea.value) {
        notesTextarea.style.height = 'auto';
        notesTextarea.style.height = Math.max(80, notesTextarea.scrollHeight) + 'px';
    }
    
    // Load search engine
    searchEngine.value = loadSetting('searchEngine', 'google');
    
    // Load colors
    colorDarkBg.value = loadSetting('colorDarkBg', '#070707');
    colorDarkBgText.value = colorDarkBg.value;
    colorDarkFg.value = loadSetting('colorDarkFg', '#cfcfcf');
    colorDarkFgText.value = colorDarkFg.value;
    colorDarkAccent.value = loadSetting('colorDarkAccent', '#7a7a7a');
    colorDarkAccentText.value = colorDarkAccent.value;
    colorDarkDim.value = loadSetting('colorDarkDim', '#444444');
    colorDarkDimText.value = colorDarkDim.value;
    colorLightBg.value = loadSetting('colorLightBg', '#f5f5f5');
    colorLightBgText.value = colorLightBg.value;
    colorLightFg.value = loadSetting('colorLightFg', '#111111');
    colorLightFgText.value = colorLightFg.value;
    colorLightAccent.value = loadSetting('colorLightAccent', '#666666');
    colorLightAccentText.value = colorLightAccent.value;
    colorLightDim.value = loadSetting('colorLightDim', '#bbbbbb');
    colorLightDimText.value = colorLightDim.value;
    
    // Load refresh intervals
    refreshClock.value = loadSetting('refreshClock', 1);
    refreshBattery.value = loadSetting('refreshBattery', 60);
    refreshNetwork.value = loadSetting('refreshNetwork', 3);
    refreshIP.value = loadSetting('refreshIP', 300);
    refreshDownlink.value = loadSetting('refreshDownlink', 3);
    refreshPing.value = loadSetting('refreshPing', 30);
    refreshWeather.value = loadSetting('refreshWeather', 600);
    
    Object.entries(statToggles).forEach(([k, el]) => {
        const defaultValue = (k === 'weather') ? false : true;
        el.checked = loadSetting(`stat_${k}`, defaultValue);
    });
}

// Attach event listeners
[deviceNameInput, pageTitleInput, statusMessageText, weatherApiKey, weatherLocation, 
 bgImageUrl, linksPerRowInput, showStats, showSearch, showLinks, showNotes, themeToggle, 
 toggleLinkBorders, toggleTransparentFields, showStartScreen, ...Object.values(statToggles),
 refreshClock, refreshBattery, refreshNetwork, refreshIP, refreshDownlink, refreshPing, refreshWeather].forEach(el => {
    el.oninput = applySettings;
    if (el.type === 'checkbox') {
        el.onchange = applySettings;
    }
});

// Reset button handler (with shift+click bypass for sandbox)
if (resetSettingsBtn) {
    resetSettingsBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        
        // Shift+click bypasses confirmation (for sandbox/testing)
        if (e.shiftKey) {
            localStorage.clear();
            window.location.replace(window.location.href.split('?')[0]);
            return;
        }
        
        // Normal confirmation
        const confirmReset = confirm('‚ö†Ô∏è This will reset ALL settings to default and reload the page. Continue?');
        if (confirmReset) {
            try {
                localStorage.clear();
                window.location.replace(window.location.href.split('?')[0]);
            } catch (err) {
                alert('Failed to reset settings. Please try again.');
            }
        }
    });
}

// Initialize
loadSettings();
renderLinks();
applySettings();
renderThemes();

// Set current search engine to default on load
currentSearchEngine.value = searchEngine.value;
updateSearchEngine(searchEngine.value);

// Start Screen Handler
const startScreen = document.getElementById('startScreen');

function enterSystem() {
    // Start ambience if configured
    if (ambienceType.value && ambienceType.value !== 'none') {
        startAmbience(ambienceType.value);
    }
    
    // Hide start screen
    startScreen.classList.add('hidden');
}

// Listen for any interaction on start screen
startScreen.addEventListener('click', enterSystem);
startScreen.addEventListener('keydown', (e) => {
    if (e.key !== 'Tab') {
        enterSystem();
    }
});
startScreen.addEventListener('touchstart', enterSystem);

// Check if start screen should be shown based on setting
if (!showStartScreen.checked) {
    startScreen.classList.add('hidden');
    // Still start ambience if configured
    if (ambienceType.value && ambienceType.value !== 'none') {
        setTimeout(() => {
            startAmbience(ambienceType.value);
        }, 300);
    }
}

// Start status updates
updateClock();
updateBattery();
updateNetwork();
updateDownlink();
updateIP();
updatePing();
updateWeather();

// Setup intervals with configurable refresh rates
let intervals = {};

function setupIntervals() {
    // Clear existing intervals
    Object.values(intervals).forEach(id => clearInterval(id));
    
    // Setup new intervals with current settings
    intervals.clock = setInterval(updateClock, parseInt(refreshClock.value) * 1000);
    intervals.battery = setInterval(updateBattery, parseInt(refreshBattery.value) * 1000);
    intervals.network = setInterval(updateNetwork, parseInt(refreshNetwork.value) * 1000);
    intervals.ip = setInterval(updateIP, parseInt(refreshIP.value) * 1000);
    intervals.downlink = setInterval(updateDownlink, parseInt(refreshDownlink.value) * 1000);
    intervals.ping = setInterval(updatePing, parseInt(refreshPing.value) * 1000);
    intervals.weather = setInterval(updateWeather, parseInt(refreshWeather.value) * 1000);
}

// Add listeners to refresh interval inputs to restart intervals when changed
[refreshClock, refreshBattery, refreshNetwork, refreshIP, refreshDownlink, refreshPing, refreshWeather].forEach(el => {
    el.addEventListener('change', setupIntervals);
});

setupIntervals();
</script>
</body>
</html>
